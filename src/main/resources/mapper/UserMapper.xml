<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.example.thymeleaf.user.mapper.UserMapper">

    <!-- 목록 조회 -->
    <select id="search" parameterType="map" resultType="com.example.thymeleaf.user.dto.UserDto">
        select
        id,
        username,
        email,
        first_name,
        last_name,
        birth_date,
        phone,
        created_at
        from users
        <where>
            <if test="q != null and q != ''">
                <choose>
                    <when test="by == 'username'">
                        lower(username) like concat('%', lower(#{q}), '%')
                    </when>
                    <when test="by == 'email'">
                        lower(email) like concat('%', lower(#{q}), '%')
                    </when>
                    <when test="by == 'firstName'">
                        lower(first_name) like concat('%', lower(#{q}), '%')
                    </when>
                    <when test="by == 'lastName'">
                        lower(last_name) like concat('%', lower(#{q}), '%')
                    </when>
                    <when test="by == 'phone'">
                        lower(phone) like concat('%', lower(#{q}), '%')
                    </when>
                    <otherwise>
                        (
                        lower(username)    like concat('%', lower(#{q}), '%')
                        or lower(email)    like concat('%', lower(#{q}), '%')
                        or lower(first_name) like concat('%', lower(#{q}), '%')
                        or lower(last_name)  like concat('%', lower(#{q}), '%')
                        or lower(phone)    like concat('%', lower(#{q}), '%')
                        )
                    </otherwise>
                </choose>
            </if>
        </where>
        order by
        <choose>
            <when test="sort == 'username'"> username </when>
            <when test="sort == 'email'"> email </when>
            <when test="sort == 'firstName'"> first_name </when>
            <when test="sort == 'lastName'"> last_name </when>
            <when test="sort == 'createdAt'"> created_at </when>
            <otherwise> id </otherwise>
        </choose>
        <choose>
            <when test="dir != null and (dir.toLowerCase() == 'asc' or dir.toLowerCase() == 'desc')">
                ${dir}
            </when>
            <otherwise> desc </otherwise>
        </choose>
        limit #{limit} offset #{offset}
    </select>

    <!-- 카운트 -->
    <select id="count" parameterType="map" resultType="long">
        select count(1)
        from users
        <where>
            <if test="q != null and q != ''">
                <choose>
                    <when test="by == 'username'">
                        lower(username) like concat('%', lower(#{q}), '%')
                    </when>
                    <when test="by == 'email'">
                        lower(email) like concat('%', lower(#{q}), '%')
                    </when>
                    <when test="by == 'firstName'">
                        lower(first_name) like concat('%', lower(#{q}), '%')
                    </when>
                    <when test="by == 'lastName'">
                        lower(last_name) like concat('%', lower(#{q}), '%')
                    </when>
                    <when test="by == 'phone'">
                        lower(phone) like concat('%', lower(#{q}), '%')
                    </when>
                    <otherwise>
                        (
                        lower(username)    like concat('%', lower(#{q}), '%')
                        or lower(email)    like concat('%', lower(#{q}), '%')
                        or lower(first_name) like concat('%', lower(#{q}), '%')
                        or lower(last_name)  like concat('%', lower(#{q}), '%')
                        or lower(phone)    like concat('%', lower(#{q}), '%')
                        )
                    </otherwise>
                </choose>
            </if>
        </where>
    </select>

    <!-- 단건 -->
    <select id="findById" parameterType="long" resultType="com.example.thymeleaf.user.dto.UserDto">
        select
            id,
            username,
            email,
            first_name,
            last_name,
            birth_date,
            phone,
            created_at
        from users
        where id = #{id}
    </select>

    <!-- insert -->
    <insert id="insert" parameterType="com.example.thymeleaf.user.dto.UserDto"
            useGeneratedKeys="true" keyProperty="id">
        insert into users (
            username,password, email, first_name, last_name, birth_date, phone, created_at
        ) values (
                     #{username},  #{password}, #{email}, #{firstName}, #{lastName}, #{birthDate}, #{phone}, now()
                 )
    </insert>

    <!-- update -->
    <update id="update" parameterType="com.example.thymeleaf.user.dto.UserDto">
        update users
        <set>
            <if test="username  != null"> username   = #{username}, </if>
            <if test="email     != null"> email      = #{email}, </if>
            <if test="firstName != null"> first_name = #{firstName}, </if>
            <if test="lastName  != null"> last_name  = #{lastName}, </if>
            <if test="birthDate != null"> birth_date = #{birthDate}, </if>
            <if test="phone     != null"> phone      = #{phone} </if>
        </set>
        where id = #{id}
    </update>

    <!-- delete -->
    <delete id="delete" parameterType="long">
        delete from users where id = #{id}
    </delete>

</mapper>

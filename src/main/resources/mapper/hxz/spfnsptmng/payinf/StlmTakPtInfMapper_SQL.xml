<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="tmoney.co.kr.hxz.spfnsprtmng.payinf.mapper.StlmTakPtInfMapper">

    <!-- ============================================================= -->
    <!-- 1. 검색용 리스트 조회 (PERD) -->
    <!-- ============================================================= -->
    <select id="readPerdStlmList" parameterType="tmoney.co.kr.hxz.spfnsprtmng.payinf.vo.StlmTakPtInfReqVO" resultType="tmoney.co.kr.hxz.spfnsprtmng.payinf.vo.StlmTakPtInfRspVO">
        select
            perd.tpw_svc_typ_id as tpwSvcTypId,
            perd.tpw_svc_id as tpwSvcId,
            perd.org_nm as orgNm,
            perd.apl_stt_dt as aplSttDt,
            perd.apl_end_dt as aplEndDt,
            perd.tpw_trd_stt_dt as tpwTrdSttDt,
            perd.tpw_trd_end_dt as tpwTrdEndDt,
            perd.fix_dt as fixDt,
            perd.stlm_dt as stlmDt,
            perd.clos_cfm_yn as closCfmYn,
            perd.stlm_fix_yn as stlmFixYn,
            perd.acng_prcg_fn_yn as acngPrcgFnYn,
            perd.tpw_svc_nm as tpwSvcNm,
            perd.tpw_svc_typ_nm as tpwSvcTypNm,
            perd.tpw_svc_typ_sno as tpwSvcTypSno,
            perd.stlm_clos_amt as stlmClosAmt,
            perd.org_cd as orgCd
        from (
            select
            'PERD' as exeDiv,
            d215.tpw_svc_typ_id,  <!-- [수정] m202 -> d215 (기준 테이블에서 직접 조회) -->
            d215.tpw_svc_id,      <!-- [수정] m201 -> d215 (기준 테이블에서 직접 조회) -->
            d215.tpw_svc_typ_sno,
            m201.tpw_svc_nm,
            m202.tpw_svc_typ_nm,
            d215.apl_stt_dt,
            d215.apl_end_dt,
            d215.tpw_trd_stt_dt,
            d215.tpw_trd_end_dt,
            d215.stlm_dt,
            d215.fix_dt,
            d215.clos_cfm_yn,
            d215.stlm_fix_yn,
            d215.acng_prcg_fn_yn,
            d215.stlm_clos_amt,
            (select m009.tpw_org_nm
            FROM tbhxzm009 m009
            where m009.org_cd = m201.org_cd
            and m009.use_yn = 'Y'
            limit 1) as org_nm,
            m201.org_cd
        from tbhxzd215 d215
        left join tbhxzd214 d214
        on d214.tpw_svc_id = d215.tpw_svc_id
        and d214.tpw_svc_typ_id = d215.tpw_svc_typ_id
        and d214.tpw_svc_typ_sno = d215.tpw_svc_typ_sno
        and d214.stlm_dt = d215.stlm_dt
        left join tbhxzm201 m201 on m201.tpw_svc_id = d215.tpw_svc_id and m201.use_yn = 'Y'
        left join tbhxzm202 m202 on m202.tpw_svc_id = d215.tpw_svc_id and m201.use_yn = 'Y'
        and m202.tpw_svc_typ_id = d215.tpw_svc_typ_id
        and m202.tpw_svc_typ_sno = d215.tpw_svc_typ_sno
        where 1=1
        <if test="req.exeDiv != null and req.exeDiv != ''">
            and 'PERD' = #{req.exeDiv}
        </if>

        <!-- 지자체 관리자인 경우 -->
        <if test="orgCd != null and orgCd != '' and orgCd != '0000000'">
            and m201.org_cd = #{orgCd}
        </if>

        <!-- 지자체 관리자인경우 -->
        <if test="orgCd != '0000000'">
            and m201.org_cd = #{orgCd}
        </if>

        <choose>
            <when test="req.searchType == 'stlmDt' and req.sttDt != null and req.endDt != null">
                and d215.stlm_dt between #{req.sttDt} and #{req.endDt}
            </when>
            <when test="req.searchType == 'fixDt' and req.sttDt != null and req.endDt != null">
                and d215.fix_dt between #{req.sttDt} and #{req.endDt}
            </when>
            <when test="req.searchType == 'aplDt' and req.sttDt != null and req.endDt != null">
                and d215.apl_stt_dt between #{req.sttDt} and #{req.endDt}
                and d215.apl_end_dt between #{req.sttDt} and #{req.endDt}
            </when>
        </choose>

        <if test="req.tpwSvcId != null and req.tpwSvcId != ''">
            and m201.tpw_svc_id = #{req.tpwSvcId}
            <choose>
                <when test="req.tpwSvcTypId != null and req.tpwSvcTypId != ''">
                    and m202.tpw_svc_typ_id = #{req.tpwSvcTypId}
                </when>
                <when test="req.tpwSvcTypId == null or req.tpwSvcTypId == ''">
                    and m201.tpw_svc_id = m202.tpw_svc_id
                </when>
            </choose>
        </if>
        ) perd
        order by perd.${req.sort} ${req.dir}
        limit #{req.size} offset #{req.page} * #{req.size}
    </select>

    <!-- PERD Count -->
    <select id="readPerdStlmListCnt" parameterType="tmoney.co.kr.hxz.spfnsprtmng.payinf.vo.StlmTakPtInfReqVO" resultType="long">
        select count(1)
        from tbhxzd215 d215
        left join tbhxzm201 m201 on m201.tpw_svc_id = d215.tpw_svc_id and m201.use_yn = 'Y'
        left join tbhxzm202 m202 on m202.tpw_svc_id = d215.tpw_svc_id
        and m202.tpw_svc_typ_id = d215.tpw_svc_typ_id
        and m202.tpw_svc_typ_sno = d215.tpw_svc_typ_sno
        where 1=1
        <if test="req.exeDiv != null and req.exeDiv != ''">
            and 'PERD' = #{req.exeDiv}
        </if>
        <choose>
            <when test="req.searchType == 'stlmDt' and req.sttDt != null and req.endDt != null">
                and d215.stlm_dt between #{req.sttDt} and #{req.endDt}
            </when>
            <when test="req.searchType == 'fixDt' and req.sttDt != null and req.endDt != null">
                and d215.fix_dt between #{req.sttDt} and #{req.endDt}
            </when>
            <when test="req.searchType == 'aplDt' and req.sttDt != null and req.endDt != null">
                and d215.apl_stt_dt between #{req.sttDt} and #{req.endDt}
                and d215.apl_end_dt between #{req.sttDt} and #{req.endDt}
            </when>
        </choose>
        <if test="req.tpwSvcId != null and req.tpwSvcId != ''">
            and m201.tpw_svc_id = #{req.tpwSvcId}
            <choose>
                <when test="req.tpwSvcTypId != null and req.tpwSvcTypId != ''">
                    and m202.tpw_svc_typ_id = #{req.tpwSvcTypId}
                </when>
                <when test="req.tpwSvcTypId == null or req.tpwSvcTypId == ''">
                    and m201.tpw_svc_id = m202.tpw_svc_id
                </when>
            </choose>
        </if>
    </select>

    <!-- ============================================================= -->
    <!-- [수정] 정기(PERD) 데이터 등록 (INSERT) -->
    <!-- ============================================================= -->
    <insert id="savePerdStlmTakPt" parameterType="tmoney.co.kr.hxz.spfnsprtmng.payinf.vo.StlmTakPtInfRspVO">
        INSERT INTO tbhxzd215 (
        tpw_svc_typ_id,
        tpw_svc_typ_sno,
        stlm_dt,
        tpw_svc_id,
        apl_stt_dt,
        apl_end_dt,
        tpw_trd_stt_dt,
        tpw_trd_end_dt,
        fix_dt,              <!-- 추가: 확정일자 -->
        stlm_clos_amt,       <!-- 추가: 정산마감금액 -->
        clos_cfm_yn,         <!-- 추가: 마감확인여부 -->
        stlm_fix_yn,         <!-- 추가: 정산확정여부 -->
        acng_prcg_fn_yn,     <!-- 추가: 회계처리완료여부 -->
        rgsr_id,
        rgt_dtm
        ) VALUES (
        #{tpwSvcTypId},
        #{tpwSvcTypSno},
        #{stlmDt},           <!-- 수정: 입력받은 정산일자 -->
        #{tpwSvcId},
        #{aplSttDt},
        #{aplEndDt},
        #{tpwTrdSttDt},
        #{tpwTrdEndDt},
        #{fixDt},
        #{stlmClosAmt},
        #{closCfmYn},
        #{stlmFixYn},
        #{acngPrcgFnYn},
        'system',            <!-- 등록자 (세션값으로 대체 가능) -->
        to_char(now(), 'YYYYMMDDHH24MISS')
        )
    </insert>

    <!-- ============================================================= -->
    <!-- [수정] 정기(PERD) 데이터 수정 (UPDATE) -->
    <!-- ============================================================= -->
    <update id="updatePerdStlmTakPtByService" parameterType="tmoney.co.kr.hxz.spfnsprtmng.payinf.vo.StlmTakPtInfRspVO">
        update tbhxzd215
            <set>
                <if test="aplSttDt != null and aplSttDt != ''">
                    apl_stt_dt = #{aplSttDt},
                </if>
                <if test="aplEndDt != null and aplEndDt != ''">
                    apl_end_dt = #{aplEndDt},
                </if>
                <if test="tpwTrdSttDt != null and tpwTrdSttDt != ''">
                    tpw_trd_stt_dt = #{tpwTrdSttDt},
                </if>
                <if test="tpwTrdEndDt != null and tpwTrdEndDt != ''">
                    tpw_trd_end_dt = #{tpwTrdEndDt},
                </if>

                <if test="stlmDt != null and stlmDt != ''">
                    stlm_dt = #{stlmDt},
                </if>

                <if test="fixDt != null and fixDt != ''">
                    fix_dt = #{fixDt},
                </if>

                <if test="stlmClosAmt != null">
                    stlm_clos_amt = #{stlmClosAmt},
                </if>

                <if test="closCfmYn != null and closCfmYn != ''">
                    clos_cfm_yn = #{closCfmYn},
                </if>
                <if test="stlmFixYn != null and stlmFixYn != ''">
                    stlm_fix_yn = #{stlmFixYn},
                </if>
                <if test="acngPrcgFnYn != null and acngPrcgFnYn != ''">
                    acng_prcg_fn_yn = #{acngPrcgFnYn},
                </if>

                updr_id = 'system',
                upd_dtm = to_char(now(), 'YYYYMMDDHH24MISS')
            </set>

         where tpw_svc_id      = #{origTpwSvcId}
            and tpw_svc_typ_id  = #{origTpwSvcTypId}
            and tpw_svc_typ_sno = #{origTpwSvcTypSno}
            and stlm_dt         = #{origStlmDt} <!-- PK 조건 추가 권장 (필요시) -->
    </update>

    <!-- ============================================================= -->
    <!-- 정기(PERD) 단건 조회 (상세보기) -->
    <!-- ============================================================= -->
    <select id="readPerdTakPtInf" parameterType="map" resultType="tmoney.co.kr.hxz.spfnsprtmng.payinf.vo.StlmTakPtInfRspVO">
        select
            'PERD'                   as exeDiv,
            d215.tpw_svc_typ_id      as tpwSvcTypId,
            d215.tpw_svc_typ_sno     as tpwSvcTypSno,
            d215.stlm_dt             as stlmDt,
            d215.tpw_svc_id          as tpwSvcId,
            d215.apl_stt_dt          as aplSttDt,
            d215.apl_end_dt          as aplEndDt,
            d215.tpw_trd_stt_dt      as tpwTrdSttDt,
            d215.tpw_trd_end_dt      as tpwTrdEndDt,
            d215.fix_dt              as fixDt,
            d215.stlm_clos_amt       as stlmClosAmt, <!-- 추가: 마감금액 조회 -->
            d215.clos_cfm_yn         as closCfmYn,
            d215.stlm_fix_yn         as stlmFixYn,
            d215.acng_prcg_fn_yn     as acngPrcgFnYn,
            d215.rgsr_id             as rgsrId,
            d215.rgt_dtm             as rgtDtm,
            d215.updr_id             as updrId,
            d215.upd_dtm             as updDtm,
            m201.tpw_svc_nm          as tpwSvcNm,
            m202.tpw_svc_typ_nm      as tpwSvcTypNm,
            (select m009.tpw_org_nm
                from tbhxzm009 m009
                    where m009.org_cd = m201.org_cd and m009.use_yn = 'Y' limit 1) as orgNm,
            m201.org_cd as orgCd
        from tbhxzd215 d215
            left join tbhxzm201 m201 on m201.tpw_svc_id = d215.tpw_svc_id and m201.use_yn = 'Y'
            left join tbhxzm202 m202 on m202.tpw_svc_id = d215.tpw_svc_id
            and m202.tpw_svc_typ_id = d215.tpw_svc_typ_id
            and m202.tpw_svc_typ_sno = d215.tpw_svc_typ_sno
         where d215.tpw_svc_typ_id = #{tpwSvcTypId}
            and d215.tpw_svc_typ_sno = #{tpwSvcTypSno}
            and d215.tpw_svc_id = #{tpwSvcId}
            and d215.stlm_dt = #{stlmDt}
         LIMIT 1
    </select>

    <!-- ============================================================= -->
    <!-- 시뮬레이션(SIM) 관련 쿼리 (변경 없음) -->
    <!-- ============================================================= -->
    <select id="readSimStlmList" parameterType="tmoney.co.kr.hxz.spfnsprtmng.payinf.vo.StlmTakPtInfReqVO" resultType="tmoney.co.kr.hxz.spfnsprtmng.payinf.vo.StlmTakPtInfRspVO">
        <!-- (기존 SIM 리스트 조회 쿼리 유지) -->
        select
        sim.exe_div as exeDiv,
        sim.tpw_svc_id as tpwSvcId,
        sim.tpw_svc_typ_id as tpwSvcTypId,
        sim.tpw_svc_typ_sno as tpwSvcTypSno,
        sim.tpw_svc_nm as tpwSvcNm,
        sim.tpw_svc_typ_nm as tpwSvcTypNm,
        sim.apl_dt as aplDt,
        sim.tpw_trd_stt_dt as tpwTrdSttDt,
        sim.tpw_trd_end_dt as tpwTrdEndDt,
        sim.stlm_dt as stlmDt,
        sim.fix_dt as fixDt,
        sim.clos_cfm_yn as closCfmYn,
        sim.stlm_fix_yn as stlmFixYn,
        sim.acng_prcg_fn_yn as acngPrcgFnYn,
        sim.prcg_fn_yn as prcgFnYn
        from (
        select
        'SIM' as exe_div,
        d222.tpw_svc_id,      <!-- [수정] m201 -> d222 (기준 테이블에서 직접 조회) -->
        d222.tpw_svc_typ_id,
        d222.tpw_svc_typ_sno,
        m201.tpw_svc_nm,
        m202.tpw_svc_typ_nm,
        d222.apl_dt,
        d222.tpw_trd_stt_dt,
        d222.tpw_trd_end_dt,
        d222.apl_dt as stlm_dt,
        null as fix_dt,
        d222.prcg_fn_yn as clos_cfm_yn,
        'N' as stlm_fix_yn,
        'N' as acng_prcg_fn_yn,
        d222.prcg_fn_yn
        from tbhxzd222 d222
        join tbhxzm201 m201 on m201.tpw_svc_id = d222.tpw_svc_id and m201.use_yn = 'Y'
        join tbhxzm202 m202 on m202.tpw_svc_id = d222.tpw_svc_id
        and m202.tpw_svc_typ_id = d222.tpw_svc_typ_id
        and m202.tpw_svc_typ_sno = d222.tpw_svc_typ_sno
        where 1=1
        <if test="req.exeDiv != null and req.exeDiv != ''">
            and 'SIM' = #{req.exeDiv}
        </if>
        <choose>
            <when test="req.searchType == 'stlmDt' and req.sttDt != null and req.endDt != null">
                and d222.apl_dt between #{req.sttDt} and #{req.endDt}
            </when>
            <when test="req.searchType == 'aplDt' and req.sttDt != null and req.endDt != null">
                and d222.apl_dt between #{req.sttDt} and #{req.endDt}
            </when>
        </choose>
        <if test="req.tpwSvcId != null and req.tpwSvcId != ''">
            and m201.tpw_svc_id = #{req.tpwSvcId}
            <choose>
                <when test="req.tpwSvcTypId != null and req.tpwSvcTypId != ''">
                    and m202.tpw_svc_typ_id = #{req.tpwSvcTypId}
                </when>
                <when test="req.tpwSvcTypId == null or req.tpwSvcTypId == ''">
                    and m201.tpw_svc_id = m202.tpw_svc_id
                </when>
            </choose>
        </if>
        ) sim
        order by sim.${req.sort} ${req.dir}
        limit #{req.size} offset #{req.page} * #{req.size}
    </select>

    <select id="readSimStlmListCnt" parameterType="tmoney.co.kr.hxz.spfnsprtmng.payinf.vo.StlmTakPtInfReqVO" resultType="long">
        select count(1)
        from tbhxzd222 d222
        join tbhxzm201 m201 on m201.tpw_svc_id = d222.tpw_svc_id and m201.use_yn = 'Y'
        left join tbhxzm202 m202 on m202.tpw_svc_id = d222.tpw_svc_id
        and m202.tpw_svc_typ_id = d222.tpw_svc_typ_id
        and m202.tpw_svc_typ_sno = d222.tpw_svc_typ_sno
        where 1=1
        <if test="req.exeDiv != null and req.exeDiv != ''">
            and 'SIM' = #{req.exeDiv}
        </if>
        <choose>
            <when test="req.searchType == 'stlmDt' and req.sttDt != null and req.endDt != null">
                and d222.apl_dt between #{req.sttDt} and #{req.endDt}
            </when>
            <when test="req.searchType == 'aplDt' and req.sttDt != null and req.endDt != null">
                and d222.apl_dt between #{req.sttDt} and #{req.endDt}
            </when>
        </choose>
        <if test="req.tpwSvcId != null and req.tpwSvcId != ''">
            and m201.tpw_svc_id = #{req.tpwSvcId}
            <choose>
                <when test="req.tpwSvcTypId != null and req.tpwSvcTypId != ''">
                    and m202.tpw_svc_typ_id = #{req.tpwSvcTypId}
                </when>
                <when test="req.tpwSvcTypId == null or req.tpwSvcTypId == ''">
                    and m201.tpw_svc_id = m202.tpw_svc_id
                </when>
            </choose>
        </if>
    </select>

    <select id="readSimTakPtInf" parameterType="map" resultType="tmoney.co.kr.hxz.spfnsprtmng.payinf.vo.StlmTakPtInfRspVO">
        select
        'SIM'                    as exeDiv,
        d222.tpw_svc_typ_id      as tpwSvcTypId,
        d222.tpw_svc_typ_sno     as tpwSvcTypSno,
        d222.apl_dt              as aplDt,
        d222.tpw_svc_id          as tpwSvcId,
        d222.tpw_trd_stt_dt      as tpwTrdSttDt,
        d222.tpw_trd_end_dt      as tpwTrdEndDt,
        d222.prcg_fn_yn          as prcgFnYn,
        d222.rgsr_id             as rgsrId,
        d222.rgt_dtm             as rgtDtm,
        d222.updr_id             as updrId,
        d222.upd_dtm             as updDtm,
        m201.tpw_svc_nm          as tpwSvcNm,
        m202.tpw_svc_typ_nm      as tpwSvcTypNm,
        (select m009.tpw_org_nm from tbhxzm009 m009 where m009.org_cd = m201.org_cd and m009.use_yn = 'Y' limit 1) as orgNm
        from tbhxzd222 d222
        join tbhxzm201 m201 on m201.tpw_svc_id = d222.tpw_svc_id and m201.use_yn = 'Y'
        join tbhxzm202 m202 on m202.tpw_svc_id = d222.tpw_svc_id
        and m202.tpw_svc_typ_id = d222.tpw_svc_typ_id
        and m202.tpw_svc_typ_sno = d222.tpw_svc_typ_sno
        where d222.tpw_svc_typ_id = #{tpwSvcTypId}
        and d222.tpw_svc_typ_sno = #{tpwSvcTypSno}
        and d222.tpw_svc_id = #{tpwSvcId}
    </select>

    <insert id="saveSimTakPt" parameterType="tmoney.co.kr.hxz.spfnsprtmng.payinf.vo.StlmTakPtInfRspVO">
        insert into tbhxzd222 (
        tpw_svc_typ_id,
        tpw_svc_typ_sno,
        apl_dt,
        tpw_svc_id,
        tpw_trd_stt_dt,
        tpw_trd_end_dt,
        prcg_fn_yn,
        rgsr_id,
        rgt_dtm
        ) values (
        #{tpwSvcTypId},
        #{tpwSvcTypSno},
        #{aplDt},
        #{tpwSvcId},
        #{tpwTrdSttDt},
        #{tpwTrdEndDt},
        #{prcgFnYn},
        'system',
        to_char(now(), 'YYYYMMDDHH24MISS')
        );
    </insert>

    <update id="updateSimStlmTakPtByService" parameterType="tmoney.co.kr.hxz.spfnsprtmng.payinf.vo.StlmTakPtInfRspVO">
        update tbhxzd222
        <set>
            <if test="tpwSvcId != null and tpwSvcId != ''"> tpw_svc_id = #{tpwSvcId}, </if>
            <if test="tpwSvcTypId != null and tpwSvcTypId != ''"> tpw_svc_typ_id = #{tpwSvcTypId}, </if>
            <if test="tpwSvcTypSno != null"> tpw_svc_typ_sno = #{tpwSvcTypSno}, </if>
            <if test="aplDt != null and aplDt != ''"> apl_dt = #{aplDt}, </if>

            <if test="tpwTrdSttDt != null and tpwTrdSttDt != ''"> tpw_trd_stt_dt = #{tpwTrdSttDt}, </if>
            <if test="tpwTrdEndDt != null and tpwTrdEndDt != ''"> tpw_trd_end_dt = #{tpwTrdEndDt}, </if>
            <if test="prcgFnYn != null and prcgFnYn != ''"> prcg_fn_yn = #{prcgFnYn}, </if>

            updr_id = 'system',
            upd_dtm = to_char(now(), 'YYYYMMDDHH24MISS')
        </set>
        where tpw_svc_id      = #{origTpwSvcId}
        and tpw_svc_typ_id  = #{origTpwSvcTypId}
        and tpw_svc_typ_sno = #{origTpwSvcTypSno}
        and apl_dt          = #{origAplDt}
    </update>

</mapper>
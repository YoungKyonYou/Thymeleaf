<!doctype html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org" xmlns:sec="http://www.w3.org/1999/xhtml">
<!-- 레이아웃에 이 페이지의 본문(content) 프래그먼트를 주입 -->
<th:block th:replace="~{component/commonHead :: layout(~{::content})}">
    <th:block th:fragment="content">

        <!-- 페이지 전용 CSS (예시) -->
        <link rel="stylesheet" th:href="@{/css/page/page.css}" />

        <!-- ✅ 분기 모달 읽기전용 구분용 인라인 스타일 (새로 추가) -->
        <style>
            /* 모달에 qtr-readonly 클래스가 붙으면 읽기전용 스타일 적용 */
            #modal-manager.qtr-readonly .dp-input[readonly] {
                background: #f3f4f6;
                /* 연회색 */
                color: #6b7280;
                /* 회색 텍스트 */
                border-color: #d1d5db;
                /* 옅은 회색 보더 */
                cursor: not-allowed;
            }

            #modal-manager.qtr-readonly .dp-input[readonly]::placeholder {
                color: #9ca3af;
            }

            #modal-manager.qtr-readonly .dp-btn[disabled] {
                opacity: .35;
                pointer-events: none;
                cursor: not-allowed;
            }

            #modal-manager.qtr-readonly .text-field.readonly {
                background: #f9fafb;
                border-color: #e5e7eb;
            }
        </style>

        <section class="section" id="grid">
            <form class="section-header" th:object="${req}">
                <div class="title-wrap box">
                    <h3 class="section-title">지원한도내역조회</h3>
                </div>

                <!-- 검색 조건: 기존 유지 (검색용) -->
                <div class="box-wrap">
                    <div class="box">
                        <p class="field-title">서비스 선택</p>
                        <th:block th:replace="~{common/fragment/dropdowns :: cascadingDropdown(
                'svcPair1',
                'tpwSvcId',
                'tpwSvcTypId'
              )}"></th:block>
                    </div>
                </div>

                <div class="box-wrap">
                    <div class="box">
                        <p class="field-title">서비스명</p>
                        <input type="text" class="text-field" th:field="*{tpwSvcNm}">
                    </div>

                    <div class="box">
                        <p class="field-title">사용여부</p>
                        <div class="dropdown" data-name="state">
                            <button type="button" class="dropdown_button" aria-haspopup="listbox" aria-expanded="false"
                                aria-label="사용여부 드롭다운">
                                <span class="dropdown_value" data-placeholder="Y">선택하세요</span>
                            </button>
                            <ul class="dropdown_list" role="listbox" tabindex="-1">
                                <li role="option" class="dropdown_option" data-value="Y">Y</li>
                                <li role="option" class="dropdown_option" data-value="N">N</li>
                            </ul>
                            <input type="hidden" name="state" value="" th:field="*{useYn}">
                        </div>
                    </div>

                    <div class="box">
                        <p class="field-title">한도구분</p>
                        <div class="dropdown" data-name="limit">
                            <button type="button" class="dropdown_button" aria-haspopup="listbox" aria-expanded="false"
                                aria-label="한도구분 드롭다운">
                                <span class="dropdown_value" data-placeholder="금액">선택하세요</span>
                            </button>
                            <ul class="dropdown_list" role="listbox" tabindex="-1">
                                <li role="option" class="dropdown_option" data-value="01">금액</li>
                                <li role="option" class="dropdown_option" data-value="02">건수</li>
                            </ul>
                            <input type="hidden" name="limit" value="" th:field="*{tpwLmtDvsCd}">
                        </div>
                    </div>
                </div>

                <div class="btn-wrap">
                    <!-- ✅ 신규 한도 설정 UX 변경: 모달에서 별도 선택 -->
                    <button type="button" class="btn btn-dark-line open-modal" id="new-modal" data-mode="new"
                        data-target="#modal-manager" sec:authorize="hasPermission('지원한도내역조회', 'WRITE')">
                        신규 한도 설정
                    </button>

                    <button type="button" class="btn btn-primary btn-icon-left" data-export="xlsx"
                        data-provider="지원한도내역조회">
                        <i class="icon icon-save"></i> 엑셀 다운로드
                    </button>

                    <button type="submit" class="btn btn-primary btn-icon-left"
                        sec:authorize="hasPermission('지원한도내역조회', 'READ')">
                        검색 <i class="icon icon-search"></i>
                    </button>
                </div>

                <input th:field="*{sort}" type="hidden" id="sort">
                <input th:field="*{dir}" type="hidden" id="dir">
            </form>

            <div class="section-content">
                <div class="title-wrap" id="grid-title">
                    <h3 class="section-title" th:text="${req.tpwLmtDvsCd == '01' ? '한도구분(금액)' : '한도구분(건수)'}"></h3>
                </div>

                <div class="flex justify-space-between" id="grid-header" th:object="${pageData}">
                    <b th:text="'검색 결과 : ' + *{total} + '건'"></b>
                </div>

                <div class="table-wrap mt20">
                    <table class="table">
                        <caption class="blind">지급금 신청 테이블</caption>
                        <thead id="grid-head">
                            <tr>
                                <th class="sort-header" scope="col">순번</th>
                                <th class="sort-header" scope="col"><a data-sort="tpw_svc_id">서비스 ID</a></th>
                                <th class="sort-header" scope="col"><a data-sort="tpw_svc_nm">교통비지원서비스명</a></th>
                                <th class="sort-header" scope="col"><a data-sort="tpw_svc_typ_id">서비스유형 ID</a></th>
                                <th class="sort-header" scope="col"><a data-sort="tpw_svc_typ_nm">서비스유형명</a></th>
                                <th class="sort-header" scope="col" data-sort="spfn_lmt_mng_no">지원금한도관리번호</th>
                                <th class="sort-header" scope="col"><a data-sort="lmt_stt_ym">한도시작년월</a></th>
                                <th class="sort-header" scope="col" th:if="${req.tpwLmtDvsCd == '01'}"><a
                                        data-sort="min_cndt_val">최소한도</a></th>
                                <th class="sort-header" scope="col" th:if="${req.tpwLmtDvsCd == '01'}"><a
                                        data-sort="max_cndt_val">최대한도</a></th>
                                <th class="sort-header" scope="col">사용여부</th>
                                <th class="sort-header" scope="col">한도설정</th>
                            </tr>
                        </thead>
                        <tbody id="grid-tbody">
                            <th:block th:each="u, stat : ${pageData.content}"
                                th:if="${pageData != null and pageData.total > 0}" th:object="${u}">
                                <tr th:if="${u != null}">
                                    <td th:text="${stat.count}"></td>
                                    <td th:text="*{tpwSvcId}"></td>
                                    <td th:text="*{tpwSvcNm}"></td>
                                    <td th:text="*{tpwSvcTypId}"></td>
                                    <td th:text="*{tpwSvcTypNm}"></td>
                                    <td th:text="*{spfnLmtMngNo}"></td>
                                    <td th:text="*{lmtSttYm} + ' ~ ' + *{lmtEndYm}"></td>
                                    <td th:if="${req.tpwLmtDvsCd == '01'}" th:text="*{minCndtVal}"></td>
                                    <td th:if="${req.tpwLmtDvsCd == '01'}" th:text="*{maxCndtVal}"></td>
                                    <td th:text="*{useYn}"></td>
                                    <td>
                                        <button class="btn btn-dark-line open-modal" type="button"
                                            data-target="#modal-manager" th:data-id="*{tpwSvcTypId}"
                                            th:data-dvs-code="*{tpwLmtDvsCd}" th:use-yn="*{useYn}"
                                            sec:authorize="hasPermission('지원한도내역조회', 'UPDATE')">
                                            설정하기
                                        </button>
                                    </td>
                                </tr>
                            </th:block>
                            <th:block th:unless="${pageData != null and pageData.total > 0}">
                                <tr>
                                    <td aria-live="polite" class="empty" colspan="11">조회 결과가 없습니다.</td>
                                </tr>
                            </th:block>
                        </tbody>
                    </table>
                </div>

                <div class="mt20" id="grid-pager">
                    <th:block th:replace="~{component/pagination :: pager(pageData=${pageData})}"></th:block>
                </div>
            </div>
        </section>

        <!-- Modal (쉘만, 내용은 프래그먼트/템플릿 주입) -->
        <div aria-hidden="true" aria-labelledby="modal-title-basic" aria-modal="true" class="modal modal-lg"
            id="modal-manager" role="dialog">
            <div class="modal-overlay" data-dismiss></div>
            <div class="modal-container" role="document" tabindex="-1"></div>
        </div>

        <!-- 공통 푸터 -->
        <th:block th:replace="~{component/commonFooter :: commonFooter}"></th:block>

        <!-- (A) 상세 모달: 기존 유지 -->
        <th:block th:fragment="modal-detail">
            <header class="modal-header">
                <h3 class="modal-title" id="modal-title-basic" th:text="${dvsCd == '01'} ? '한도(금액) 설정' : '한도(건수) 설정'">
                </h3>
                <button aria-label="닫기" class="modal-close" data-dismiss type="button"></button>
            </header>
            <input id="dvsCd" th:value="${dvsCd}" type="hidden" />
            <input id="typCd" th:value="${typCd}" type="hidden" />
            <form th:object="${form}">
                <div class="modal-body" th:if="${dvsCd == '01'}">
                    <div class="flex align-center justify-space-between">
                        <div class="tabs" role="tablist">
                            <button aria-controls="panel-1" aria-selected="true" class="tab is-active"
                                role="tab">분기</button>
                            <button aria-controls="panel-2" aria-selected="false" class="tab is-active" role="tab"
                                th:disabled="${typCd == '02'}">월</button>
                        </div>
                    </div>

                    <!-- 분기 -->
                    <div aria-labelledby="tab-1" class="tab-panel is-active" role="tabpanel">
                        <div class="table-wrap">
                            <table class="table">
                                <caption class="blind">지급금 신청 테이블</caption>
                                <thead>
                                    <tr>
                                        <th scope="col">순번</th>
                                        <th scope="col">한도 시작, 종료 기간</th>
                                        <th scope="col">한도금액(원)</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr th:each="u, stat : ${sprtLmtDtIList}">
                                        <input th:field="*{list[__${stat.index}__].spfnLmtMngNo}" type="hidden" />
                                        <td th:text="${stat.count}"></td>
                                        <td>
                                            <div class="flex align-center col-2">
                                                <div class="text-field datepicker" style="width: 200px">
                                                    <input th:attr="id=|detail-start-${stat.index}|" class="dp-input"
                                                        type="text" placeholder="YYYY-MM" data-dp-type="month"
                                                        autocomplete="off"
                                                        th:field="*{list[__${stat.index}__].lmtSttYm}" />
                                                    <button type="button" class="dp-btn" data-dp-toggle
                                                        aria-label="년 월 선택 열기"></button>
                                                </div>
                                                <span>~</span>
                                                <div class="text-field datepicker" style="width: 200px">
                                                    <input th:attr="id=|detail-end-${stat.index}|" class="dp-input"
                                                        type="text" placeholder="YYYY-MM" data-dp-type="month"
                                                        autocomplete="off"
                                                        th:field="*{list[__${stat.index}__].lmtEndYm}" />
                                                    <button type="button" class="dp-btn" data-dp-toggle
                                                        aria-label="년 월 선택 열기"></button>
                                                </div>
                                            </div>
                                        </td>
                                        <td>
                                            <input class="text-field" maxlength="15" pattern="^[0-9]+$"
                                                th:field="*{list[__${stat.index}__].tgtAdptVal}" type="number" />
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>

                    <div class="modal-body" th:if="${dvsCd == '02'}">
                        <div class="flex align-center justify-end">
                            <div class="tabs" role="tablist"></div>
                        </div>
                        <div class="flex col-">
                            <button class="btn btn-dark-line" id="addRow" type="button">행추가</button>
                            <button class="btn btn-dark-line" id="removeRow" type="button">행삭제</button>
                        </div>

                        <div class="table-wrap mt20" id="case">
                            <table class="table" id="ncntTable">
                                <caption class="blind">지급금 신청 테이블</caption>
                                <thead>
                                    <tr>
                                        <th scope="col">최소한도건</th>
                                        <th scope="col">최대한도건</th>
                                        <th scope="col">지급률(%)</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr th:each="u, stat : ${sprtLmtDtIList}">
                                        <input th:field="*{list[__${stat.index}__].spfnLmtMngNo}" type="hidden" />
                                        <td><input class="text-field date-text" disabled maxlength="15"
                                                pattern="^[0-9]+$" th:field="*{list[__${stat.index}__].minCndtVal}"
                                                type="number" /></td>
                                        <td><input class="text-field date-text" disabled maxlength="15"
                                                pattern="^[0-9]+$" th:field="*{list[__${stat.index}__].maxCndtVal}"
                                                type="number" /></td>
                                        <td><input class="text-field date-text" max="100" min="0" pattern="^[0-9]+$"
                                                th:field="*{list[__${stat.index}__].tgtAdptVal}" type="number" /></td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>

                    <footer class="modal-footer">
                        <button class="btn btn-dark-line" data-dismiss type="button">취소</button>
                        <button class="btn btn-blue" th:attr="data-typ-id=${tpwSvcTypId}" type="button">저장</button>
                    </footer>
                </div>
            </form>
        </th:block>

        <!-- (B) 금액 신규 모달 (amt) : 기존 유지 -->
        <th:block th:fragment="amt-modal">
            <header class="modal-header">
                <h3 class="modal-title">한도(금액) 설정</h3>
                <button aria-label="닫기" class="modal-close" data-dismiss type="button"></button>
            </header>
            <div class="modal-body">
                <div class="flex align-center justify-space-between">
                    <div class="tabs" role="tablist">
                        <button aria-controls="panel-1" aria-selected="true" class="tab is-active" id="tab-1"
                            role="tab">분기</button>
                        <button aria-controls="panel-2" aria-selected="false" class="tab" id="tab-2"
                            role="tab">월</button>
                    </div>
                </div>
                <div class="tab-panels">
                    <!-- 분기 -->
                    <div aria-labelledby="tab-1" class="tab-panel is-active" id="panel-1" role="tabpanel">
                        <div class="table-wrap">
                            <form id="qt" th:object="${amtQt}">
                                <table class="table">
                                    <caption class="blind">지급금 신청 테이블</caption>
                                    <colgroup>
                                        <col width="150px">
                                        <col width="300px">
                                        <col width="150px">
                                    </colgroup>
                                    <thead>
                                        <tr>
                                            <th scope="col">순번</th>
                                            <th scope="col">한도 시작, 종료 기간(분기)</th>
                                            <th scope="col">한도금액(원)</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <tr th:each="u, stat : ${qt}">
                                            <input th:field="*{list[__${stat.index}__].spfnLmtMngNo}" type="hidden" />
                                            <td th:text="${stat.count}"></td>
                                            <td>
                                                <div class="flex align-center col-2">
                                                    <div class="text-field datepicker" style="width: 200px">
                                                        <input th:attr="id=|qt-start-${stat.index}|" class="dp-input"
                                                            type="text" placeholder="YYYY-MM" data-dp-type="month"
                                                            autocomplete="off"
                                                            th:field="*{list[__${stat.index}__].lmtSttYm}" />
                                                        <button type="button" class="dp-btn" data-dp-toggle
                                                            aria-label="년 월 선택 열기"></button>
                                                    </div>
                                                    <span>~</span>
                                                    <div class="text-field datepicker" style="width: 200px">
                                                        <input th:attr="id=|qt-end-${stat.index}|" class="dp-input"
                                                            type="text" placeholder="YYYY-MM" data-dp-type="month"
                                                            autocomplete="off"
                                                            th:field="*{list[__${stat.index}__].lmtEndYm}" />
                                                        <button type="button" class="dp-btn" data-dp-toggle
                                                            aria-label="년 월 선택 열기"></button>
                                                    </div>
                                                </div>
                                            </td>
                                            <td><input class="text-field" maxlength="15" pattern="^[0-9]+$"
                                                    th:field="*{list[__${stat.index}__].tgtAdptVal}" type="number" />
                                            </td>
                                        </tr>
                                    </tbody>
                                </table>
                            </form>
                        </div>
                    </div>

                    <!-- 월 -->
                    <div aria-labelledby="tab-2" class="tab-panel" id="panel-2" role="tabpanel">
                        <div class="table-wrap">
                            <form id="mon" th:object="${amtMon}">
                                <table class="table">
                                    <caption class="blind">지급금 신청 테이블</caption>
                                    <thead>
                                        <tr>
                                            <th scope="col">순번</th>
                                            <th scope="col">한도 시작, 종료 기간(월)</th>
                                            <th scope="col">한도금액(원)</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <tr th:each="u, stat : ${mon}">
                                            <input th:field="*{list[__${stat.index}__].spfnLmtMngNo}" type="hidden" />
                                            <td th:text="${stat.count}"></td>
                                            <td>
                                                <div class="flex align-center col-2">
                                                    <div class="text-field datepicker" style="width: 200px">
                                                        <input th:attr="id=|mon-start-${stat.index}|" class="dp-input"
                                                            type="text" placeholder="YYYY-MM" data-dp-type="month"
                                                            autocomplete="off"
                                                            th:field="*{list[__${stat.index}__].lmtSttYm}" />
                                                        <button type="button" class="dp-btn" data-dp-toggle
                                                            aria-label="년 월 선택 열기"></button>
                                                    </div>
                                                </div>
                                            </td>
                                            <td><input class="text-field" maxlength="15" pattern="^[0-9]+$"
                                                    th:field="*{list[__${stat.index}__].tgtAdptVal}" type="number" />
                                            </td>
                                        </tr>
                                    </tbody>
                                </table>
                            </form>
                        </div>
                    </div>
                </div>
            </div>
            <footer class="modal-footer">
                <button class="btn btn-dark-line" data-dismiss type="button">취소</button>
                <button class="btn btn-blue" data-dvs-cd="01" type="button">저장</button>
            </footer>
        </th:block>

        <!-- (C) 건수 신규 모달 (ncnt) : 기존 유지 -->
        <th:block th:fragment="ncnt-modal">
            <header class="modal-header">
                <h3 class="modal-title">한도(건수) 설정</h3>
                <button aria-label="닫기" class="modal-close" data-dismiss type="button"></button>
            </header>
            <form th:object="${ncnt}">
                <div class="modal-body">
                    <div class="flex align-center justify-end">
                        <div class="flex col-">
                            <button class="btn btn-dark-line" id="newAddRow" type="button">행추가</button>
                            <button class="btn btn-dark-line" id="newRemoveRow" type="button">행삭제</button>
                        </div>
                    </div>
                    <div class="table-wrap mt20">
                        <table class="table" id="newNcntTable">
                            <caption class="blind">지급금 신청 테이블</caption>
                            <thead>
                                <tr>
                                    <th scope="col">최소한도건</th>
                                    <th scope="col">최대한도건</th>
                                    <th scope="col">지급률(%)</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr th:each="u, stat : ${arr}">
                                    <input th:field="*{list[__${stat.index}__].spfnLmtMngNo}" type="hidden" />
                                    <td><input class="text-field date-text" maxlength="15" pattern="^[0-9]+$"
                                            th:field="*{list[__${stat.index}__].minCndtVal}" type="number" /></td>
                                    <td><input class="text-field date-text" maxlength="15" pattern="^[0-9]+$"
                                            th:field="*{list[__${stat.index}__].maxCndtVal}" type="number" /></td>
                                    <td><input class="text-field date-text" max="100" min="0" pattern="^[0-9]+$"
                                            th:field="*{list[__${stat.index}__].tgtAdptVal}" type="number" /></td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
                <footer class="modal-footer">
                    <button class="btn btn-dark-line" data-dismiss type="button">취소</button>
                    <button class="btn btn-blue js-save" data-dvs-cd="02" type="button">저장</button>
                </footer>
            </form>
        </th:block>

        <!-- ✅ 신규 설정 1단계: 서비스/유형 선택 템플릿(모달) -->
        <template id="tpl-selector-modal">
            <div class="__selector-modal-root selector-modal">
                <header class="modal-header">
                    <h3 class="modal-title">신규 한도 설정 – 서비스 선택</h3>
                    <button aria-label="닫기" class="modal-close" data-dismiss type="button"></button>
                </header>

                <!-- ✅ 모달 전용 스타일: 스크롤 방지 & 드롭다운 팝오버 -->
                <style>
                    .selector-modal .modal-body {
                        overflow: visible
                    }

                    .selector-modal .dropdown {
                        position: relative;
                        width: 280px
                    }

                    .selector-modal .dropdown_button {
                        width: 100%
                    }

                    .selector-modal .dropdown_list {
                        position: absolute;
                        top: calc(100% + 8px);
                        left: 0;
                        right: 0;
                        max-height: 280px;
                        overflow: auto;
                        background: #fff;
                        border: 1px solid #e5e7eb;
                        border-radius: 8px;
                        box-shadow: 0 12px 30px rgba(0, 0, 0, .12);
                        z-index: 1060;
                    }

                    .selector-modal .dropdown_list .dropdown_option {
                        padding: 10px 12px;
                        cursor: pointer
                    }

                    .selector-modal .dropdown_list .dropdown_option[aria-disabled="true"] {
                        color: #999;
                        cursor: default
                    }

                    .selector-modal .cascading-dropdowns {
                        display: flex;
                        gap: 16px;
                        flex-wrap: wrap;
                        align-items: flex-start
                    }
                </style>

                <div class="modal-body">
                    <p class="mb12" style="margin:0 0 16px; line-height:1.5;">
                        신규 한도 설정을 진행할 <strong>서비스/유형</strong>을 선택하세요.
                    </p>

                    <!-- 모달 전용 드롭다운 (검색용과 분리) -->
                    <div style="display:flex; gap:16px; flex-wrap:wrap; margin:0 0 20px;">
                        <th:block th:replace="~{common/fragment/dropdowns :: cascadingDropdown(
          'svcPair-modal','tpwSvcIdSel','tpwSvcTypIdSel'
        )}"></th:block>
                    </div>
                </div>

                <footer class="modal-footer">
                    <button class="btn btn-dark-line" data-dismiss type="button">취소</button>
                    <button class="btn btn-blue js-next" type="button">다음</button>
                </footer>
            </div>
        </template>

        <!-- 페이지 전용 스크립트 -->
        <script th:inline="javascript" type="text/javascript">
            (function () {

                if (window.Common && typeof window.Common.sendSafe === 'function') {
                    const __origSendSafe = window.Common.sendSafe.bind(window.Common);
                    window.Common.sendSafe = function (arg1, arg2) {
                        if (typeof arg1 === 'string') {
                            return __origSendSafe(Object.assign({ url: arg1 }, arg2 || {}));
                        }
                        return __origSendSafe(arg1 || {});
                    };
                }

                const baseUrl = '/sprtpolimng/polimnginf/sprtlmtPt.do';
                const grid = document.getElementById('grid');
                const head = document.getElementById('grid-head');
                const searchForm = grid.querySelector('form');
                const selectSize = searchForm?.querySelector('select[name="size"]');
                const inputSort = document.getElementById('sort');
                const inputDir = document.getElementById('dir');

                // 엑셀
                grid.addEventListener('click', (e) => {
                    const exportBtn = e.target.closest('button[data-export="xlsx"]');
                    if (!exportBtn) return;
                    Common.bindExcelExport(searchForm, exportBtn, inputSort.value, inputDir.value, 'tpwSvcTypId');
                });

                // 초기 페이징 바인딩
                bindPagination(baseUrl, {
                    size: parseInt(selectSize?.value || '10', 10),
                    dir: inputDir?.value || 'asc',
                    sort: inputSort?.value || 'tpwSvcTypId'
                });

                // 정렬
                head.addEventListener('click', (e) => {
                    const a = e.target.closest('a[data-sort]');
                    if (!a) return;
                    e.preventDefault();
                    const next = a.dataset.sort;
                    const curr = inputSort?.value || 'tpw_svc_typ_id';
                    let dir = inputDir?.value || 'asc';
                    dir = next === curr ? (dir === 'asc' ? 'desc' : 'asc') : 'asc';

                    if (inputSort) inputSort.value = next;
                    if (inputDir) inputDir.value = dir;

                    const applied = Common.collectFromForm(searchForm);
                    Common.reloadList({
                        page: 0,
                        defaultSortColumn: 'tpw_svc_typ_id',
                        swapTargets: ['#grid-tbody', '#grid-pager', '#grid-header', '#grid-title'],
                        selectSize,
                        baseUrl,
                        inputSort,
                        inputDir,
                        applied
                    });
                });

                // 검색 submit
                searchForm?.addEventListener('submit', (e) => {
                    e.preventDefault();
                    const applied = Common.collectFromForm(searchForm);
                    Common.reloadList({
                        page: 0,
                        defaultSortColumn: 'tpw_svc_typ_id',
                        swapTargets: ['#grid-tbody', '#grid-pager', '#grid-header', '#grid-title'],
                        selectSize,
                        baseUrl,
                        inputSort,
                        inputDir,
                        applied
                    });
                });

                // 모달 엘리먼트
                const modal = document.getElementById('modal-manager');

                // 템플릿 내부의 <script> 재실행 유틸 (template->DOM 주입 시 필요)
                function runInlineScripts(root) {
                    const scripts = Array.from(root.querySelectorAll('script'));
                    for (const old of scripts) {
                        const s = document.createElement('script');
                        if (old.type) s.type = old.type;
                        if (old.noModule) s.noModule = true;
                        if (!old.src) s.textContent = old.textContent || '';
                        old.replaceWith(s);
                    }
                }

                /* ✅ 분기 편집 제어 + 자동 분기 계산 */
                function initQuarterOnlyEdit(scope) {
                    const root = scope || document;

                    const qtForm = root.querySelector('#qt');
                    // ✅ 월 탭(#mon) 전부 읽기전용 + 버튼 비활성
                    const monForm = root.querySelector('#mon');
                    if (monForm) {
                        monForm.querySelectorAll('.dp-input').forEach(i => {
                            i.readOnly = true;
                            i.closest('.text-field')?.classList.add('readonly');
                        });
                        monForm.querySelectorAll('.dp-btn').forEach(b => { b.disabled = true; });
                    }
                    if (!qtForm) return;

                    // 모달에 읽기전용 스타일 플래그
                    modal.classList.add('qtr-readonly');

                    const rows = Array.from(qtForm.querySelectorAll('tbody tr'));
                    if (!rows.length) return;

                    const allInputs = Array.from(qtForm.querySelectorAll('.dp-input'));
                    const allBtns = Array.from(qtForm.querySelectorAll('.dp-btn'));

                    const firstStart = qtForm.querySelector('#qt-start-0') || allInputs[0];

                    // 1) 전체 비활성 + 회색 처리
                    allInputs.forEach(i => {
                        i.readOnly = true;
                        i.closest('.text-field')?.classList.add('readonly');
                    });
                    allBtns.forEach(b => { b.disabled = true; });

                    // 2) 첫 번째 시작만 활성
                    if (firstStart) {
                        firstStart.readOnly = false;
                        firstStart.closest('.text-field')?.classList.remove('readonly');
                        const firstStartBtn = firstStart.closest('.text-field')?.querySelector('.dp-btn');
                        if (firstStartBtn) firstStartBtn.disabled = false;
                    }

                    // 3) 자동 분기 채움
                    function parseYm(val) {
                        const s = String(val || '').trim();
                        let y, m;
                        if (/^\d{4}-\d{2}$/.test(s)) { y = +s.slice(0, 4); m = +s.slice(5, 7); }
                        else if (/^\d{6}$/.test(s)) { y = +s.slice(0, 4); m = +s.slice(4, 6); }
                        else return null;
                        if (m < 1 || m > 12) return null; return { y, m };
                    }
                    const fmtYm = (y, m) => `${y}-${m < 10 ? '0' : ''}${m}`;
                    const addMonths = (y, m, off) => {
                        const z = y * 12 + (m - 1) + off;
                        return { y: Math.floor(z / 12), m: (z % 12) + 1 };
                    };

                    function applyQuarters() {
                        const base = parseYm(firstStart.value);
                        if (!base) return;

                        rows.forEach((tr, idx) => {
                            const sInput = tr.querySelector('[id^="qt-start-"]');
                            const eInput = tr.querySelector('[id^="qt-end-"]');
                            if (!sInput || !eInput) return;

                            const s = addMonths(base.y, base.m, idx * 3);
                            const e = addMonths(s.y, s.m, 2);

                            sInput.value = fmtYm(s.y, s.m);
                            eInput.value = fmtYm(e.y, e.m);
                        });
                    }

                    // 최초 적용 + 변경 반영
                    applyQuarters();
                    firstStart.addEventListener('input', applyQuarters);
                    firstStart.addEventListener('change', applyQuarters);
                }

                // 신규 한도 설정: 1단계 선택 모달 표시
                async function showSelectorModal() {
                    const tpl = document.getElementById('tpl-selector-modal');
                    const container = modal.querySelector('.modal-container');
                    container.innerHTML = '';
                    const clone = document.importNode(tpl.content, true);
                    container.appendChild(clone);
                    runInlineScripts(container); // 드롭다운 스크립트 재실행
                    Common.openModal ? Common.openModal('#modal-manager') : modal.setAttribute('aria-hidden', 'false');
                    modal.classList.add('is-open');
                    document.body.classList.add('modal-open');
                    (container || modal).focus();
                }

                // 선택 후 해당 신규 모달 로드
                async function proceedNewFlow() {
                    const cas = document.getElementById('svcPair-modal')?.getSelectedObjects('svcPair-modal');
                    if (!cas || !cas.valid) {
                        Common.modalShow({ message: '서비스와 서비스 유형을 선택해 주세요.', title: '알림', buttons: 'close' });
                        return;
                    }
                    const container = modal.querySelector('.modal-container');
                    try {
                        if (cas.child.trdNcntLtnAdptYn === 'N') {
                            const html = await Common.fetchHtml('/sprtpolimng/polimnginf/sprtLmtDtl/new/amt');
                            container.innerHTML = html;
                            // ✅ 분기 입력 제어 적용
                            initQuarterOnlyEdit(container);
                        } else if (cas.child.trdNcntLtnAdptYn === 'Y') {
                            const html = await Common.fetchHtml('/sprtpolimng/polimnginf/sprtLmtDtl/new/ncnt');
                            container.innerHTML = html;
                            modal.classList.remove('qtr-readonly');
                        } else {
                            Common.modalShow({ message: '선택한 서비스 유형의 한도 유형 정보를 확인할 수 없습니다.', title: '알림', buttons: 'close' });
                            return;
                        }
                    } catch (e) {
                        console.error(e);
                    }
                }

                // 행 추가/삭제 유틸(신규 ncnt 모달용)
                function addRow(tableId, listName) {
                    const tbody = document.querySelector(`#${tableId} tbody`);
                    if (!tbody) return;
                    const index = tbody.querySelectorAll('tr').length;
                    const row = document.createElement('tr');
                    row.innerHTML = `
                  <td><input type="text" class="text-field date-text" name="${listName}[${index}].minCndtVal"/></td>
                  <td><input type="text" class="text-field date-text" name="${listName}[${index}].maxCndtVal"/></td>
                  <td><input type="text" class="text-field date-text" name="${listName}[${index}].tgtAdptVal"/></td>
                `;
                    tbody.appendChild(row);
                }
                function removeLastRow(tableId) {
                    const tbody = document.querySelector(`#${tableId} tbody`);
                    if (!tbody) return;
                    const rows = tbody.querySelectorAll('tr');
                    if (rows.length > 0) rows[rows.length - 1].remove();
                }

                // 결과 모달 응답 처리 + 리스트 갱신
                function resModal(res) {
                    if (res?.ok) {
                        Common.modalShow({ message: '저장이 완료되었습니다.', title: '알림', buttons: 'close' });
                    } else {
                        Common.modalShow({ message: '저장에 실패하였습니다.', title: '알림', buttons: 'close' });
                    }
                    const applied = Common.collectFromForm(searchForm);
                    Common.reloadList({
                        page: 0,
                        defaultSortColumn: 'tpw_svc_typ_id',
                        swapTargets: ['#grid-tbody', '#grid-pager', '#grid-header', '#grid-title'],
                        selectSize,
                        baseUrl,
                        inputSort,
                        inputDir,
                        applied
                    });
                }

                // 문서 전체 위임 핸들러
                document.addEventListener('click', async (e) => {
                    // 신규 설정 버튼
                    const newBtn = e.target.closest('#new-modal[data-mode="new"]');
                    if (newBtn) {
                        e.preventDefault();
                        await showSelectorModal();
                        return;
                    }

                    // 선택 모달의 "다음"
                    const nextBtn = e.target.closest('.js-next');
                    if (nextBtn && modal.contains(nextBtn)) {
                        e.preventDefault();
                        await proceedNewFlow();
                        return;
                    }

                    // 리스트의 "설정하기" (상세 조회 모달)
                    const btnOpen = e.target.closest('.open-modal');
                    if (btnOpen && btnOpen.id !== 'new-modal') {
                        e.preventDefault();
                        const tpwSvcTypId = btnOpen.getAttribute('data-id') || '';
                        const useYn = btnOpen.getAttribute('data-use-yn') || 'Y';
                        if (!tpwSvcTypId) return;
                        try {
                            const html = await Common.fetchHtml(
                                '/sprtpolimng/polimnginf/sprtLmtDtl/' + encodeURIComponent(useYn) + '/' + encodeURIComponent(tpwSvcTypId)
                            );
                            const container = modal.querySelector('.modal-container');
                            container.innerHTML = html;

                            // 상세 모달이 금액(분기) 탭 구조일 때도 보호 적용 시도(없으면 조용히 패스)
                            initQuarterOnlyEdit(container);

                            modal.setAttribute('aria-hidden', 'false');
                            modal.classList.add('is-open');
                            document.body.classList.add('modal-open');
                            (container || modal).focus();
                        } catch (err) {
                            console.error(err);
                            Common.modalShow({ message: '상세 화면을 불러오지 못했습니다.', title: '오류', buttons: 'close' });
                        }
                        return;
                    }

                    // 모달 내 버튼 라벨 처리(저장/취소/행추가/행삭제)
                    const modalBtn = e.target.closest('#modal-manager .btn');
                    if (!modalBtn) return;

                    const label = (modalBtn.textContent || '').trim();

                    if (label === '저장') {
                        const dvsCdEl = document.getElementById('dvsCd');
                        const dvsCd = dvsCdEl ? dvsCdEl.value : modalBtn.dataset.dvsCd;
                        try {
                            if (dvsCd === '01') {
                                const amountForm = modal.querySelector('form');
                                const applied = Common.collectAsJson(amountForm);
                                const tpwSvcTypId = modal.querySelector('button.btn-blue')?.getAttribute('data-typ-id')
                                    || modalBtn.getAttribute('data-typ-id') || '';
                                const url = '/sprtpolimng/polimnginf/sprtLmt/amt/' + encodeURIComponent(tpwSvcTypId) + '/edit';
                                e.preventDefault();
                                const res = await Common.sendSafe(url, { method: 'POST', data: applied.list });
                                Common.closeModal('#modal-manager');
                                resModal(res);
                            } else if (dvsCd === '02') {
                                const ncntForm = modal.querySelector('form');
                                const applied = Common.collectAsJson(ncntForm);
                                const tpwSvcTypId = modal.querySelector('button.btn-blue')?.getAttribute('data-typ-id')
                                    || modalBtn.getAttribute('data-typ-id') || '';
                                const url = '/sprtpolimng/polimnginf/sprtLmt/ncnt/' + encodeURIComponent(tpwSvcTypId) + '/edit';
                                e.preventDefault();
                                const res = await Common.sendSafe(url, { method: 'POST', data: applied.list });
                                Common.closeModal('#modal-manager');
                                resModal(res);
                            } else {
                                // 신규 작성(모달 2단계) 저장 케이스
                                const tpwLmtDvsCd = modalBtn.dataset.dvsCd;
                                const cas = document.getElementById('svcPair1')?.getSelectedObjects?.('svcPair1') || null; // 검색용은 fallback
                                if (!cas) return;
                                if (tpwLmtDvsCd === '01') {
                                    const amtPanelForm = modal.querySelector('form');
                                    const applied = Common.collectAsJson(amtPanelForm);
                                    const url = '/sprtpolimng/polimnginf/sprtLmt/amt';
                                    e.preventDefault();
                                    applied.tpwSvcId = cas.child.tpwSvcId;
                                    applied.tpwSvcTypId = cas.child.tpwSvcTypId;
                                    applied.tpwLmtDvsCd = '01';
                                    applied.tpwLmtTypCd = '01';
                                    const res = await Common.sendSafe(url, { method: 'POST', data: applied });
                                    Common.closeModal('#modal-manager');
                                    resModal(res);
                                } else if (tpwLmtDvsCd === '02') {
                                    const ncntForm = modal.querySelector('form');
                                    const applied = Common.collectAsJson(ncntForm);
                                    const url = '/sprtpolimng/polimnginf/sprtLmt/ncnt';
                                    applied.tpwSvcId = cas.child.tpwSvcId;
                                    applied.tpwSvcTypId = cas.child.tpwSvcTypId;
                                    applied.tpwLmtDvsCd = '02';
                                    applied.tpwLmtTypCd = '01';
                                    e.preventDefault();
                                    const res = await Common.sendSafe(url, { method: 'POST', data: applied });
                                    Common.closeModal('#modal-manager');
                                    resModal(res);
                                }
                            }
                        } catch (err) {
                            console.error(err);
                            alert(err.message || '처리 중 오류가 발생했습니다.');
                        }
                    } else if (label === '취소') {
                        Common.closeModal('#modal-manager');
                        modal.classList.remove('qtr-readonly');
                    } else if (label === '행추가') {
                        addRow('newNcntTable', 'list');
                    } else if (label === '행삭제') {
                        removeLastRow('newNcntTable');
                    }
                });
            })();
        </script>
    </th:block>
</th:block>

</html>
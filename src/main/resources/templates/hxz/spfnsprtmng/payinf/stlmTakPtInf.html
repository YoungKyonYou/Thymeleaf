<!doctype html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org" xmlns:sec="http://www.w3.org/1999/xhtml">
<th:block th:replace="~{component/commonHead :: layout(~{::content})}">
    <th:block th:fragment="content">

        <section class="section">
            <div class="section-header" >
                <form id="searchForm" th:object="${req}" method="get">
                    <div class="title-wrap">
                        <h3 class="section-title">정산작업내역조회</h3>
                    </div>

                    <div class="box-wrap">
                        <div class="box">
                            <p class="field-title">기간검색</p>
                            <div class="dropdown" data-name="searchType">
                                <button type="button" class="dropdown_button" aria-haspopup="listbox" aria-expanded="false" aria-label="기간검색 드롭다운">
                                    <span class="dropdown_value" data-placeholder="" th:data-text="*{searchType}">
                                        </span>
                                </button>
                                <ul class="dropdown_list" role="listbox" tabindex="-1">
                                    <li role="option" class="dropdown_option" data-value="stlmDt">정산일자</li>
                                    <li role="option" class="dropdown_option" data-value="fixDt">확정일자</li>
                                    <li role="option" class="dropdown_option" data-value="aplDt">신청기간</li>
                                </ul>
                                <input type="hidden" th:field="*{searchType}">
                            </div>
                        </div>

                        <div class="box">
                            <p class="field-title">기간</p>
                            <div class="flex align-center col-">
                                <div class="date-field">
                                    <input type="text" id="startDate" th:field="*{sttDt}" class="text-field date-text">
                                </div>
                                <span>~</span>
                                <div class="date-field">
                                    <input type="text" id="endDate" th:field="*{endDt}" class="text-field date-text">
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="box-wrap">
                        <div class="box">
                            <p class="field-title">서비스 선택</p>
                            <th:block th:replace="~{common/fragment/dropdowns :: cascadingDropdown(
                                'svcPair1','tpwSvcId','tpwSvcTypId', true
                            )}"></th:block>
                        </div>

                        <div class="box">
                            <p class="field-title">실행구분</p>
                            <div class="dropdown" data-name="exeDiv">
                                <button type="button" class="dropdown_button" aria-haspopup="listbox" aria-expanded="false" aria-label="실행구분 드롭다운">
                                    <span class="dropdown_value" data-placeholder="" th:data-value="${exeDiv}" th:text="${exeDiv == 'PERD' ? '정기' : '시뮬레이션'}"></span>
                                </button>
                                <ul class="dropdown_list" role="listbox" tabindex="-1">
                                    <li role="option" class="dropdown_option" data-value="PERD">정기</li>
                                    <li role="option" class="dropdown_option" data-value="SIM">시뮬레이션</li>
                                </ul>
                                <input type="hidden" th:field="*{exeDiv}">
                            </div>
                        </div>
                    </div>

                    <div class="btn-wrap">
                        <button type="button" class="btn btn-secondary btn-icon-left"
                                data-export="xlsx"
                                data-provider="정산작업내역조회"
                        >
                            다운로드
                            <i class="icon icon-save"></i>
                        </button>
                        <button type="submit" class="btn btn-primary btn-icon-left">
                            검색
                            <i class="icon icon-search"></i>
                        </button>
                    </div>

                    <input th:field="*{sort}" type="hidden" />
                    <input th:field="*{dir}" type="hidden" />

                    <!-- 페이지 번호 등 검색 조건 유지용 -->
                    <input type="hidden" name="page" th:value="${pageData.page}" />

                </form>
            </div>

            <div class="section-content" id="grid-header">
                <div id="search-count" class="flex justify-space-between"
                     th:with="isPerd=${exeDiv == 'PERD'}, isSim=${exeDiv == 'SIM'}">
                    <b th:if="${isPerd}"
                       th:text="'[정기 정산 결과] 검색결과 : ' + (${pageData != null} ? ${pageData.total} : 0) + '건'"></b>
                    <b th:if="${isSim}"
                       th:text="'[시뮬레이션 결과] 검색결과 : ' + (${pageData != null} ? ${pageData.total} : 0) + '건'"></b>
                    <b th:if="${!isPerd and !isSim}"
                       th:text="'검색결과 : ' + (${pageData != null} ? ${pageData.total} : 0) + '건'"></b>
                </div>

                <div class="table-wrap mt20">
                    <table class="table" id="grid">
                        <caption class="blind">정산 작업 목록 테이블</caption>

                        <thead th:with="isPerd=${exeDiv == 'PERD'}, isSim=${exeDiv == 'SIM'}">
                        <tr>
                            <th scope="col">구분</th>
                            <th class="sort-header" scope="col"><a data-sort="org_nm">기관명</a></th>
                            <th class="sort-header" scope="col"><a data-sort="tpw_svc_nm">서비스명</a></th>
                            <th class="sort-header" scope="col"><a data-sort="tpw_svc_typ_nm">서비스유형명</a></th>
                            <th class="sort-header" scope="col"><a data-sort="tpw_svc_typ_sno">서비스유형번호</a></th>

                            <th class="sort-header" scope="col" th:if="${isPerd}"><a data-sort="apl_stt_dt">신청 시작일자</a></th>
                            <th class="sort-header" scope="col" th:if="${isPerd}"><a data-sort="apl_end_dt">신청 종료일자</a></th>

                            <th class="sort-header" scope="col" th:if="${isSim}"><a data-sort="apl_dt">적용일자</a></th>

                            <th class="sort-header" scope="col"><a data-sort="tpw_trd_stt_dt">거래 시작일자</a></th>
                            <th class="sort-header" scope="col"><a data-sort="tpw_trd_end_dt">거래 종료일자</a></th>

                            <th class="sort-header" scope="col" th:if="${isPerd}"><a data-sort="fix_dt">확정일자</a></th>
                            <th class="sort-header" scope="col" th:if="${isPerd}"><a data-sort="stlm_dt">정산일자</a></th>
                            <th class="sort-header" scope="col" th:if="${isPerd}"><a data-sort="clos_cfm_yn">마감확인여부</a></th>
                            <th class="sort-header" scope="col" th:if="${isPerd}"><a data-sort="stlm_fix_yn">정산확정여부</a></th>
                            <th class="sort-header" scope="col" th:if="${isPerd}"><a data-sort="acng_prcg_fn_yn">회계처리완료여부</a></th>

                            <th class="sort-header" scope="col" th:if="${isSim}"><a data-sort="prcg_fn_yn">처리완료여부</a></th>
                        </tr>
                        </thead>

                        <tbody id="grid-tbody" th:with="isPerd=${exeDiv == 'PERD'}, isSim=${exeDiv == 'SIM'}">
                        <th:block th:if="${pageData != null and !#lists.isEmpty(pageData.content)}">
                            <th:block th:each="u, stat : ${pageData.content}"
                                      th:with="base=${(pageData.page)} * ${pageData.size}"
                                      th:object="${u}">
                                <tr class="clickable-row">
                                    <td>
                                        <input type="hidden" name="tpwSvcTypId" th:value="*{tpwSvcTypId}">
                                        <input type="hidden" name="tpwSvcTypSno" th:value="*{tpwSvcTypSno}">
                                        <input type="hidden" name="exeDiv" th:value="*{exeDiv}">
                                        <input type="hidden" name="tpwSvcId" th:value="*{tpwSvcId}">
                                        <input type="hidden" name="stlmDt" th:value="*{stlmDt}">
                                        <input type="hidden" name="aplDt" th:value="*{aplDt}">
                                        <span th:text="${base + stat.index + 1}">1</span>
                                    </td>
                                    <td th:text="*{orgNm}">기관명</td>
                                    <td th:text="*{tpwSvcNm}">서비스</td>
                                    <td th:text="*{tpwSvcTypNm}">서비스유형</td>
                                    <td th:text="*{tpwSvcTypSno}">서비스유형번호</td>

                                    <td th:if="${isPerd}" th:text="*{aplSttDt}">신청 시작일자</td>
                                    <td th:if="${isPerd}" th:text="*{aplEndDt}">신청 종료일자</td>

                                    <td th:if="${isSim}" th:text="*{aplDt}">적용일자</td>

                                    <td th:text="*{tpwTrdSttDt}">거래 시작일자</td>
                                    <td th:text="*{tpwTrdEndDt}">거래 종료일자</td>

                                    <td th:if="${isPerd}" th:text="*{fixDt}">확정일자</td>
                                    <td th:if="${isPerd}" th:text="*{stlmDt}">정산일자</td>
                                    <td th:if="${isPerd}" th:text="*{closCfmYn}">마감확인여부</td>
                                    <td th:if="${isPerd}" th:text="*{stlmFixYn}">정산확정여부</td>
                                    <td th:if="${isPerd}" th:text="*{acngPrcgFnYn}">회계처리완료여부</td>

                                    <td th:if="${isSim}" th:text="*{prcgFnYn}">처리완료여부</td>
                                </tr>
                            </th:block>
                        </th:block>

                        <tr th:if="${pageData == null or #lists.isEmpty(pageData.content)}">
                            <td th:attr="colspan=7" class="text-center">조회된 데이터가 없습니다.</td>
                        </tr>
                        </tbody>
                    </table>
                </div>
                <div class="mt20"  id="grid-pager">
                    <button type="button" class="btn btn-primary" onclick="moveToNewForm()">
                        신규등록
                    </button>

                </div>
                <div class="mt20" id="grid-pager">
                    <th:block th:replace="~{component/pagination :: pager(pageData=${pageData})}"></th:block>
                </div>
            </div>

        </section>


        <script>

            // 숫자 유틸
            const onlyDigits = (s) => (s || '').replace(/\D+/g, '');

            // 실행구분에 따른 신규등록 페이지 이동
            function moveToNewForm() {
                const exeDivInput = document.querySelector('input[name="exeDiv"]');
                const exeDiv = exeDivInput ? exeDivInput.value : 'PERD';

                if (exeDiv === 'SIM') {
                    location.href = '/spfnsprtmng/payinf/sim/new';
                } else {
                    location.href = '/spfnsprtmng/payinf/perd/new';
                }
            }

            // DOMContentLoaded 안으로 모든 초기화 로직 통합
            document.addEventListener('DOMContentLoaded', function () {

                // 1. 날짜 필드 초기화
                var ids = ['startDate', 'endDate'];
                for (var i = 0; i < ids.length; i++) {
                    var el = document.getElementById(ids[i]);
                    if (el) el.type = 'date';
                }

                // =========================================================================
                // 2. [수정됨] 상세 이동 로직 (파라미터 이름에 'target' 추가)
                // =========================================================================
                document.addEventListener('click', function(e) {
                    const currentTr = e.target.closest('#grid-tbody .clickable-row');
                    if (!currentTr) return;

                    const tpwSvcTypIdInput = currentTr.querySelector('[name="tpwSvcTypId"]');
                    if (!tpwSvcTypIdInput) return;

                    // 데이터 추출
                    const tpwSvcTypId = currentTr.querySelector('[name="tpwSvcTypId"]').value;
                    const tpwSvcTypSno = currentTr.querySelector('[name="tpwSvcTypSno"]').value;
                    const exeDiv = currentTr.querySelector('[name="exeDiv"]').value;
                    const tpwSvcId = currentTr.querySelector('[name="tpwSvcId"]').value;

                    const stlmDtInput = currentTr.querySelector('[name="stlmDt"]');
                    const aplDtInput = currentTr.querySelector('[name="aplDt"]');
                    const stlmDt = stlmDtInput ? stlmDtInput.value : '';
                    const aplDt = aplDtInput ? aplDtInput.value : '';

                    if (!tpwSvcId) {
                        alert('데이터 오류: 서비스 ID(tpwSvcId)가 없습니다.');
                        return;
                    }

                    // [핵심 수정] 검색조건 직렬화
                    const searchForm = document.getElementById('searchForm');
                    const formData = new FormData(searchForm);
                    const searchParams = new URLSearchParams(formData).toString();

                    // [핵심 수정] 상세 조회용 ID 파라미터 이름 변경 (target...)
                    // Controller에서 @RequestParam("targetTpwSvcTypId") 로 받도록 수정했으므로 맞춰줌
                    let url = `/spfnsprtmng/payinf/${exeDiv.toLowerCase()}/edit?targetTpwSvcTypId=${tpwSvcTypId}&targetTpwSvcTypSno=${tpwSvcTypSno}&targetTpwSvcId=${tpwSvcId}&exeDiv=${exeDiv}`;

                    if (exeDiv === 'SIM') {
                        url += `&targetAplDt=${aplDt}`; // aplDt -> targetAplDt
                    } else {
                        url += `&targetStlmDt=${stlmDt}`; // stlmDt -> targetStlmDt
                    }

                    // 이동 (상세조회 ID + 검색조건 파라미터)
                    location.href = url + '&' + searchParams;
                });
                // =========================================================================


                // 3. 검색 및 페이징 초기화
                const baseUrl = '/spfnsprtmng/payinf/stlmTakPtInf.do';
                const head = document.getElementById('grid-header');
                const searchForm = document.getElementById('searchForm');

                if (searchForm) {
                    const selectSize = searchForm.querySelector('select[name="size"]');
                    const inputSort = document.getElementById('sort');
                    const inputDir = document.getElementById('dir');
                    const loading = document.getElementById('mini-sp-loading');

                    // 엑셀 다운로드 핸들러
                    const exportHandler = (e) => {
                        const exportBtn = e.target.closest('button[data-export="xlsx"]');
                        if(exportBtn && Common && Common.bindExcelExport) {
                            Common.bindExcelExport(searchForm, exportBtn, inputSort.value, inputDir.value, 'mbrs_id', { dnRsn: '' });
                            setTimeout(() => {
                                if(loading) loading.style.display = 'none';
                            }, 1000);
                        }
                    };
                    document.body.addEventListener('click', exportHandler);

                    // bindPagination 안전 호출
                    const pageOptions = {
                        page: 0,
                        size: parseInt((selectSize && selectSize.value) || '10', 10),
                        dir: (inputDir && inputDir.value) || 'asc',
                        sort: (inputSort && inputSort.value) || 'batTakDt'
                    };

                    if (typeof bindPagination === 'function') {
                        bindPagination(baseUrl, pageOptions);
                    } else if (typeof Common !== 'undefined' && typeof Common.bindPagination === 'function') {
                        Common.bindPagination(baseUrl, pageOptions);
                    } else {
                        console.warn('Paging function (bindPagination) not found.');
                    }

                    // 테이블 헤더 정렬 클릭
                    if(head) {
                        head.addEventListener('click', (e) => {
                            const a = e.target.closest('[data-sort]');
                            if (!a) return;

                            e.preventDefault();
                            const next = a.dataset.sort;
                            const curr = inputSort?.value || 'batTakDt';
                            const dir = next === curr ? (inputDir.value === 'asc' ? 'desc' : 'asc') : 'asc';

                            if (inputSort) inputSort.value = next;
                            if (inputDir) inputDir.value = dir;

                            const applied = Common.collectFromForm(searchForm);
                            const dateColumn = ['endDt','sttDt'];
                            for (const k in applied) {
                                if ( dateColumn.includes(k) )
                                    applied[k] = onlyDigits(applied[k]);
                            }
                            Common.reloadList({
                                page: 0,
                                defaultSortColumn: 'batTakDt',
                                swapTargets: ['#grid-tbody', '#grid-pager', '#search-count'],
                                selectSize,
                                baseUrl,
                                inputSort,
                                inputDir,
                                applied
                            });
                        });
                    }

                    // 검색 폼 제출
                    searchForm.addEventListener('submit', (e) => {
                        e.preventDefault();
                        const applied = Common.collectFromForm(searchForm);

                        const dateColumn = ['endDt','sttDt'];
                        for (const k in applied) {
                            if ( dateColumn.includes(k) )
                                applied[k] = onlyDigits(applied[k]);
                        }

                        Common.reloadList({
                            page: 0,
                            defaultSortColumn: 'batTakDt',
                            swapTargets: ['#grid-tbody', '#grid-pager', '#search-count'],
                            selectSize,
                            baseUrl,
                            inputSort,
                            inputDir,
                            applied
                        });
                    });
                }
            });

        </script>

        <th:block th:replace="~{component/commonFooter :: commonFooter}"></th:block>

    </th:block>
</th:block>
</html>
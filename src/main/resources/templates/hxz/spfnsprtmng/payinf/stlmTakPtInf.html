<!doctype html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org" xmlns:sec="http://www.w3.org/1999/xhtml">
<th:block th:replace="~{component/commonHead :: layout(~{::content})}">
    <th:block th:fragment="content">

        <section class="section">
            <div class="section-header" >
                <form id="searchForm" th:object="${req}" method="get">
                    <div class="title-wrap">
                        <h3 class="section-title">정산작업내역조회</h3>
                    </div>

                    <div class="box-wrap">
                        <div class="box">
                            <p class="field-title">기간검색</p>
                            <div class="dropdown" data-name="searchType">
                                <button type="button" class="dropdown_button" aria-haspopup="listbox" aria-expanded="false" aria-label="기간검색 드롭다운">
                                    <span class="dropdown_value" data-placeholder="" th:data-text="*{searchType}">
                                        </span>
                                </button>
                                <ul class="dropdown_list" role="listbox" tabindex="-1">
                                    <li role="option" class="dropdown_option" data-value="stlmDt">정산일자</li>
                                    <li role="option" class="dropdown_option" data-value="fixDt">확정일자</li>
                                    <li role="option" class="dropdown_option" data-value="aplDt">신청기간</li>
                                </ul>
                                <input type="hidden" th:field="*{searchType}">
                            </div>
                        </div>

                        <div class="box">
                            <p class="field-title">기간</p>
                            <div class="flex align-center col-">
                                <div class="date-field">
                                    <input type="text" id="startDate" th:field="*{sttDt}" class="text-field date-text">
                                </div>
                                <span>~</span>
                                <div class="date-field">
                                    <input type="text" id="endDate" th:field="*{endDt}" class="text-field date-text">
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="box-wrap">
                        <div class="box">
                            <p class="field-title">서비스 선택</p>
                            <th:block th:replace="~{common/fragment/dropdowns :: cascadingDropdown(
                                'svcPair1','tpwSvcId','tpwSvcTypId', true
                            )}"></th:block>
                        </div>

                        <div class="box">
                            <p class="field-title">실행구분</p>
                            <div class="dropdown" data-name="exeDiv">
                                <button type="button" class="dropdown_button" aria-haspopup="listbox" aria-expanded="false" aria-label="실행구분 드롭다운">
                                    <span class="dropdown_value" data-placeholder="" th:data-value="${exeDiv}" th:text="${exeDiv == 'PERD' ? '정기' : '시뮬레이션'}"></span>
                                </button>
                                <ul class="dropdown_list" role="listbox" tabindex="-1">
                                    <li role="option" class="dropdown_option" data-value="PERD">정기</li>
                                    <li role="option" class="dropdown_option" data-value="SIM">시뮬레이션</li>
                                </ul>
                                <input type="hidden" th:field="*{exeDiv}">
                            </div>
                        </div>
                    </div>

                    <div class="btn-wrap">
                        <button type="button" class="btn btn-secondary btn-icon-left"
                                data-export="xlsx"
                                data-provider="정산작업내역조회"
                        >
                            다운로드
                            <i class="icon icon-save"></i>
                        </button>
                        <button type="submit" class="btn btn-primary btn-icon-left">
                            검색
                            <i class="icon icon-search"></i>
                        </button>
                    </div>

                    <input th:field="*{sort}" type="hidden" />
                    <input th:field="*{dir}" type="hidden" />

                    <!-- 페이지 번호 등 검색 조건 유지용 -->
                    <input type="hidden" name="page" th:value="${pageData.page}" />

                </form>
            </div>

            <div class="section-content" id="grid-header">
                <div id="search-count" class="flex justify-space-between"
                     th:with="isPerd=${exeDiv == 'PERD'}, isSim=${exeDiv == 'SIM'}">
                    <b th:if="${isPerd}"
                       th:text="'[정기 정산 결과] 검색결과 : ' + (${pageData != null} ? ${pageData.total} : 0) + '건'"></b>
                    <b th:if="${isSim}"
                       th:text="'[시뮬레이션 결과] 검색결과 : ' + (${pageData != null} ? ${pageData.total} : 0) + '건'"></b>
                    <b th:if="${!isPerd and !isSim}"
                       th:text="'검색결과 : ' + (${pageData != null} ? ${pageData.total} : 0) + '건'"></b>
                </div>

                <div class="table-wrap mt20">
                    <table class="table" id="grid">
                        <caption class="blind">정산 작업 목록 테이블</caption>

                        <thead th:with="isPerd=${exeDiv == 'PERD'}, isSim=${exeDiv == 'SIM'}">
                        <tr>
                            <th scope="col">구분</th>
                            <th class="sort-header" scope="col"><a data-sort="org_nm">기관명</a></th>
                            <th class="sort-header" scope="col"><a data-sort="tpw_svc_nm">서비스명</a></th>
                            <th class="sort-header" scope="col"><a data-sort="tpw_svc_typ_nm">서비스유형명</a></th>
                            <th class="sort-header" scope="col"><a data-sort="tpw_svc_typ_sno">서비스유형번호</a></th>

                            <th class="sort-header" scope="col" th:if="${isPerd}"><a data-sort="apl_stt_dt">신청 시작일자</a></th>
                            <th class="sort-header" scope="col" th:if="${isPerd}"><a data-sort="apl_end_dt">신청 종료일자</a></th>

                            <th class="sort-header" scope="col" th:if="${isSim}"><a data-sort="apl_dt">적용일자</a></th>

                            <th class="sort-header" scope="col"><a data-sort="tpw_trd_stt_dt">거래 시작일자</a></th>
                            <th class="sort-header" scope="col"><a data-sort="tpw_trd_end_dt">거래 종료일자</a></th>

                            <th class="sort-header" scope="col" th:if="${isPerd}"><a data-sort="fix_dt">확정일자</a></th>
                            <th class="sort-header" scope="col" th:if="${isPerd}"><a data-sort="stlm_dt">정산일자</a></th>
                            <th class="sort-header" scope="col" th:if="${isPerd}"><a data-sort="clos_cfm_yn">마감확인여부</a></th>
                            <th class="sort-header" scope="col" th:if="${isPerd}"><a data-sort="stlm_fix_yn">정산확정여부</a></th>
                            <th class="sort-header" scope="col" th:if="${isPerd}"><a data-sort="acng_prcg_fn_yn">회계처리완료여부</a></th>

                            <th class="sort-header" scope="col" th:if="${isSim}"><a data-sort="prcg_fn_yn">처리완료여부</a></th>
                        </tr>
                        </thead>

                        <tbody id="grid-tbody" th:with="isPerd=${exeDiv == 'PERD'}, isSim=${exeDiv == 'SIM'}">
                        <th:block th:if="${pageData != null and !#lists.isEmpty(pageData.content)}">
                            <th:block th:each="u, stat : ${pageData.content}"
                                      th:with="base=${(pageData.page)} * ${pageData.size}"
                                      th:object="${u}">
                                <tr class="clickable-row">
                                    <td>
                                        <input type="hidden" name="tpwSvcTypId" th:value="*{tpwSvcTypId}">
                                        <input type="hidden" name="tpwSvcTypSno" th:value="*{tpwSvcTypSno}">
                                        <input type="hidden" name="exeDiv" th:value="*{exeDiv}">
                                        <input type="hidden" name="tpwSvcId" th:value="*{tpwSvcId}">
                                        <input type="hidden" name="stlmDt" th:value="*{stlmDt}">
                                        <input type="hidden" name="aplDt" th:value="*{aplDt}">
                                        <span th:text="${base + stat.index + 1}">1</span>
                                    </td>
                                    <td th:text="*{orgNm}">기관명</td>
                                    <td th:text="*{tpwSvcNm}">서비스</td>
                                    <td th:text="*{tpwSvcTypNm}">서비스유형</td>
                                    <td th:text="*{tpwSvcTypSno}">서비스유형번호</td>

                                    <td th:if="${isPerd}" th:text="*{aplSttDt}">신청 시작일자</td>
                                    <td th:if="${isPerd}" th:text="*{aplEndDt}">신청 종료일자</td>

                                    <td th:if="${isSim}" th:text="*{aplDt}">적용일자</td>

                                    <td th:text="*{tpwTrdSttDt}">거래 시작일자</td>
                                    <td th:text="*{tpwTrdEndDt}">거래 종료일자</td>

                                    <td th:if="${isPerd}" th:text="*{fixDt}">확정일자</td>
                                    <td th:if="${isPerd}" th:text="*{stlmDt}">정산일자</td>
                                    <td th:if="${isPerd}" th:text="*{closCfmYn}">마감확인여부</td>
                                    <td th:if="${isPerd}" th:text="*{stlmFixYn}">정산확정여부</td>
                                    <td th:if="${isPerd}" th:text="*{acngPrcgFnYn}">회계처리완료여부</td>

                                    <td th:if="${isSim}" th:text="*{prcgFnYn}">처리완료여부</td>
                                </tr>
                            </th:block>
                        </th:block>

                        <tr th:if="${pageData == null or #lists.isEmpty(pageData.content)}">
                            <td th:attr="colspan=7" class="text-center">조회된 데이터가 없습니다.</td>
                        </tr>
                        </tbody>
                    </table>
                </div>
                <div class="mt20"  id="grid-pager">
                    <button type="button" class="btn btn-primary" onclick="moveToNewForm()">
                        신규등록
                    </button>

                </div>
                <div class="mt20" id="grid-pager">
                    <th:block th:replace="~{component/pagination :: pager(pageData=${pageData})}"></th:block>
                </div>
            </div>

        </section>


        <script>
            // 숫자 유틸
            const onlyDigits = (s) => (s || '').replace(/\D+/g, '');

            // 날짜 포맷팅 유틸 (YYYYMMDD_HHmm)
            const getTimestamp = () => {
                const now = new Date();
                const yyyy = now.getFullYear();
                const mm = String(now.getMonth() + 1).padStart(2, '0');
                const dd = String(now.getDate()).padStart(2, '0');
                const hh = String(now.getHours()).padStart(2, '0');
                const mi = String(now.getMinutes()).padStart(2, '0');
                return `${yyyy}${mm}${dd}_${hh}${mi}`;
            };

            // 실행구분에 따른 신규등록 페이지 이동
            function moveToNewForm() {
                const exeDivInput = document.querySelector('input[name="exeDiv"]');
                const exeDiv = exeDivInput ? exeDivInput.value : 'PERD';

                if (exeDiv === 'SIM') {
                    location.href = '/spfnsprtmng/payinf/sim/new';
                } else {
                    location.href = '/spfnsprtmng/payinf/perd/new';
                }
            }

            document.addEventListener('DOMContentLoaded', function () {

                // 1. 날짜 필드 초기화
                var ids = ['startDate', 'endDate'];
                for (var i = 0; i < ids.length; i++) {
                    var el = document.getElementById(ids[i]);
                    if (el) el.type = 'date';
                }

                // 2. 상세 이동 로직
                document.addEventListener('click', function(e) {
                    const currentTr = e.target.closest('#grid-tbody .clickable-row');
                    if (!currentTr) return;

                    const tpwSvcTypIdInput = currentTr.querySelector('[name="tpwSvcTypId"]');
                    if (!tpwSvcTypIdInput) return;

                    // 데이터 추출
                    const tpwSvcTypId = currentTr.querySelector('[name="tpwSvcTypId"]').value;
                    const tpwSvcTypSno = currentTr.querySelector('[name="tpwSvcTypSno"]').value;
                    const exeDiv = currentTr.querySelector('[name="exeDiv"]').value;
                    const tpwSvcId = currentTr.querySelector('[name="tpwSvcId"]').value;

                    const stlmDtInput = currentTr.querySelector('[name="stlmDt"]');
                    const aplDtInput = currentTr.querySelector('[name="aplDt"]');
                    const stlmDt = stlmDtInput ? stlmDtInput.value : '';
                    const aplDt = aplDtInput ? aplDtInput.value : '';

                    if (!tpwSvcId) {
                        alert('데이터 오류: 서비스 ID(tpwSvcId)가 없습니다.');
                        return;
                    }

                    const searchForm = document.getElementById('searchForm');
                    const formData = new FormData(searchForm);

                    // 상세 이동 시에도 날짜 포맷 맞춤 (선택사항)
                    if(formData.has('sttDt')) formData.set('sttDt', onlyDigits(formData.get('sttDt')));
                    if(formData.has('endDt')) formData.set('endDt', onlyDigits(formData.get('endDt')));

                    const searchParams = new URLSearchParams(formData).toString();

                    let url = `/spfnsprtmng/payinf/${exeDiv.toLowerCase()}/edit?targetTpwSvcTypId=${tpwSvcTypId}&targetTpwSvcTypSno=${tpwSvcTypSno}&targetTpwSvcId=${tpwSvcId}&exeDiv=${exeDiv}`;

                    if (exeDiv === 'SIM') {
                        url += `&targetAplDt=${aplDt}`;
                    } else {
                        url += `&targetStlmDt=${stlmDt}`;
                    }

                    location.href = url + '&' + searchParams;
                });

                // 3. 검색 및 페이징 초기화
                const baseUrl = '/spfnsprtmng/payinf/stlmTakPtInf.do';
                const head = document.getElementById('grid-header');
                const searchForm = document.getElementById('searchForm');

                if (searchForm) {
                    const selectSize = searchForm.querySelector('select[name="size"]');
                    const inputSort = document.getElementById('sort');
                    const inputDir = document.getElementById('dir');
                    const loading = document.getElementById('mini-sp-loading');

                    // 날짜 입력 필드 참조
                    const inputSttDt = document.getElementById('startDate');
                    const inputEndDt = document.getElementById('endDate');

                    //  엑셀 다운로드 핸들러
                  const exportHandler = (e) => {
                        const exportBtn = e.target.closest('button[data-export="xlsx"]');
                        if(exportBtn && Common && Common.bindExcelExport) {

                            // 1. 파일명 생성 (예: 정산작업내역조회_20251205_1430)
                            const baseName = "정산작업내역조회";
                            const fileName = `${baseName}_${getTimestamp()}`;

                            // 2. [중요] 폼에 'orgCd'와 'fileName'이 없으면 만들어서 넣기
                            // (이게 없어서 에러가 나고, 파일명이 export로 나왔던 것임)

                            // (A) fileName 처리
                            let fileNameInput = searchForm.querySelector('input[name="fileName"]');
                            if (!fileNameInput) {
                                fileNameInput = document.createElement('input');
                                fileNameInput.type = 'hidden';
                                fileNameInput.name = 'fileName';
                                searchForm.appendChild(fileNameInput);
                            }
                            fileNameInput.value = fileName;

                            // (B) orgCd 처리 (기존 model에 orgCd가 있었다면 th:value로 박혀있어야 함)
                            // 만약 HTML 어딘가에 이미 있다면 그걸 쓰겠지만, 없다면 강제로라도 넣어야 함
                            let orgCdInput = searchForm.querySelector('input[name="orgCd"]');
                            if (!orgCdInput) {
                                orgCdInput = document.createElement('input');
                                orgCdInput.type = 'hidden';
                                orgCdInput.name = 'orgCd';
                                // 주의: 실제 조직 코드가 동적으로 바뀐다면 서버에서 받은 값을 써야 함.
                                // 일단 기본값 '0000000' 세팅 (필요시 수정)
                                orgCdInput.value = '0000000';
                                searchForm.appendChild(orgCdInput);
                            }

                            // 3. 엑셀 다운로드 요청
                            // 정렬 컬럼은 'stlm_dt' 사용 (빈 값 '' 보다는 안전)
                            Common.bindExcelExport(
                                searchForm,
                                exportBtn,
                                inputSort.value,
                                inputDir.value,
                                'stlm_dt',
                                { dnRsn: '', fileName: fileName }
                            );

                            // 4. 스피너 종료
                            setTimeout(() => {
                                if(loading) loading.style.display = 'none';
                                const globalLoading = document.getElementById('loading');
                                if(globalLoading) globalLoading.style.display = 'none';
                            }, 3000);
                        }
                    };
                    document.body.addEventListener('click', exportHandler);

                    // bindPagination 호출
                    const pageOptions = {
                        page: 0,
                        size: parseInt((selectSize && selectSize.value) || '10', 10),
                        dir: (inputDir && inputDir.value) || 'asc',
                        sort: (inputSort && inputSort.value) || 'batTakDt'
                    };

                    if (typeof bindPagination === 'function') {
                        bindPagination(baseUrl, pageOptions);
                    } else if (typeof Common !== 'undefined' && typeof Common.bindPagination === 'function') {
                        Common.bindPagination(baseUrl, pageOptions);
                    }

                    // 테이블 헤더 정렬 클릭
                    if(head) {
                        head.addEventListener('click', (e) => {
                            const a = e.target.closest('[data-sort]');
                            if (!a) return;

                            e.preventDefault();
                            const next = a.dataset.sort;
                            const curr = inputSort?.value || 'batTakDt';
                            const dir = next === curr ? (inputDir.value === 'asc' ? 'desc' : 'asc') : 'asc';

                            if (inputSort) inputSort.value = next;
                            if (inputDir) inputDir.value = dir;

                            const applied = Common.collectFromForm(searchForm);

                            // 날짜 하이픈 제거
                            if (applied.sttDt) applied.sttDt = onlyDigits(applied.sttDt);
                            if (applied.endDt) applied.endDt = onlyDigits(applied.endDt);

                            Common.reloadList({
                                page: 0,
                                defaultSortColumn: 'batTakDt',
                                swapTargets: ['#grid-tbody', '#grid-pager', '#search-count'],
                                selectSize,
                                baseUrl,
                                inputSort,
                                inputDir,
                                applied
                            });
                        });
                    }

                    // 검색 폼 제출
                    searchForm.addEventListener('submit', (e) => {
                        e.preventDefault();
                        const applied = Common.collectFromForm(searchForm);

                        // 날짜 하이픈 제거
                        if (applied.sttDt) applied.sttDt = onlyDigits(applied.sttDt);
                        if (applied.endDt) applied.endDt = onlyDigits(applied.endDt);

                        Common.reloadList({
                            page: 0,
                            defaultSortColumn: 'batTakDt',
                            swapTargets: ['#grid-tbody', '#grid-pager', '#search-count'],
                            selectSize,
                            baseUrl,
                            inputSort,
                            inputDir,
                            applied
                        });
                    });
                }
            });
        </script>

        <th:block th:replace="~{component/commonFooter :: commonFooter}"></th:block>

    </th:block>
</th:block>
</html>
<!doctype html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">

<th:block th:replace="~{component/commonHead :: layout(~{::content})}">
    <th:block th:fragment="content">

        <section class="section" th:object="${detail}">
            <div class="section-header">
                <div class="title-wrap">
                    <h3 class="section-title">지원서비스상세관리</h3>
                </div>

                <form>
                    <!-- VO 필드 매핑 -->
                    <input type="hidden" name="tpwSvcId" th:value="*{tpwSvcId}">

                    <div class="flex">
                        <div>
                            <div class="box-wrap">
                                <div class="box">
                                    <p class="field-title">기관코드</p>
                                    <input class="dp-input text-field" type="text" name="orgCd" th:value="*{orgCd}">
                                </div>
                                <div class="box">
                                    <p class="field-title">회계거래처번호</p>
                                    <input class="dp-input text-field" type="text" name="acngTrdpNo" th:value="*{acngTrdpNo}">
                                </div>
                            </div>

                            <div class="box-wrap">
                                <div class="box">
                                    <p class="field-title">서비스명</p>
                                    <input class="dp-input text-field" type="text" name="tpwSvcNm" th:value="*{tpwSvcNm}">
                                </div>
                                <div class="box">
                                    <p class="field-title">은행이체내용</p>
                                    <input class="dp-input text-field" type="text" name="bnkTrnCtt" th:value="*{bnkTrnCtt}">
                                </div>
                            </div>

                            <div class="box-wrap">
                                <div class="box">
                                    <p class="field-title">서비스기간</p>
                                    <th:block th:replace="~{page/commonFragment/datepicker :: periodFixed}"></th:block>
                                </div>
                            </div>

                            <div class="box-wrap">
                                <div class="box">
                                    <p class="field-title">사용여부</p>
                                    <div class="dropdown is-placeholder" data-name="useYn">
                                        <button aria-expanded="false" aria-haspopup="listbox"
                                                aria-label="사용여부 드롭다운"
                                                class="dropdown_button" type="button">
                                            <span class="dropdown_value"
                                                  th:text="*{useYn != null ? useYn : '선택하세요'}">
                                                선택
                                            </span>
                                        </button>
                                        <ul class="dropdown_list" role="listbox" tabindex="-1">
                                            <li class="dropdown_option" data-value="Y" role="option">Y</li>
                                            <li class="dropdown_option" data-value="N" role="option">N</li>
                                        </ul>
                                        <input name="useYn" type="hidden" th:value="*{useYn}">
                                    </div>
                                </div>

                                <div class="box">
                                    <p class="field-title">주민등록번호체크여부</p>
                                    <div class="dropdown is-placeholder" data-name="krnChecYn">
                                        <button aria-expanded="false" aria-haspopup="listbox"
                                                aria-label="주민등록번호체크여부 드롭다운"
                                                class="dropdown_button" type="button">
                                            <span class="dropdown_value" data-placeholder="선택하세요"
                                                  th:text="*{krnChecYn}">
                                                선택하세요
                                            </span>
                                        </button>
                                        <ul class="dropdown_list" role="listbox" tabindex="-1">
                                            <li class="dropdown_option" data-value="Y" role="option">Y</li>
                                            <li class="dropdown_option" data-value="N" role="option">N</li>
                                        </ul>
                                        <input name="krnChecYn" type="hidden" th:value="*{krnChecYn}">
                                    </div>
                                </div>
                            </div>

                            <div class="box-wrap">
                                <div class="box">
                                    <p class="field-title">지원서비스내용</p>
                                    <div class="textarea-box">
                                        <textarea name="tpwSvcCtt" th:text="*{tpwSvcCtt}"></textarea>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </form>

                <div class="btn-wrap">
                    <!-- 등록/수정 버튼 -->
                    <button class="btn btn-primary btn-save" type="button"
                            th:text="${tpwOrgNm != null ? '수정' : '등록'}">
                        버튼
                    </button>
                    <button class="btn btn-dark-line" type="button">목록</button>
                </div>
            </div>

            <div class="section-content">
                <div class="flex justify-space-between">
                    <b>서비스 유형 목록: <span th:text="*{svcTypList != null ? #lists.size(svcTypList) : 0}">0</span>건</b>


                    <div class="flex col-">
                        <a class="btn btn-primary btn-icon-left"
                           th:href="@{/spfnsprtmng/payinf/newSprtSvcTypForm.do(tpwSvcId=*{tpwSvcId})}"
                           th:if="*{tpwSvcId != null}">
                            신규등록
                        </a>
                        <a type="button" class="btn btn-primary btn-icon-left" href="/spfnsprtmng/payinf/exportSprtSvcInfDetail">
                            엑셀 다운로드 <i class="icon icon-save"></i>
                        </a>
                    </div>
                </div>
            </div>

                <div class="table-wrap mt20">
                    <table class="table">
                        <caption class="blind">서비스 유형 목록 테이블</caption>
                        <colgroup>
                            <col width="80px">
                            <col width="150px">
                            <col width="200px">
                            <col width="150px">
                            <col width="150px">
                            <col width="80px">
                            <col width="150px">
                        </colgroup>
                        <thead>
                        <tr>
                            <th scope="col">순번</th>
                            <th scope="col">유형 ID</th>
                            <th scope="col">유형명</th>
                            <th scope="col">정산주기</th>
                            <th scope="col">이월구분</th>
                            <th scope="col">지원중복</th>
                            <th scope="col">외국인지원</th>
                            <th scope="col">다인승제외</th>
                            <th scope="col">사용여부</th>
                        </tr>
                        </thead>
                        <tbody>
                        <tr th:if="*{svcTypList == null or (svcTypList != null and #lists.isEmpty(svcTypList))}">
                            <td th:colspan="9" class="text-center">등록된 서비스 유형이 없습니다.</td>
                        </tr>

                        <tr th:each="typ, stat : *{svcTypList != null ? svcTypList : {}}" th:object="${typ}"
                            th:attr="data-tpw-svc-typ-id=*{tpwSvcTypId},data-tpw-svc-typ-sno=*{tpwSvcTypSno},data-tpw-svc-id=*{tpwSvcId}"
                            class="clickable-row">
                            <td><span th:text="${stat.count}">순번</span></td>
                            <td th:text="*{tpwSvcTypId}">유형 ID</td>
                            <td th:text="*{tpwSvcTypNm}">유형명</td>
                            <td th:text="*{tpwStlmCycDvsCd}">정산주기</td>
                            <td th:text="*{tpwCrovDvsCd}">이월구분</td>
                            <td th:text="*{sprtDplcYn}">지원중복여부</td>
                            <td th:text="*{frgnSprtYn}">외국인지원</td>
                            <td th:text="*{trdNcntLtnAdptYn}">다인승제외</td>
                            <td th:text="*{useYn}">사용여부</td>
                        </tr>
                        </tbody>
                    </table>
                </div>

                <!-- 페이징 -->
                <div class="mt20" id="grid-pager">
                    <th:block th:replace="~{component/pagination :: pager(pageData=${SvcTypList})}"></th:block>
                </div>
            </div>
        </section>

        <th:block th:replace="~{component/commonFooter :: commonFooter}"></th:block>

        <script th:inline="javascript">

            function formatYmd ( str )
            {
                // 문자열 기준으로 자름
                const y = str . slice ( 0 , 4 );
                const m = str . slice ( 4 , 6 );
                const d = str . slice ( 6 , 8 );

                return `${ y }-${ m }-${ d }`;
            }

            /* 날짜 초기화 */
            document.addEventListener('DOMContentLoaded', function () {
                const detail = /*[[${detail}]]*/ {};

                const stt = document.getElementById('sttDt');
                const end = document.getElementById('endDt');

                if (stt) stt.value = formatYmd(detail.tpwSvcSttDt) || '';
                if (end) end.value = formatYmd(detail.tpwSvcEndDt) || '';

                const svcCtt = document.querySelector('textarea[name="tpwSvcCtt"]');
                if (svcCtt) svcCtt.value = detail.tpwSvcCtt || '';

                // 사용여부, 주민등록번호 체크여부 선택채우기
                // useYn krnChecYn
                setTimeout(()=>{
                    const arr = ['useYn','krnChecYn'];
                    for (const k of arr) {
                        const target = document.querySelector(`[data-name="${k}"] [data-value="${detail[k]}"]`);
                        const ev = new MouseEvent('click', {
                            bubbles: true,
                            cancelable: true,
                            view: window
                        });
                        target.dispatchEvent(ev);
                    }
                }, 100);


                document.querySelectorAll('.clickable-row').forEach(row => {
                    row.addEventListener('click', function () {
                        const tpwSvcTypId = this.dataset.tpwSvcTypId;
                        const tpwSvcTypSno = this.dataset.tpwSvcTypSno;
                        const tpwSvcId = this.dataset.tpwSvcId;

                        const url = `/spfnsprtmng/payinf/SprtSvcTypDetail.do?tpwSvcTypId=${tpwSvcTypId}&tpwSvcTypSno=${tpwSvcTypSno}&tpwSvcId=${tpwSvcId}`;
                        window.location.href = url;
                    });
                });
            });
        </script>

        <script>
            const onlyDigits = s => (s || '').replace(/\D+/g, '');

            document.querySelector('.btn-save').addEventListener('click', async function (e) {
                e.preventDefault();
                const form = document.querySelector('form');
                const data = Common.collectFromForm(form);
            
                data.tpwSvcSttDt = form.querySelector('#sttDt').value;
                data.tpwSvcEndDt = form.querySelector('#endDt').value;
                
                ['tpwSvcSttDt','tpwSvcEndDt'].map(k => {
                    if (data[k]) data[k] = onlyDigits(data[k]);
                });

                const isNew = location.pathname.includes('/new');
                const url = isNew ? '/spfnsprtmng/payinf/Sprtsvcptinfadd.do'
                                  : '/spfnsprtmng/payinf/Sprtsvcptinfupdate.do'
                const method = isNew ? 'POST' : 'PUT';

                const res = await Common.sendSafe(url, { method, data });
                if (res.ok) location.href = "/spfnsprtmng/payinf/sprtSvcPtInf.do";
                else modalShow({ title: '경고', message: '에러', buttons: ['close'] });
            });
        </script>

    </th:block>
</th:block>

</html>

<!doctype html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">

<th:block th:replace="~{component/commonHead :: layout(~{::content})}">
    <th:block th:fragment="content">

        <script type="text/javascript">
            function goPage(page) {
                console.log("ğŸš€ ìƒì„¸ í•˜ìœ„ ëª©ë¡ í˜ì´ì§€ ì´ë™: " + page);

                const urlParams = new URLSearchParams(window.location.search);
                urlParams.set('page', page); // í˜ì´ì§€ ë²ˆí˜¸ ì—…ë°ì´íŠ¸
                window.location.search = urlParams.toString(); // URL ì´ë™ (ìƒˆë¡œê³ ì¹¨)
            }
        </script>

        <section class="section" th:object="${detail}">
            <div class="section-header">
                <div class="title-wrap">
                    <h3 class="section-title">ì§€ì›ì„œë¹„ìŠ¤ìƒì„¸ê´€ë¦¬</h3>
                </div>

                <form id="detailForm">
                    <input type="hidden" name="tpwSvcId" th:value="*{tpwSvcId}">
                    <div class="flex">
                        <div>
                            <div class="box-wrap">
                                <div class="box">
                                    <p class="field-title">ê¸°ê´€ì½”ë“œ</p>
                                    <input class="dp-input text-field" type="text" name="orgCd"
                                           th:value="*{orgCd}"
                                           th:readonly="${detail?.tpwSvcId != null}">
                                </div>
                                <div class="box">
                                    <p class="field-title">íšŒê³„ê±°ë˜ì²˜ë²ˆí˜¸</p>
                                    <input class="dp-input text-field" type="text" name="acngTrdpNo" th:value="*{acngTrdpNo}">
                                </div>
                            </div>

                            <div class="box-wrap">
                                <div class="box">
                                    <p class="field-title">ì„œë¹„ìŠ¤ëª…</p>
                                    <input class="dp-input text-field" type="text" name="tpwSvcNm" th:value="*{tpwSvcNm}">
                                </div>
                                <div class="box">
                                    <p class="field-title">ì€í–‰ì´ì²´ë‚´ìš©</p>
                                    <input class="dp-input text-field" type="text" name="bnkTrnCtt" th:value="*{bnkTrnCtt}">
                                </div>
                            </div>

                            <div class="box-wrap">
                                <div class="box">
                                    <p class="field-title">ì„œë¹„ìŠ¤ê¸°ê°„</p>
                                    <th:block th:replace="~{page/commonFragment/datepicker :: periodFixed}"></th:block>
                                </div>
                            </div>
                            <div class="box-wrap">
                                <div class="box">
                                    <p class="field-title">type(í™”ë©´ê²½ë¡œ)</p>
                                    <input class="dp-input text-field" type="text" name="tpwSvcScrnPathNm" th:value="*{tpwSvcScrnPathNm}">
                                </div>
                            </div>

                            <div class="box-wrap">
                                <div class="box">
                                    <p class="field-title">ì‚¬ìš©ì—¬ë¶€</p>
                                    <div class="dropdown is-placeholder" data-name="useYn">
                                        <button aria-expanded="false" aria-haspopup="listbox"
                                                aria-label="ì‚¬ìš©ì—¬ë¶€ ë“œë¡­ë‹¤ìš´"
                                                class="dropdown_button" type="button">
                                            <span class="dropdown_value"
                                                  th:text="*{useYn != null ? useYn : 'ì„ íƒí•˜ì„¸ìš”'}">
                                                ì„ íƒ
                                            </span>
                                        </button>
                                        <ul class="dropdown_list" role="listbox" tabindex="-1">
                                            <li class="dropdown_option" data-value="Y" role="option">Y</li>
                                            <li class="dropdown_option" data-value="N" role="option">N</li>
                                        </ul>
                                        <input name="useYn" type="hidden" th:value="*{useYn}">
                                    </div>
                                </div>

                                <div class="box">
                                    <p class="field-title">ì£¼ë¯¼ë“±ë¡ë²ˆí˜¸ì²´í¬ì—¬ë¶€</p>
                                    <div class="dropdown is-placeholder" data-name="krnChecYn">
                                        <button aria-expanded="false" aria-haspopup="listbox"
                                                aria-label="ì£¼ë¯¼ë“±ë¡ë²ˆí˜¸ì²´í¬ì—¬ë¶€ ë“œë¡­ë‹¤ìš´"
                                                class="dropdown_button" type="button">
                                            <span class="dropdown_value" data-placeholder="ì„ íƒí•˜ì„¸ìš”"
                                                  th:text="*{krnChecYn}">
                                                ì„ íƒí•˜ì„¸ìš”
                                            </span>
                                        </button>
                                        <ul class="dropdown_list" role="listbox" tabindex="-1">
                                            <li class="dropdown_option" data-value="Y" role="option">Y</li>
                                            <li class="dropdown_option" data-value="N" role="option">N</li>
                                        </ul>
                                        <input name="krnChecYn" type="hidden" th:value="*{krnChecYn}">
                                    </div>
                                </div>
                            </div>

                            <div class="box-wrap">
                                <div class="box">
                                    <p class="field-title">ì§€ì›ì„œë¹„ìŠ¤ë‚´ìš©</p>
                                    <div class="textarea-box">
                                        <textarea name="tpwSvcCtt" th:text="*{tpwSvcCtt}"></textarea>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </form>

                <div class="btn-wrap">
                    <button class="btn btn-primary btn-save" type="button"
                            th:text="${detail?.tpwSvcId != null ? 'ìˆ˜ì •' : 'ë“±ë¡'}">
                        ë“±ë¡
                    </button>
                    <button class="btn btn-dark-line" type="button"
                            onclick="window.location.href='/spfnsprtmng/payinf/sprtSvcPtInf.do';">
                        ëª©ë¡
                    </button>
                </div>
            </div>

            <div class="section-content">
                <div class="flex justify-space-between">
                    <b>ì„œë¹„ìŠ¤ ìœ í˜• ëª©ë¡: <span th:text="${svcTypPage != null ? svcTypPage.total : 0}">0</span>ê±´</b>

                    <div class="flex col-">
                        <a class="btn btn-primary btn-icon-left"
                           th:href="@{/spfnsprtmng/payinf/newSprtSvcTypForm.do(tpwSvcId=*{tpwSvcId}, orgCd=*{orgCd})}"
                           th:if="*{tpwSvcId != null}">
                            ì‹ ê·œë“±ë¡
                        </a>
                        <button type="button" class="btn btn-secondary btn-icon-left"
                                data-export="xlsx"
                                data-provider="ì§€ì›ì„œë¹„ìŠ¤ìƒì„¸ê´€ë¦¬">
                            ì—‘ì…€ ë‹¤ìš´ë¡œë“œ
                            <i class="icon icon-save"></i>
                        </button>
                    </div>
                </div>

                <div class="table-wrap mt20">
                    <table class="table">
                        <caption class="blind">ì„œë¹„ìŠ¤ ìœ í˜• ëª©ë¡ í…Œì´ë¸”</caption>
                        <colgroup>
                            <col width="80px">
                            <col width="150px">
                            <col width="200px">
                            <col width="150px">
                            <col width="150px">
                            <col width="80px">
                            <col width="150px">
                        </colgroup>
                        <thead>
                        <tr>
                            <th scope="col">ìˆœë²ˆ</th>
                            <th scope="col">ìœ í˜• ID</th>
                            <th scope="col">ìœ í˜•ëª…</th>
                            <th scope="col">ì •ì‚°ì£¼ê¸°</th>
                            <th scope="col">ì´ì›”êµ¬ë¶„</th>
                            <th scope="col">ì§€ì›ì¤‘ë³µ</th>
                            <th scope="col">ì™¸êµ­ì¸ì§€ì›</th>
                            <th scope="col">ë‹¤ì¸ìŠ¹ì œì™¸</th>
                            <th scope="col">ì‚¬ìš©ì—¬ë¶€</th>
                        </tr>
                        </thead>
                        <tbody>
                        <tr th:if="${svcTypPage == null or svcTypPage.content == null or #lists.isEmpty(svcTypPage.content)}">
                            <td th:colspan="9" class="text-center">ë“±ë¡ëœ ì„œë¹„ìŠ¤ ìœ í˜•ì´ ì—†ìŠµë‹ˆë‹¤.</td>
                        </tr>

                        <tr th:each="typ, stat : ${svcTypPage.content}"
                            th:if="${svcTypPage != null and svcTypPage.content != null}"
                            th:attr="data-tpw-svc-typ-id=${typ.tpwSvcTypId},data-tpw-svc-typ-sno=${typ.tpwSvcTypSno},data-tpw-svc-id=${typ.tpwSvcId}"
                            class="clickable-row">

                            <td th:text="${stat.count + (svcTypPage.page * svcTypPage.size)}">ìˆœë²ˆ</td>
                            <td th:text="${typ.tpwSvcTypId}">ìœ í˜• ID</td>
                            <td th:text="${typ.tpwSvcTypNm}">ìœ í˜•ëª…</td>
                            <td th:text="${typ.tpwStlmCycDvsCd}">ì •ì‚°ì£¼ê¸°</td>
                            <td th:text="${typ.tpwCrovDvsCd}">ì´ì›”êµ¬ë¶„</td>
                            <td th:text="${typ.sprtDplcYn}">ì§€ì›ì¤‘ë³µì—¬ë¶€</td>
                            <td th:text="${typ.frgnSprtYn}">ì™¸êµ­ì¸ì§€ì›</td>
                            <td th:text="${typ.trdNcntLtnAdptYn}">ë‹¤ì¸ìŠ¹ì œì™¸</td>
                            <td th:text="${typ.useYn}">ì‚¬ìš©ì—¬ë¶€</td>
                        </tr>
                        </tbody>
                    </table>
                </div>

                <div class="mt20" id="grid-pager" th:if="${svcTypPage != null and svcTypPage.total > 0}">
                    <th:block th:replace="~{component/pagination :: pager(pageData=${svcTypPage}, linkFunc='goPage')}"></th:block>
                </div>
            </div>
        </section>

        <th:block th:replace="~{component/commonFooter :: commonFooter}"></th:block>

        <script th:inline="javascript">

            /* 2. ìœ í‹¸ë¦¬í‹° í•¨ìˆ˜ */
            function formatYmd(str) {
                if (!str) return '';
                const y = str.slice(0, 4);
                const m = str.slice(4, 6);
                const d = str.slice(6, 8);
                return `${y}-${m}-${d}`;
            }
            const onlyDigits = s => (s || '').replace(/\D+/g, '');

            /* 3. DOM ë¡œë“œ í›„ ì´ˆê¸°í™” ë° ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ */
            document.addEventListener('DOMContentLoaded', function () {

                // [í•µì‹¬] í˜ì´ì§• ë²„íŠ¼ í´ë¦­ ì´ë²¤íŠ¸ í•¸ë“¤ëŸ¬ (ê°•ì œ ì£¼ì…)
                const pager = document.getElementById('grid-pager');

                if (pager) {
                    pager.addEventListener('click', function(e) {
                        // í´ë¦­ëœ ìš”ì†Œê°€ .pager-item, button, a íƒœê·¸ì¸ì§€ í™•ì¸
                        const target = e.target.closest('.pager-item, button, a');
                        if (!target) return;

                        e.preventDefault(); // ê¸°ë³¸ ë§í¬ ë™ì‘ ë°©ì§€

                        // 1. data-page ì†ì„±ì´ ìˆëŠ”ì§€ í™•ì¸ (ê°€ì¥ ì •í™•)
                        const dataPage = target.getAttribute('data-page');

                        if (dataPage !== null && dataPage !== undefined) {
                            console.log("data-pageë¡œ ì´ë™: " + dataPage);
                            goPage(dataPage); // 0-based index ê·¸ëŒ€ë¡œ ì „ì†¡
                        }
                        else {
                            // 2. í…ìŠ¤íŠ¸ë‚˜ í´ë˜ìŠ¤ë¡œ íŒë‹¨ (ì´ì „/ë‹¤ìŒ ë“±)
                            const text = target.innerText.trim();
                            const urlParams = new URLSearchParams(window.location.search);
                            const current = parseInt(urlParams.get('page') || 0);

                            if (text.includes('>') || target.className.includes('next')) {
                                goPage(current + 1);
                            } else if (text.includes('<') || target.className.includes('prev')) {
                                if (current > 0) goPage(current - 1);
                            } else if (!isNaN(text)) {
                                goPage(parseInt(text) - 1); // í…ìŠ¤íŠ¸ê°€ ìˆ«ìë¼ë©´ (1 -> 0í˜ì´ì§€)
                            }
                        }
                    });
                }

                // í¼ ë°ì´í„° ë°”ì¸ë”©
                const detail = /*[[${detail}]]*/ {};
                const stt = document.getElementById('sttDt');
                const end = document.getElementById('endDt');

                if (detail) {
                    if (stt && detail.tpwSvcSttDt) stt.value = formatYmd(detail.tpwSvcSttDt);
                    if (end && detail.tpwSvcEndDt) end.value = formatYmd(detail.tpwSvcEndDt);
                    const svcCtt = document.querySelector('textarea[name="tpwSvcCtt"]');
                    if (svcCtt) svcCtt.value = detail.tpwSvcCtt || '';
                }

                setTimeout(() => {
                    const arr = ['useYn', 'krnChecYn'];
                    for (const k of arr) {
                        if (detail && detail[k]) {
                            const target = document.querySelector(`[data-name="${k}"] [data-value="${detail[k]}"]`);
                            if (target) {
                                const ev = new MouseEvent('click', { bubbles: true, cancelable: true, view: window });
                                target.dispatchEvent(ev);
                            }
                        }
                    }
                }, 100);
            });

            /* 4. ì €ì¥ ë²„íŠ¼ í´ë¦­ ì´ë²¤íŠ¸ */
            const saveBtn = document.querySelector('.btn-save');
            if(saveBtn){
                saveBtn.addEventListener('click', async function (e) {
                    e.preventDefault();
                    const form = document.querySelector('form');
                    const data = Common.collectFromForm(form);
                    const sttEl = form.querySelector('#sttDt');
                    const endEl = form.querySelector('#endDt');
                    if(sttEl) data.tpwSvcSttDt = onlyDigits(sttEl.value);
                    if(endEl) data.tpwSvcEndDt = onlyDigits(endEl.value);

                    const isNew = location.pathname.includes('/new') || !data.tpwSvcId;
                    const url = isNew ? '/spfnsprtmng/payinf/Sprtsvcptinfadd.do' : '/spfnsprtmng/payinf/Sprtsvcptinfupdate.do';
                    const method = isNew ? 'POST' : 'PUT';

                    const res = await Common.sendSafe(url, { method, data });

                    if (res.ok) {
                        alert('ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.');
                        if (isNew) {
                            try {
                                const resultData = await res.json();
                                location.href = `/spfnsprtmng/payinf/sprtSvcInfDetail.do?orgCd=${resultData.orgCd}&tpwSvcId=${resultData.tpwSvcId}`;
                            } catch (err) {
                                location.href = "/spfnsprtmng/payinf/sprtSvcPtInf.do";
                            }
                        } else {
                            const currentOrgCd = form.querySelector('input[name="orgCd"]').value;
                            const currentSvcId = form.querySelector('input[name="tpwSvcId"]').value;
                            const urlParams = new URLSearchParams(window.location.search);
                            const currentPage = urlParams.get('page') || 0;

                            // ì €ì¥ í›„ í˜„ì¬ í˜ì´ì§€ ìœ ì§€
                            location.href = `/spfnsprtmng/payinf/sprtSvcInfDetail.do?orgCd=${currentOrgCd}&tpwSvcId=${currentSvcId}&page=${currentPage}`;
                        }
                    } else {
                        const errorText = await res.text().catch(() => 'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜');
                        modalShow({ title: 'ê²½ê³ ', message: `ì €ì¥ ì‹¤íŒ¨: ${errorText}`, buttons: ['close'] });
                    }
                });
            }

            /* 5. í•˜ìœ„ ìœ í˜• í´ë¦­ ì´ë²¤íŠ¸ */
            const clickableRows = document.querySelectorAll('.clickable-row');
            clickableRows.forEach(row => {
                row.addEventListener('click', function () {
                    const tpwSvcTypId = this.dataset.tpwSvcTypId;
                    const tpwSvcTypSno = this.dataset.tpwSvcTypSno;
                    const tpwSvcId = this.dataset.tpwSvcId;
                    const url = `/spfnsprtmng/payinf/SprtSvcTypDetail.do?tpwSvcTypId=${tpwSvcTypId}&tpwSvcTypSno=${tpwSvcTypSno}&tpwSvcId=${tpwSvcId}`;
                    window.location.href = url;
                });
            });

            /* 6. ì—‘ì…€ ë‹¤ìš´ë¡œë“œ ì´ë²¤íŠ¸ */
            const exportHandler = (e) => {
                const exportBtn = e.target.closest('button[data-export="xlsx"]');
                if(!exportBtn) return;
                const searchParams = new URLSearchParams(window.location.search);
                const form = document.createElement('form');
                for (const [key, value] of searchParams.entries()) {
                    const input = document.createElement('input');
                    input.type = 'text';
                    input.name = key;
                    input.id = key;
                    input.value = value;
                    form.appendChild(input);
                }
                const payload = {};
                Common.bindExcelExport(form, exportBtn, null, null, 'tpwSvcTypId', payload);
                setTimeout(() => {
                    const loading = document.getElementById('mini-sp-loading');
                    if(loading) loading.style.display = 'none';
                }, 1000);
            };
            document.body.addEventListener('click', exportHandler);

        </script>

    </th:block>
</th:block>
</html>
<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org" xmlns="http://www.w3.org/1999/xhtml">
<body>

<th:block th:replace="~{component/commonHead :: layout(~{::content})}">
    <th:block th:fragment="content">
        <script th:src="@{/js/datepicker.js}"></script>
        <link rel="stylesheet" th:href="@{/css/page/page.css}"/>

        <style>
            .hide { display: none; }
            .table-vertical th { width: 10em; }
            .disabled { background-color: #f5f5f5; cursor: not-allowed; }
            .date-field-wrap { display: flex; align-items: center; }
        </style>

        <section class="section" id="grid">
            <!-- 검색 폼 -->
            <form class="section-header" th:object="${req}" id="searchForm">
                <div class="title-wrap">
                    <h3 class="section-title">수기정산내역조회</h3>
                </div>

                <div class="box-wrap">
                    <div class="box">
                        <p class="field-title">서비스 선택</p>
                        <th:block th:replace="~{common/fragment/dropdowns ::cascadingDropdown('svcOnlyRoot', 'tpwSvcId', 'tpwSvcTypId', true)}"></th:block>
                    </div>
                </div>

                <div class="box-wrap">
                    <div class="box">
                        <p class="field-title">요청기간</p>
                        <div class="dropdown" data-name="searchType">
                            <button aria-expanded="false" aria-haspopup="listbox" aria-label="요청기간 드롭다운"
                                    class="dropdown_button" type="button">
                                <span class="dropdown_value" data-placeholder="선택하세요" value="">선택하세요</span>
                            </button>
                            <ul class="dropdown_list" role="listbox" tabindex="-1">
                                <li role="option" class="dropdown_option" th:field="*{reqDtm}">요청일자</li>
                                <li role="option" class="dropdown_option" th:field="*{prcgDt}">처리일자</li>
                            </ul>
                            <input type="hidden" name="searchType" value="" id="searchType">
                        </div>
                    </div>
                    <div class="box date-field-wrap">
                        <th:block th:replace="~{page/commonFragment/datepicker :: periodFixed}"></th:block>
                    </div>
                </div>

                <div class="box-wrap">
                    <div class="box">
                        <p class="field-title">전체</p>
                        <div class="dropdown" data-name="searchType">
                            <button aria-expanded="false" aria-haspopup="listbox" aria-label="검색 드롭다운"
                                    class="dropdown_button" type="button">
                                <span class="dropdown_value" data-placeholder="선택하세요" value="">선택하세요</span>
                            </button>
                            <ul class="dropdown_list" role="listbox" tabindex="-1">
                                <li role="option" class="dropdown_option" th:field="*{mbrsId}">회원ID</li>
                                <li role="option" class="dropdown_option" th:field="*{mbrsNm}">회원명</li>
                            </ul>
                        </div>
                        <input type="hidden" name="department" value="">
                        <input type="hidden" th:field="*{searchType}">
                    </div>

                    <div class="box">
                        <p class="field-title">검색어</p>
                        <input class="text-field keyword-search" th:value="*{keyword}" type="search" placeholder="검색어를 입력하세요">
                    </div>
                </div>

                <div class="box-wrap">
                    <div class="box">
                        <p class="field-title">처리상태</p>
                        <div class="dropdown" data-name="tpwMemrPrcgStaCd">
                            <button aria-expanded="false" aria-haspopup="listbox" aria-label="처리상태 드롭다운"
                                    class="dropdown_button" type="button">
                                <span class="dropdown_value" data-placeholder="선택하세요" value="">선택하세요</span>
                            </button>
                            <ul class="dropdown_list" role="listbox" tabindex="-1">
                                <li role="option" class="dropdown_option" th:data-value="01">요청</li>
                                <li role="option" class="dropdown_option" th:data-value="02">승인</li>
                                <li role="option" class="dropdown_option" th:data-value="03">반려</li>
                            </ul>
                            <input type="hidden" name="tpwMemrPrcgStaCd" value="" id="tpwMemrPrcgStaCd">
                        </div>
                    </div>

                    <div class="box" th:if="${orgCd == '000000'}">
                        <p class="field-title">기관코드</p>
                        <input class="text-field" maxlength="7" th:field="*{orgCd}" placeholder="기관코드 입력" type="search">
                    </div>
                    <div class="box">
                        <p class="field-title">행정동</p>
                        <input class="text-field" th:field="*{addoNm}" maxlength="100" placeholder="행정동 입력" type="search">
                    </div>
                </div>

                <div class="btn-wrap">
                    <input type="text" class="text-field" placeholder="금액 입력" style="width: 120px;">
                    <button type="button" class="btn btn-secondary">선택한도금액입력</button>

                    <button type="button" class="btn btn-secondary">선택승인</button>
                    <button type="button" class="btn btn-dark-line">업로드</button>

                    <button type="button" class="btn btn-primary btn-icon-left"
                            data-export="xlsx"
                            data-provider="수기정산내역조회">
                        엑셀 다운로드 <i class="icon icon-save"></i>
                    </button>
                    <button class="btn btn-primary btn-icon-left" type="submit">검색 <i class="icon icon-search"></i></button>
                </div>
                <input th:field="*{sort}" type="hidden">
                <input th:field="*{dir}" type="hidden">
            </form>

            <div style="display: flex; flex-direction: column; gap: 20px;">

                <!-- 리스트 영역 -->
                <div class="section-content mt20">
                    <div class="flex justify-space-between align-center" id="grid-header" th:object="${pageData}">
                        <b th:text="'검색 결과 : ' + *{total} + '건'"></b>
                        <div>
                            <button type="button" class="btn btn-blue" id="btnAddRow">행추가</button>
                            <button type="button" class="btn btn-red" id="btnDel">행삭제</button>
                        </div>
                    </div>

                    <div class="table-wrap mt20">
                        <table class="table" id="data-table">
                            <caption class="blind">교통비 사용내역 조회 테이블</caption>
                            <colgroup>
                                <col width="50px">
                                <col width="150px">
                                <col width="150px">
                                <col width="200px">
                                <col width="150px">
                                <col width="250px">
                                <col width="150px">
                                <col width="300px">
                                <col width="150px">
                                <col width="150px">
                                <col width="150px">
                                <col width="150px">
                                <col width="150px">
                            </colgroup>
                            <thead id="grid-head">
                            <tr>
                                <th scope="col">
                                    <input type="checkbox" id="chkAll" title="전체 선택">
                                </th>
                                <th scope="col">순번</th>
                                <th class="sort-header" scope="col"><a data-sort="mbrs_id">회원ID</a></th>
                                <th class="sort-header" scope="col"><a data-sort="mbrs_nm">회원명</a></th>
                                <th class="sort-header" scope="col"><a data-sort="tpw_mbrs_svc_sta_cd">회원상태</a></th>
                                <th class="sort-header" scope="col" th:if="${orgCd != null and orgCd != '' and orgCd == '000000'}">
                                    <a data-sort="tpw_svc_nm">서비스명</a></th>
                                <th class="sort-header" scope="col" th:if="${orgCd != null and orgCd != '' and orgCd == '000000'}">
                                    <a data-sort="tpw_svc_typ_nm">서비스유형명</a></th>
                                <th class="sort-header" scope="col" th:if="${orgCd != null and orgCd != '' and orgCd == '000000'}">
                                    <a data-sort="tpw_svc_typ_sno">서비스일련번호</a>
                                </th>

                                <th class="sort-header" scope="col"><a data-sort="addo_nm">행정동명</a></th>
                                <th class="sort-header" scope="col"><a data-sort="req_dtm">요청일자</a></th>
                                <th class="sort-header" scope="col"><a data-sort="prcg_dt">처리일자</a></th>

                                <th class="sort-header" scope="col"><a data-sort="tpw_memr_prcg_sta_cd">처리상태</a></th>

                                <th class="sort-header" scope="col"><a data-sort="apl_amt">요청금액</a></th>
                            </tr>
                            </thead>
                            <tbody id="grid-tbody">
                            <th:block th:each="u, stat : ${pageData.content}"
                                      th:with="base=${(pageData.page) * pageData.size}" th:if="${pageData != null and pageData.total > 0}" th:object="${u}">
                                <tr th:if="${u != null}">
                                    <!-- Hidden Inputs -->
                                    <input type="hidden" name="grid_mbrsId" th:value="*{mbrsId}" />
                                    <input type="hidden" name="grid_mbrsNm" th:value="*{mbrsNm}" />
                                    <input type="hidden" name="grid_tpwMbrsSvcStaCd" th:value="*{tpwMbrsSvcStaCd}" />
                                    <input type="hidden" name="grid_addoNm" th:value="*{addoNm}" />
                                    <input type="hidden" name="grid_acctNo" th:value="*{acctNo}" />
                                    <input type="hidden" name="grid_tpwSvcId" th:value="*{tpwSvcId}" />
                                    <input type="hidden" name="grid_tpwSvcNm" th:value="*{tpwSvcNm}" />
                                    <input type="hidden" name="grid_tpwSvcTypId" th:value="*{tpwSvcTypId}" />
                                    <input type="hidden" name="grid_tpwSvcTypNm" th:value="*{tpwSvcTypNm}" />
                                    <input type="hidden" name="grid_tpwSvcTypSno" th:value="*{tpwSvcTypSno}" />
                                    <input type="hidden" name="grid_reqDtm" th:value="*{reqDtm}" />
                                    <input type="hidden" name="grid_payPrcgYn" th:value="*{payPrcgYn}" />
                                    <input type="hidden" name="grid_prcgDt" th:value="*{prcgDt}" />
                                    <input type="hidden" name="grid_aplAmt" th:value="*{aplAmt}" />
                                    <input type="hidden" name="grid_payAmt" th:value="*{payAmt}" />
                                    <input type="hidden" name="grid_manualPrcgSta" th:value="*{manualPrcgSta}" />
                                    <input type="hidden" name="grid_tpwMemrPrcgStaCd" th:value="*{tpwMemrPrcgStaCd}" />

                                    <td>
                                        <input type="checkbox" name="chk" th:value="*{mbrsId}" title="선택">
                                    </td>
                                    <td th:text="${base + stat.index+1}"></td>
                                    <td th:text="*{mbrsId}"></td>
                                    <td th:text="*{mbrsNm}"></td>
                                    <td th:text="*{tpwMbrsSvcStaCd == '00' ? '정상'
                                                : tpwMbrsSvcStaCd == '01' ? '휴면'
                                                : tpwMbrsSvcStaCd == '03' ? '탈퇴'
                                                : '' }"></td>
                                    <td th:if="${orgCd != null and orgCd != '' and orgCd == '000000'}"
                                        th:text="*{tpwSvcNm}"></td>
                                    <td th:if="${orgCd != null and orgCd != '' and orgCd == '000000'}"
                                        th:text="*{tpwSvcTypNm}"></td>
                                    <td th:if="${orgCd != null and orgCd != '' and orgCd == '000000'}"
                                        th:text="*{tpwSvcTypSno}"></td>

                                    <td th:text="*{addoNm}"></td>
                                    <td th:text="*{reqDtm}"></td>
                                    <td th:text="*{prcgDt}"></td>

                                    <td th:text="*{tpwMemrPrcgStaCd == '01' ? '요청'
                                                : tpwMemrPrcgStaCd == '02' ? '승인'
                                                : tpwMemrPrcgStaCd == '03' ? '반려'
                                                : '' }"></td>

                                    <td th:text="*{aplAmt}"></td>
                                </tr>
                            </th:block>

                            <th:block th:unless="${pageData != null and pageData.total > 0}">
                                <tr th:if="${orgCd == '000000'}">
                                    <td colspan="13" aria-live="polite" class="colspan-11">
                                        조회 결과가 없습니다.
                                    </td>
                                </tr>
                            </th:block>
                            </tbody>
                        </table>
                    </div>

                    <div class="mt20" id="grid-pager">
                        <th:block th:replace="~{component/pagination :: pager(pageData=${pageData})}"/>
                    </div>
                </div>

                <!-- 3. 상세 입력 폼 -->
                <div class="section-content mt40" id="rowAddForm" style="display:none;">
                    <form id="detailForm">
                        <input type="hidden" id="mode" value="INSERT">
                        <input type="hidden" name="reqDtm" />
                        <input type="hidden" name="tpwSvcTypSno" />

                        <div class="table-wrap">
                            <table class="table table-vertical">
                                <caption class="blind">수기정산 상세 등록</caption>
                                <colgroup>
                                    <col style="width: 150px;">
                                    <col>
                                </colgroup>
                                <tbody>
                                <tr>
                                    <th scope="row">회원ID</th>
                                    <td><input type="text" name="mbrsId" class="text-field" placeholder="회원ID 입력" /></td>
                                </tr>
                                <tr>
                                    <th scope="row">회원명</th>
                                    <td><input type="text" name="mbrsNm" class="text-field disabled" placeholder="상세조회 시 자동입력" readonly /></td>
                                </tr>
                                <tr>
                                    <th scope="row">회원상태</th>
                                    <td><input type="text" name="tpwMbrsSvcStaCd" class="text-field disabled" placeholder="상세조회 시 자동입력" readonly /></td>
                                </tr>
                                <tr>
                                    <th scope="row">행정동</th>
                                    <td><input type="text" name="addoNm" class="text-field disabled" placeholder="상세조회 시 자동입력" readonly /></td>
                                </tr>
                                <tr>
                                    <th scope="row">이체계좌</th>
                                    <td><input type="text" name="acctNo" class="text-field" placeholder="계좌번호 입력" /></td>
                                </tr>

                                <tr>
                                    <th scope="row">서비스 선택</th>
                                    <td>
                                        <th:block th:replace="~{common/fragment/dropdowns ::cascadingDropdown('svcPair2', 'tpwSvcId', 'tpwSvcTypId', true)}"></th:block>
                                    </td>
                                </tr>

                                <tr>
                                    <th scope="row">요청일자</th>
                                    <td>
                                        <div class="date-field-wrap" style="width: 150px;">
                                            <input type="text" id="reqDt_add" name="trdDt" class="text-field date-text" placeholder="거래일자(trdDt)">
                                        </div>
                                    </td>
                                </tr>
                                <tr>
                                    <th scope="row">지급처리여부</th>
                                    <td>
                                        <div style="width:240px">
                                            <div class="dropdown" data-name="payPrcgYn">
                                                <button type="button" class="dropdown_button" aria-haspopup="listbox" aria-expanded="false">
                                                    <span class="dropdown_value" data-placeholder="선택하세요">선택하세요</span>
                                                </button>
                                                <ul class="dropdown_list" role="listbox" tabindex="-1">
                                                    <li role="option" class="dropdown_option" data-value="Y">지급</li>
                                                    <li role="option" class="dropdown_option" data-value="N">미지급</li>
                                                </ul>
                                                <input type="hidden" name="payPrcgYn" value="">
                                            </div>
                                        </div>
                                    </td>
                                </tr>
                                <tr>
                                    <th scope="row">처리일자</th>
                                    <td>
                                        <div class="date-field-wrap" style="width: 150px;">
                                            <input type="text" id="prcgDt_add" name="prcgDt" class="text-field date-text">
                                        </div>
                                    </td>
                                </tr>
                                <tr>
                                    <th scope="row">지급금액</th>
                                    <td><input type="text" name="payAmt" class="text-field" placeholder="금액 입력" /></td>
                                </tr>
                                <tr>
                                    <th scope="row">신청금액</th>
                                    <td><input type="text" name="aplAmt" class="text-field" placeholder="신청금액 입력" /></td>
                                </tr>
                                <tr>
                                    <th scope="row">수기처리상태</th>
                                    <td>
                                        <div style="width:240px">
                                            <div class="dropdown" data-name="manualPrcgSta">
                                                <button type="button" class="dropdown_button" aria-haspopup="listbox" aria-expanded="false">
                                                    <span class="dropdown_value" data-placeholder="선택하세요">선택하세요</span>
                                                </button>
                                                <ul class="dropdown_list" role="listbox" tabindex="-1">
                                                    <li role="option" class="dropdown_option" data-value="01">요청</li>
                                                    <li role="option" class="dropdown_option" data-value="02">승인</li>
                                                    <li role="option" class="dropdown_option" data-value="03">반려</li>
                                                </ul>
                                                <input type="hidden" name="manualPrcgSta" value="">
                                            </div>
                                        </div>
                                    </td>
                                </tr>
                                </tbody>
                            </table>
                        </div>

                        <div class="flex justify-end col- mt40">
                            <button type="button" id="btnNew" class="btn btn-dark-line">신규</button>
                            <button type="button" id="btnSave" class="btn btn-blue">저장</button>
                        </div>
                    </form>
                </div>
            </div>

        </section>

        <th:block th:replace="~{component/commonFooter :: commonFooter}"></th:block>

        <script data-page="memrStlmPt" th:inline="javascript" type="text/javascript">
            (function () {
                const baseUrl = 'spfnsprtmng/payinf/memrStlmPt.do';
                const grid = document.getElementById('grid');
                const head = document.getElementById('grid-head');
                const searchForm = document.getElementById('searchForm');
                const selectSize = searchForm.querySelector('select[name="size"]');
                const inputSort = document.getElementById('sort');
                const inputDir = document.getElementById('dir');
                const loading = document.getElementById('mini-sp-loading');
                const payload = {};

                const rowAddForm = document.getElementById('rowAddForm');
                const detailForm = document.getElementById('detailForm');
                const modeInput = document.getElementById('mode');
                const btnAddRow = document.getElementById('btnAddRow');
                const btnNew = document.getElementById('btnNew');
                const btnSave = document.getElementById('btnSave');
                const btnDel = document.getElementById('btnDel');

                const dateIds = ['reqDt_add', 'prcgDt_add'];
                dateIds.forEach(id => {
                    const el = document.getElementById(id);
                    if (el) el.type = 'date';
                });

                function resetDetailForm(mode) {
                    detailForm.reset();
                    modeInput.value = mode;

                    const dropdowns = detailForm.querySelectorAll('.dropdown');
                    dropdowns.forEach(dd => {
                        const valSpan = dd.querySelector('.dropdown_value');
                        const hidden = dd.querySelector('input[type="hidden"]');
                        if(valSpan) valSpan.textContent = valSpan.dataset.placeholder || '선택하세요';
                        if(hidden) hidden.value = '';
                    });

                    const pkInputs = detailForm.querySelectorAll('input[name="mbrsId"]');
                    pkInputs.forEach(input => {
                        input.readOnly = (mode === 'UPDATE');
                        if(mode === 'UPDATE') input.classList.add('disabled');
                        else input.classList.remove('disabled');
                    });

                    rowAddForm.style.display = 'block';
                    if(mode === 'INSERT') {
                        rowAddForm.scrollIntoView({ behavior: 'smooth', block: 'start' });
                    }
                }

                const handleNewClick = () => {
                    resetDetailForm('INSERT');
                };
                if(btnAddRow) btnAddRow.addEventListener('click', handleNewClick);
                if(btnNew) btnNew.addEventListener('click', handleNewClick);

                const tableBody = document.getElementById('grid-tbody');
                tableBody.addEventListener('click', (e) => {
                    if(e.target.type === 'checkbox' || e.target.closest('td:first-child')) return;

                    const tr = e.target.closest('tr');
                    if(!tr) return;

                    resetDetailForm('UPDATE');

                    const hiddens = tr.querySelectorAll('input[type="hidden"][name^="grid_"]');
                    hiddens.forEach(h => {
                        const key = h.name.replace('grid_', '');
                        const val = h.value;

                        const targetInput = detailForm.querySelector(`input[name="${key}"]:not([type="hidden"])`);
                        if(targetInput) targetInput.value = val;

                        const targetHidden = detailForm.querySelector(`input[type="hidden"][name="${key}"]`);
                        if(targetHidden && targetHidden.id !== 'mode') targetHidden.value = val;

                        const dropdown = detailForm.querySelector(`.dropdown[data-name="${key}"]`);
                        if(dropdown) {
                            const ddHidden = dropdown.querySelector(`input[name="${key}"]`);
                            const ddVal = dropdown.querySelector('.dropdown_value');

                            if(ddHidden) ddHidden.value = val;
                            const option = dropdown.querySelector(`.dropdown_option[data-value="${val}"]`);
                            if(ddVal) ddVal.textContent = option ? option.textContent : val;
                        }
                    });

                    const svcNmVal = tr.querySelector('input[name="grid_tpwSvcNm"]').value;
                    const svcTypNmVal = tr.querySelector('input[name="grid_tpwSvcTypNm"]').value;

                    const svcDdVal = detailForm.querySelector('.dropdown[data-name="tpwSvcId"] .dropdown_value');
                    const typDdVal = detailForm.querySelector('.dropdown[data-name="tpwSvcTypId"] .dropdown_value');

                    if(svcDdVal && svcNmVal) svcDdVal.textContent = svcNmVal;
                    if(typDdVal && svcTypNmVal) typDdVal.textContent = svcTypNmVal;

                    rowAddForm.style.display = 'block';
                });

                btnSave.addEventListener('click', async () => {
                    const mode = modeInput.value;
                    let url = '';
                    let method = '';
                    let confirmMsg = '';

                    if (mode === 'INSERT') {
                        url = 'spfnsprtmng/payinf/memrStlmPt/add';
                        method = 'POST';
                        confirmMsg = '등록하시겠습니까?';
                    } else {
                        url = 'spfnsprtmng/payinf/memrStlmPt/update';
                        method = 'PUT';
                        confirmMsg = '수정하시겠습니까?';
                    }

                    if(!confirm(confirmMsg)) return;

                    const data = Common.collectFromForm(detailForm);

                    // [수정 1] 날짜 포맷팅: YYYY-MM-DD -> YYYYMMDD (8자리)
                    if (data.trdDt) data.trdDt = data.trdDt.replace(/-/g, '');
                    if (data.prcgDt) data.prcgDt = data.prcgDt.replace(/-/g, '');
                    // reqDtm이 있다면 (수정 시)
                    if (data.reqDtm) data.reqDtm = data.reqDtm.replace(/-/g, '');

                    // [수정 2] 서비스유형일련번호(Sno) 누락 방지 (임시값 1)
                    // 실제로는 서비스유형 선택 시 DB 등에서 sno를 가져오는 로직 필요
                    if (!data.tpwSvcTypSno) data.tpwSvcTypSno = '1';

                    const res = await Common.sendSafe(url, {
                        method: method,
                        data: data
                    });

                    if (res && (res.ok || res.status === 200)) {
                        alert('저장되었습니다.');
                        rowAddForm.style.display = 'none';
                        searchForm.dispatchEvent(new Event('submit'));
                    }
                });

                btnDel.addEventListener('click', async () => {
                    const checkboxes = document.querySelectorAll('input[name="chk"]:checked');
                    if(checkboxes.length === 0) {
                        alert('삭제할 항목을 선택해주세요.');
                        return;
                    }

                    if(!confirm(`선택한 ${checkboxes.length}건을 삭제하시겠습니까?`)) return;

                    let successCount = 0;

                    for(const chk of checkboxes) {
                        const tr = chk.closest('tr');

                        const data = {
                            mbrsId: tr.querySelector('input[name="grid_mbrsId"]').value,
                            tpwSvcId: tr.querySelector('input[name="grid_tpwSvcId"]').value,
                            tpwSvcTypId: tr.querySelector('input[name="grid_tpwSvcTypId"]').value,
                            tpwSvcTypSno: tr.querySelector('input[name="grid_tpwSvcTypSno"]').value,
                            reqDtm: tr.querySelector('input[name="grid_reqDtm"]').value
                        };

                        const res = await Common.sendSafe('spfnsprtmng/payinf/memrStlmPt/delete', {
                            method: 'POST',
                            data: data
                        });

                        if(res && (res.ok || res.status === 200)) {
                            successCount++;
                        }
                    }

                    if(successCount > 0) {
                        alert(`${successCount}건이 삭제되었습니다.`);
                        searchForm.dispatchEvent(new Event('submit'));
                    }
                });

                const exportHandler = (e) => {
                    const exportBtn = e.target.closest('button[data-export="xlsx"]');
                    if (!exportBtn) return;
                    Common.bindExcelExport(searchForm, exportBtn, inputSort.value, inputDir.value, 'mbrs_id', payload);
                    setTimeout(() => { loading.style.display = 'none'; }, 1000);
                };
                grid.addEventListener('click', exportHandler);

                const chkAll = document.getElementById('chkAll');
                if (chkAll) {
                    chkAll.addEventListener('change', function() {
                        const checkboxes = grid.querySelectorAll('input[name="chk"]');
                        checkboxes.forEach((cb) => { cb.checked = chkAll.checked; });
                    });
                }

                if (typeof bindPagination === 'function') {
                    bindPagination(baseUrl, {
                        page: 0,
                        size: parseInt(selectSize?.value || '10', 10),
                        dir: inputDir?.value || 'asc',
                        sort: inputSort?.value || 'mbrs_id',
                    });
                } else {
                    console.warn('bindPagination is not defined. Pagination might not work.');
                }

                head.addEventListener('click', (e) => {
                    const a = e.target.closest('a[data-sort]');
                    if (!a) return;
                    e.preventDefault();

                    const next = a.dataset.sort;
                    const curr = inputSort?.value || 'mbrs_id';
                    let dir = (next === curr) ? (inputDir?.value === 'asc' ? 'desc' : 'asc') : 'asc';

                    if (inputSort) inputSort.value = next;
                    if (inputDir) inputDir.value = dir;

                    searchForm.dispatchEvent(new Event('submit'));
                });

                searchForm?.addEventListener('submit', (e) => {
                    e.preventDefault();
                    rowAddForm.style.display = 'none'; // 검색 시 폼 닫기
                    const applied = Common.collectFromForm(searchForm);
                    Common.reloadList({
                        page: 0,
                        defaultSortColumn: 'mbrs_id',
                        swapTargets: ['#grid-tbody', '#grid-pager', '#grid-header'],
                        selectSize: selectSize,
                        baseUrl: baseUrl,
                        inputSort: inputSort,
                        inputDir: inputDir,
                        applied: applied
                    });
                });
            })();
        </script>
    </th:block>
</th:block>

</body>
</html>
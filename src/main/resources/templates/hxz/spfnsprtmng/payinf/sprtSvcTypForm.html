<!doctype html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<th:block th:replace="~{component/commonHead :: layout(~{::content})}">
    <th:block th:fragment="content">

        <section class="section" th:object="${typDetail}">
            <div class="section-header">
                <div class="title-wrap">
                    <h3 class="section-title" th:text="*{tpwSvcTypSno != null and tpwSvcTypSno != 0} ? '서비스유형관리 (수정)' : '서비스유형관리 (신규)'">서비스유형관리</h3>
                </div>

                <form th:object="${typDetail}">
                    <input type="hidden" name="tpwSvcId" th:value="*{tpwSvcId}">
                    <input type="hidden" name="tpwSvcTypId" th:value="*{tpwSvcTypId}">
                    <input type="hidden" name="tpwSvcTypSno" th:value="*{tpwSvcTypSno}">

                    <div class="box-wrap">
                        <div class="box">
                            <p class="field-title">서비스 ID (상위)</p>
                            <input class="dp-input text-field" type="text" th:value="*{tpwSvcId}" readonly>
                        </div>
                        <div class="box">
                            <p class="field-title">유형명</p>
                            <input class="dp-input text-field" type="text" name="tpwSvcTypNm" th:value="*{tpwSvcTypNm}">
                        </div>
                        <div class="box">
                            <p class="field-title">정산주기</p>
                            <div th:class="*{tpwStlmCycDvsCd != null and tpwStlmCycDvsCd != ''} ? 'dropdown' : 'dropdown is-placeholder'" data-name="tpwStlmCycDvsCd">
                                <button type="button" class="dropdown_button" aria-haspopup="listbox" aria-expanded="false" aria-label="정산 주기 구분 코드 드롭다운">
                                    <span class="dropdown_value" data-placeholder="선택하세요" th:text="*{tpwStlmCycDvsCd != null ? tpwStlmCycDvsCd : '선택하세요'}">선택하세요</span>
                                </button>
                                <ul class="dropdown_list" role="listbox" tabindex="-1">
                                    <li role="option" class="dropdown_option" data-value="01">월정산</li>
                                    <li role="option" class="dropdown_option" data-value="02">분기</li>
                                </ul>
                                <input type="hidden" name="tpwStlmCycDvsCd" th:value="*{tpwStlmCycDvsCd}">
                            </div>
                        </div>
                    </div>

                    <div class="box-wrap">
                        <div class="box">
                            <p class="field-title">서비스기간</p>
                            <th:block th:replace="~{page/commonFragment/datepicker :: periodFixed}"></th:block>
                        </div>

                        <div class="box">
                            <p class="field-title">이월구분</p>
                            <div th:class="*{tpwCrovDvsCd != null and tpwCrovDvsCd != ''} ? 'dropdown' : 'dropdown is-placeholder'" data-name="tpwCrovDvsCd">
                                <button type="button" class="dropdown_button" aria-haspopup="listbox" aria-expanded="false" aria-label="이월구분 드롭다운">
                                    <span class="dropdown_value" data-placeholder="선택하세요" th:text="*{tpwCrovDvsCd != null ? tpwCrovDvsCd : '선택하세요'}">선택하세요</span>
                                </button>
                                <ul class="dropdown_list" role="listbox" tabindex="-1">
                                    <li role="option" class="dropdown_option" data-value="00">없음</li>
                                    <li role="option" class="dropdown_option" data-value="02">분기내</li>
                                    <li role="option" class="dropdown_option" data-value="03">연환 이월</li>
                                </ul>
                                <input type="hidden" name="tpwCrovDvsCd" th:value="*{tpwCrovDvsCd}">
                            </div>
                        </div>
                    </div>

                    <div class="box-wrap">
                        <div class="box">
                            <p class="field-title">지원대상</p>
                            <input class="dp-input text-field" type="text" name="tpwMbrsTypCd" th:value="*{tpwMbrsTypCd}">
                        </div>
                        <div class="box">
                            <p class="field-title">지원중복여부</p>
                            <div th:class="*{sprtDplcYn != null and sprtDplcYn != ''} ? 'dropdown' : 'dropdown is-placeholder'" data-name="sprtDplcYn">
                                <button type="button" class="dropdown_button" aria-haspopup="listbox" aria-expanded="false" aria-label="지원중복여부 드롭다운">
                                    <span class="dropdown_value" data-placeholder="선택하세요" th:text="*{sprtDplcYn != null ? sprtDplcYn : '선택하세요'}">선택하세요</span>
                                </button>
                                <ul class="dropdown_list" role="listbox" tabindex="-1">
                                    <li role="option" class="dropdown_option" data-value="Y">Y</li>
                                    <li role="option" class="dropdown_option" data-value="N">N</li>
                                </ul>
                                <input type="hidden" name="sprtDplcYn" th:value="*{sprtDplcYn}">
                            </div>
                        </div>
                        <div class="box">
                            <p class="field-title">외국인지원여부</p>
                            <div th:class="*{frgnSprtYn != null and frgnSprtYn != ''} ? 'dropdown' : 'dropdown is-placeholder'" data-name="frgnSprtYn">
                                <button type="button" class="dropdown_button" aria-haspopup="listbox" aria-expanded="false" aria-label="외국인지원여부 드롭다운">
                                    <span class="dropdown_value" data-placeholder="선택하세요" th:text="*{frgnSprtYn != null ? frgnSprtYn : '선택하세요'}">선택하세요</span>
                                </button>
                                <ul class="dropdown_list" role="listbox" tabindex="-1">
                                    <li role="option" class="dropdown_option" data-value="Y">Y</li>
                                    <li role="option" class="dropdown_option" data-value="N">N</li>
                                </ul>
                                <input type="hidden" name="frgnSprtYn" th:value="*{frgnSprtYn}">
                            </div>
                        </div>
                    </div>

                    <div class="box-wrap">
                        <div class="box">
                            <p class="field-title">거주지인증주기</p>
                            <div th:class="*{tpwRsdcAuthCycCd != null and tpwRsdcAuthCycCd != ''} ? 'dropdown' : 'dropdown is-placeholder'" data-name="tpwRsdcAuthCycCd">
                                <button type="button" class="dropdown_button" aria-haspopup="listbox" aria-expanded="false" aria-label="거주지인증주기 드롭다운">
                                    <span class="dropdown_value" data-placeholder="선택하세요" th:text="*{tpwRsdcAuthCycCd != null ? tpwRsdcAuthCycCd : '선택하세요'}">선택하세요</span>
                                </button>
                                <ul class="dropdown_list" role="listbox" tabindex="-1">
                                    <li role="option" class="dropdown_option" data-value="01">월</li>
                                    <li role="option" class="dropdown_option" data-value="02">분기</li>
                                    <li role="option" class="dropdown_option" data-value="03">반기</li>
                                </ul>
                                <input type="hidden" name="trnsTrdMlprExYn" th:value="*{tpwRsdcAuthCycCd}">
                            </div>
                        </div>
                        <div class="box">
                            <p class="field-title">다인승제외여부</p>
                            <div th:class="*{trnsTrdMlprExYn != null and trnsTrdMlprExYn != ''} ? 'dropdown' : 'dropdown is-placeholder'" data-name="trnsTrdMlprExYn">
                                <button type="button" class="dropdown_button" aria-haspopup="listbox" aria-expanded="false" aria-label="다인승제외여부 드롭다운">
                                    <span class="dropdown_value" data-placeholder="선택하세요" th:text="*{trnsTrdMlprExYn != null ? trnsTrdMlprExYn : '선택하세요'}">선택하세요</span>
                                </button>
                                <ul class="dropdown_list" role="listbox" tabindex="-1">
                                    <li role="option" class="dropdown_option" data-value="Y">Y</li>
                                    <li role="option" class="dropdown_option" data-value="N">N</li>
                                </ul>
                                <input type="hidden" name="trnsTrdMlprExYn" th:value="*{trnsTrdMlprExYn}">
                            </div>
                        </div>
                        <div class="box">
                            <p class="field-title">정산 분류 코드</p>
                            <div th:class="*{tpwStlmCtgCd != null and tpwStlmCtgCd != ''} ? 'dropdown' : 'dropdown is-placeholder'" data-name="tpwStlmCtgCd">
                                <button type="button" class="dropdown_button" aria-haspopup="listbox" aria-expanded="false" aria-label="정산 분류 코드 드롭다운">
                                    <span class="dropdown_value" data-placeholder="선택하세요" th:text="*{tpwStlmCtgCd != null ? tpwStlmCtgCd : '선택하세요'}">선택하세요</span>
                                </button>
                                <ul class="dropdown_list" role="listbox" tabindex="-1">
                                    <li role="option" class="dropdown_option" data-value="01">정액</li>
                                    <li role="option" class="dropdown_option" data-value="02">정률</li>
                                </ul>
                                <input type="hidden" name="tpwStlmCtgCd" th:value="*{tpwStlmCtgCd}">
                            </div>
                        </div>
                    </div>

                    <div class="box-wrap">
                        <div class="box">
                            <p class="field-title">지원교통수단</p>
                            <div th:class="*{tpwMntnCd != null and tpwMntnCd != ''} ? 'dropdown' : 'dropdown is-placeholder'" data-name="tpwMntnCd">
                                <button type="button" class="dropdown_button" aria-haspopup="listbox" aria-expanded="false" aria-label="지원교통수단 드롭다운">
                                    <span class="dropdown_value" data-placeholder="선택하세요" th:text="*{tpwMntnCd != null ? tpwMntnCd : '선택하세요'}">선택하세요</span>
                                </button>
                                <ul class="dropdown_list" role="listbox" tabindex="-1">
                                    <li role="option" class="dropdown_option" data-value="000">기타</li>
                                    <li role="option" class="dropdown_option" data-value="100">버스</li>
                                    <li role="option" class="dropdown_option" data-value="200">도시철도</li>
                                    <li role="option" class="dropdown_option" data-value="300">택시</li>
                                    <li role="option" class="dropdown_option" data-value="101">도시형버스</li>
                                    <li role="option" class="dropdown_option" data-value="102">일반좌석버스</li>
                                </ul>
                                <input type="hidden" name="tpwStlmActDvsCd" th:value="*{tpwStlmActDvsCd}">
                            </div>
                        </div>
                        <div class="box">
                            <p class="field-title">정산실행단계</p>
                            <div th:class="*{tpwStlmActDvsCd != null and tpwStlmActDvsCd != ''} ? 'dropdown' : 'dropdown is-placeholder'" data-name="tpwStlmActDvsCd">
                                <button type="button" class="dropdown_button" aria-haspopup="listbox" aria-expanded="false" aria-label="정산 실행 단계 구분 코드 드롭다운">
                                    <span class="dropdown_value" data-placeholder="선택하세요" th:text="*{tpwStlmActDvsCd != null ? tpwStlmActDvsCd : '선택하세요'}">선택하세요</span>
                                </button>
                                <ul class="dropdown_list" role="listbox" tabindex="-1">
                                    <li role="option" class="dropdown_option" data-value="01">지원대상</li>
                                    <li role="option" class="dropdown_option" data-value="02">거래내역</li>
                                    <li role="option" class="dropdown_option" data-value="03">정산내역</li>
                                    <li role="option" class="dropdown_option" data-value="04">지급실행</li>
                                </ul>
                                <input type="hidden" name="tpwStlmActDvsCd" th:value="*{tpwStlmActDvsCd}">
                            </div>
                        </div>
                        <div class="box">
                            <p class="field-title">교통거래기관</p>
                            <input class="dp-input text-field" type="text" name="tpwTrdOrgCd" th:value="*{tpwTrdOrgCd}">
                        </div>
                    </div>


                    <div class="box-wrap">
                        <div class="box">
                            <p class="field-title">자동신청여부</p>
                            <div th:class="*{autAplYn != null and autAplYn != ''} ? 'dropdown' : 'dropdown is-placeholder'" data-name="autAplYn">
                                <button type="button" class="dropdown_button" aria-haspopup="listbox" aria-expanded="false" aria-label="자동신청여부 드롭다운">
                                    <span class="dropdown_value" data-placeholder="선택하세요" th:text="*{autAplYn != null ? autAplYn : '선택하세요'}">선택하세요</span>
                                </button>
                                <ul class="dropdown_list" role="listbox" tabindex="-1">
                                    <li role="option" class="dropdown_option" data-value="Y">Y</li>
                                    <li role="option" class="dropdown_option" data-value="N">N</li>
                                </ul>
                                <input type="hidden" name="autAplYn" th:value="*{autAplYn}">
                            </div>
                        </div>
                        <div class="box">
                            <p class="field-title">증빙서류여부</p>
                            <div th:class="*{evdnYn != null and evdnYn != ''} ? 'dropdown' : 'dropdown is-placeholder'" data-name="evdnYn">
                                <button type="button" class="dropdown_button" aria-haspopup="listbox" aria-expanded="false" aria-label="증빙서류여부 드롭다운">
                                    <span class="dropdown_value" data-placeholder="선택하세요" th:text="*{evdnYn != null ? evdnYn : '선택하세요'}">선택하세요</span>
                                </button>
                                <ul class="dropdown_list" role="listbox" tabindex="-1">
                                    <li role="option" class="dropdown_option" data-value="Y">Y</li>
                                    <li role="option" class="dropdown_option" data-value="N">N</li>
                                </ul>
                                <input type="hidden" name="evdnYn" th:value="*{evdnYn}">
                            </div>
                        </div>
                        <div class="box">
                            <p class="field-title">사용여부</p>
                            <div th:class="*{useYn != null and useYn != ''} ? 'dropdown' : 'dropdown is-placeholder'" data-name="useYn">
                                <button type="button" class="dropdown_button" aria-haspopup="listbox" aria-expanded="false" aria-label="사용여부 드롭다운">
                                    <span class="dropdown_value" data-placeholder="선택하세요" th:text="*{useYn != null ? useYn : '선택하세요'}">선택하세요</span>
                                </button>
                                <ul class="dropdown_list" role="listbox" tabindex="-1">
                                    <li role="option" class="dropdown_option" data-value="Y">Y</li>
                                    <li role="option" class="dropdown_option" data-value="N">N</li>
                                </ul>
                                <input type="hidden" name="useYn" th:value="*{useYn}">
                            </div>
                        </div>
                    </div>
                </form>

                <div class="btn-wrap">
                    <button type="button" class="btn btn-primary btn-save" th:text="*{tpwSvcTypSno != null and tpwSvcTypSno != 0} ? '수정' : '등록'">등록</button>
                    <button type="button" class="btn btn-dark-line btn-close">닫기</button>
                </div>
            </div>

        </section>

        <th:block th:replace="~{component/commonFooter :: commonFooter}"></th:block>

        <script th:inline="javascript">

            /**
             * 날짜 필드 초기화 함수 (ID 기반으로 찾도록 수정)
             * @param {string} id - 날짜 필드의 ID (sttDt, endDt)
             * @param {string} value - 설정할 날짜 값 (YYYY-MM-DD 또는 YYYYMMDD)
             */
            const initDatepicker = (id, value) => {
                const input = document.getElementById(id);
                if (input && value) {
                    let formattedValue = value.trim();

                    // YYYYMMDD (8자리) 형식으로 넘어왔다면 YYYY-MM-DD (10자리)로 변환
                    if (formattedValue.length === 8 && /^\d{8}$/.test(formattedValue)) {
                        formattedValue = formattedValue.replace(/(\d{4})(\d{2})(\d{2})/, '$1-$2-$3');
                    }
                    // 입력 필드에 설정
                    input.value = formattedValue;
                }
            };

            /* 폼 초기화 */
            document.addEventListener('DOMContentLoaded', function () {
                const detail = /*[[${typDetail}]]*/ {};

                console.log(detail)

                setTimeout(()=>{
                    const arr = [
                        'sprtDplcYn','frgnSprtYn','trnsTrdMlprExYn','autAplYn','evdnYn','useYn',
                        'trnsTrdReqYn','ldgrTrdReqYn','taxiTrdReqYn','areaTrdReqYn','trdNcntLtnAdptYn',

                        'tpwRsdcAuthCycCd','tpwStlmCtgCd','tpwMntnCd','tpwStlmActDvsCd','tpwStlmCycDvsCd',
                        'tpwCrovDvsCd',
                    ];
                    for (const k of arr) {
                        const target = document.querySelector(`[data-name="${k}"] [data-value="${detail[k]}"]`);
                        if ( target == null )
                        {
                            console.log('없는키',k)
                            continue;
                        }
                        const ev = new MouseEvent('click', {
                            bubbles: true,
                            cancelable: true,
                            view: window
                        });
                        target.dispatchEvent(ev);
                    }
                }, 200);

                initDatepicker('sttDt', detail.tpwSvcTypSttDt);
                initDatepicker('endDt', detail.tpwSvcTypEndDt);

                // --- 달력 초기화 (기존 주석 처리된 부분) ---
                // if (typeof initializeCalendar === 'function') {
                //     initializeCalendar('.calendar-field');
                // } else {
                //     console.warn("Calendar initialization function not found.");
                // }
            });
        </script>

        <script th:inline="javascript">

            // 등록/수정 구분을 위해 SNO 값 가져오기
            const tpwSvcTypSno = /*[[${typDetail.tpwSvcTypSno}]]*/ 0;
            const isUpdate = tpwSvcTypSno != null && tpwSvcTypSno != 0;

            document.querySelector('.btn-save').addEventListener('click', async function (e) {
                e.preventDefault();
                const form = document.querySelector('form');

                // Common.collectFromForm 함수를 사용하여 폼 데이터 수집
                const data = Common.collectFromForm(form);

                const sttDtInput = document.getElementById('sttDt');
                const endDtInput = document.getElementById('endDt');

                const cleanDate = (inputElement) => {
                    if (inputElement && inputElement.value) {
                        // 하이픈 제거: '2025-11-14' -> '20251114'
                        const cleaned = inputElement.value.replace(/-/g, '').trim();
                        return cleaned || null;
                    }
                    return null;
                };

                // data 객체에 최종 전송될 값을 덮어씀
                data.tpwSvcTypSttDt = cleanDate(sttDtInput);
                data.tpwSvcTypEndDt = cleanDate(endDtInput);

                let url;
                let method;
                let message;

                if (isUpdate) {
                    // 수정 로직 (SNO가 존재할 때)
                    url = '/spfnsprtmng/payinf/updateSvcTyp';
                    method = 'PUT';
                    message = '유형 수정이 완료되었습니다.';
                } else {
                    // 신규 등록 로직 (SNO가 null/0일 때)
                    url = '/spfnsprtmng/payinf/SprtsvcTypadd';
                    method = 'POST';
                    message = '유형 등록이 완료되었습니다.';
                }

                const res = await Common.sendSafe(url, { method, data });

                if (res.ok) {
                    alert(message);
                    // 팝업/모달을 닫고 부모 페이지 새로고침
                    if (window.opener && !window.opener.closed) {
                         window.opener.location.reload();
                    }
                    window.close();
                    // TODO: 이거 뒤로가기 해야할듯? 성공하고
                } else {
                    // 서버 응답에서 오류 메시지를 가져와 표시할 수 있도록 수정
                    const errorText = await res.text().catch(() => '알 수 없는 오류');
                    modalShow({ title: '경고', message: `저장 중 에러가 발생했습니다.\n상세: ${errorText.substring(0, 100)}...`, buttons: ['close'] });
                }
            });

            // 닫기 버튼 로직 (팝업/모달 닫기)
            document.querySelector('.btn-close').addEventListener('click', function () {
                window.close();
            });
        </script>

    </th:block>
</th:block>
</html>
<!doctype html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<th:block th:replace="~{component/commonHead :: layout(~{::content})}">
    <th:block th:fragment="content">

        <section class="section">

            <div class="section-header">
                <form action="/spfnsprtmng/payinf/sprtSvcPtInf.do" method="get" th:object="${req}">
                    <input type="hidden" th:field="*{sort}">
                    <input type="hidden" th:field="*{dir}">
                    <div class="title-wrap">
                        <h3 class="section-title">지원서비스내역조회</h3>
                    </div>

                    <div class="box-wrap">
                        <div class="box">
                             <p class="field-title">기관코드</p>
                            <input type="text" class="dp-input text-field" name="orgCd" th:field="*{orgCd}">
                        </div>
                        <div class="box">
                            <!-- <p class="field-title">지원대상</p>
                            <input type="text" class="dp-input text-field" name="tpwMbrsTypCdNm"> -->
                            <!-- TODO: 라벨이 '지원대상' 이어야함 -->
                            <th:block th:replace="~{common/fragment/cmncd-dropdown :: cmncd(
                                '0024', 'tpwMbrsTypCdNm', '선택하세요'
                            )}"></th:block>
                        </div>
                    </div>
                    <div class="box-wrap">
                        <div class="box">
                            <p class="field-title">서비스 선택</p>
                            <th:block th:replace="~{common/fragment/dropdowns :: cascadingDropdown(
                                'svcPair1','tpwSvcId','tpwSvcTypId'
                            )}"></th:block>
                        </div>
                    </div>


                    <div class="box-wrap">
                        <div class="box">
                            <p class="field-title">서비스기간</p>
                            <div class="text-field datepicker">
                                <!-- TODO: sttDt svcSttDt 왜 섞인지? -->
                                <input type="text" class="dp-input" placeholder="YYYY-MM-DD"
                                       name="svcSttDt" th:value="*{svcSttDt}"
                                >
                                <button type="button" class="dp-btn" data-dp-toggle></button>
                            </div>
                        </div>
                        <div class="box">
                            <p class="field-title">&nbsp;</p>
                            <div class="text-field datepicker">
                                <input type="text" class="dp-input" placeholder="YYYY-MM-DD"
                                       name="svcEndDt" th:value="*{svcEndDt}"
                                >
                                <button type="button" class="dp-btn" data-dp-toggle></button>
                            </div>
                        </div>
                    </div>

                    <div class="btn-wrap">
                        <button type="submit" class="btn btn-primary btn-icon-left"
                                sec:authorize="hasPermission('지원서비스내역조회', 'READ')">검색 <i class="icon icon-search"></i>
                        </button>
                    </div>
                </form>
            </div>

            <div class="section-content">
                <div class="flex justify-space-between">
                    <b>검색결과: <span th:text="${pageData.total}">0</span>건</b>
                    <div class="flex col-">
                        <a class="btn btn-primary btn-icon-left" href="/spfnsprtmng/payinf/newSprtSvcPtInfForm.do">
                            신규등록
                            <!-- <i class="icon icon-save"></i> -->
                        </a>
                        <a type="button" class="btn btn-primary btn-icon-left" href="/spfnsprtmng/payinf/exportSprtSvcPtInf">
                            엑셀 다운로드 <i class="icon icon-save"></i>
                        </a>
                        <button type="button" class="btn btn-dark-line">목록</button>
                    </div>
                </div>

                <div class="table-wrap mt20">
                    <table class="table">
                        <caption class="blind">지원서비스내역조회 테이블</caption>
                        <colgroup>
                            <col width="80px">
                            <col width="150px">
                            <col width="200px">
                            <col width="150px">
                            <col width="150px">
                            <col width="150px">
                        </colgroup>
                        <thead>
                        <tr>
                            <th scope="col">순번</th>
                            <th scope="col">기관</th>
                            <th scope="col">지원서비스내용</th>
                            <th scope="col">서비스시작일자</th>
                            <th scope="col">서비스종료일자</th>
                            <th scope="col">서비스유형</th>
                        </tr>
                        </thead>
                        <tbody>
                        <tr th:if="${pageData == null or #lists.isEmpty(pageData.content)}">
                            <td class="text-center" th:colspan="6">조회된 데이터가 없습니다.</td>
                        </tr>
                        <th:block th:if="${pageData != null and !#lists.isEmpty(pageData.content)}">
                            <th:block th:each="u, stat : ${pageData.content}"
                                      th:object="${u}"
                                      th:with="base=${(pageData.page)} * ${pageData.size}">

                                <tr class="data-row"
                                    th:data-orgcd="*{orgCd}"
                                    th:data-svcid="*{tpwSvcId}">
                                    <td th:text="${base + stat.index + 1}">1</td>
                                    <td th:text="*{tpwOrgNm}">기관명</td>
                                    <td th:text="*{tpwSvcCtt}">지원서비스내용</td>
                                    <td th:text="*{tpwSvcSttDt}">서비스시작일자</td>
                                    <td th:text="*{tpwSvcEndDt}">서비스종료일자</td>
                                    <td th:text="*{tpwSvcNm}">서비스유형</td>
                                </tr>
                            </th:block>
                        </th:block>
                        </tbody>
                    </table>
                </div>

                <!-- 페이징 -->
                <div class="mt20" id="grid-pager">
                    <th:block th:replace="~{component/pagination :: pager(pageData=${pageData})}"></th:block>
                </div>
            </div>
        </section>


        <script th:inline="javascript">
            document.addEventListener('DOMContentLoaded', () => {
                const req = /*[[${req}]]*/ {};

                // 서비스 선택
                var dd = document.getElementById('svcPair1');
                setTimeout(() => {
                    dd.selectByValues(req.tpwSvcId, req.tpwSvcTypId);
                }, 100);

                const stt = document.getElementById('sttDt');
                const end = document.getElementById('endDt');
                if (stt) stt.value = req.svcSttDt || '';
                if (end) end.value = req.svcEndDt || '';
            });
        </script>

        <script>
            document.addEventListener('DOMContentLoaded', function() {
                var tableBody = document.querySelector('.table tbody');

                if (tableBody) {
                    tableBody.addEventListener('click', function(event) {

                        // 1. 체크박스 클릭 무시
                        if (event.target.closest('.control.checkbox')) {
                            return;
                        }

                        // 2. 가장 가까운 행(tr.data-row) 찾기
                        var row = event.target.closest('tr.data-row');

                        if (row) {
                            // 3. data 속성에서 두 개의 파라미터 값을 읽어옴
                            var orgCd = row.getAttribute('data-orgcd');
                            var tpwSvcId = row.getAttribute('data-svcid');

                            if (orgCd && tpwSvcId) {
                                console.log('Detail link generated! orgCd:', orgCd, 'tpwSvcId:', tpwSvcId);

                                // 4. 컨트롤러가 기대하는 쿼리 파라미터 형태의 URL 생성
                                // URL: /sprtSvcInfDetail.do?orgCd={orgCd}&tpwSvcId={tpwSvcId}
                                var detailUrl = '/spfnsprtmng/payinf/sprtSvcInfDetail.do?orgCd=' + encodeURIComponent(orgCd) + '&tpwSvcId=' + encodeURIComponent(tpwSvcId);

                                // 5. 상세보기 페이지로 이동
                                window.location.href = detailUrl;

                            } else {
                                console.warn('Clicked row is missing required ID data (orgCd or tpwSvcId).');
                            }
                        }
                    });
                }
            });
        </script>

        <th:block th:replace="~{component/commonFooter :: commonFooter}"></th:block>

    </th:block>
</th:block>
</html>
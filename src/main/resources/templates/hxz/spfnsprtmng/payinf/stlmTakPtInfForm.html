<!doctype html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<!-- 레이아웃에 이 페이지의 본문(content) 프래그먼트를 주입 -->
<th:block th:replace="~{component/commonHead :: layout(~{::content})}">
    <th:block th:fragment="content">

        <section class="section">
            <div class="section-header">
                <div class="title-wrap">
                    <h3 class="section-title">정산 작업 내역 조회</h3>
                </div>
            </div>
            <div class="section-content">
                <form id="stlm-form" th:object="${pageData}">

                    <!-- 서비스유형번호 -->
                    <!-- TODO: 서비스 유형 일련번호가 신규 폼 화면 기획에 선택 없음
                        그러면 서비스 선택에 따라 자동으로 값을 채워야함
                        서비스유형과 일련번호가 DB에 연결되어있는거를 드롭다운 셀렉에 적용해야함
                    -->
                    <!-- 회계처리 완료여부 -->
                    <input type="hidden" name="prcgFnYn" value="N">
                    <div class="table-wrap">
                        <table class="table table-vertical">
                            <colgroup>
                                <col style="width: 160px;">
                                <col>
                            </colgroup>
                            <tbody>
                            <tr>
                                <th scope="row">신청일자</th>

                                <td th:if="*{exeDiv} == 'SIM'">
                                    <div class="date-field" style="width: 150px;">
                                        <input type="text" name="aplSttDt" th:value="*{aplSttDt}" id="startDate1" class="text-field date-text" value="2025-01-10">
                                    </div>
                                    <div class="date-field" style="width: 150px;">
                                        <input type="text" name="aplEndDt" th:value="*{aplEndDt}" id="endDate1" class="text-field date-text" value="2025-01-10">
                                    </div>
                                </td>
                                <td th:if="*{exeDiv} == 'PERD'">
                                    <div class="date-field" style="width: 150px;">
                                        <input type="text" name="aplDt" th:value="*{aplDt}" id="startDate1" class="text-field date-text" value="2025-01-10">
                                    </div>
                                </td>

                            </tr>
                            <tr>
                                <th scope="row">서비스 선택</th>
                                <td>
                                    <th:block th:replace="~{common/fragment/dropdowns :: cascadingDropdown(
                                        'svcPair1',
                                        'tpwSvcId',
                                        'tpwSvcTypId'
                                    )}"></th:block>
                                </td>
                            </tr>
                            <tr>
                                <th scope="row">거래시작일자</th>
                                <td>
                                    <div class="date-field" style="width: 150px;">
                                        <input type="text" name="tpwTrdSttDt" id="startDate3" class="text-field date-text" th:value="*{tpwTrdSttDt}">
                                    </div>
                                </td>
                            </tr>
                            <tr>
                                <th scope="row">거래종료일자</th>
                                <td>
                                    <div class="date-field" style="width: 150px;">
                                        <input type="text" name="tpwTrdEndDt" id="startDate2" class="text-field date-text" th:value="*{tpwTrdEndDt}">
                                    </div>
                                </td>
                            </tr>
                            <tr>
                                <th scope="row">실행구분</th>
                                <td>
                                    <div style="width:240px">
                                        <div class="dropdown" data-name="exeDiv">
                                            <button type="button"
                                                    class="dropdown_button"
                                                    aria-haspopup="listbox"
                                                    aria-expanded="false"
                                                    aria-label="실행구분 드롭다운">
                                                <span class="dropdown_value" data-placeholder="선택하세요">선택하세요</span>
                                            </button>
                                            <ul class="dropdown_list" role="listbox" tabindex="-1">
                                                <li role="option" class="dropdown_option" data-value="PERD">정기</li>
                                                <li role="option" class="dropdown_option" data-value="SIM">시뮬레이션</li>
                                            </ul>
                                            <input type="hidden" name="exeDiv" th:value="*{exeDiv}">
                                        </div>
                                    </div>
                                </td>
                            </tr>
                            </tbody>
                        </table>
                    </div>
                </form>

                <div class="flex justify-end col- mt40">
                    <button id="to-list" type="button" class="btn btn-dark-line">목록</button>
                    <button id="save" class="btn btn-blue">저장</button>
                </div>
            </div>
        </section>


        <script th:inline="javascript">
            /*<![CDATA[*/
            const tpwSvcId = /*[[${pageData.tpwSvcId}]]*/ '0';
            const tpwSvcTypId = /*[[${pageData.tpwSvcTypId}]]*/ '0';
            const exeDiv = /*[[${pageData.exeDiv}]]*/ '0';

            document.addEventListener('DOMContentLoaded', function () {
                setTimeout(function(){
                    const root = document.getElementById('svcPair1');
                    root.selectByValues(tpwSvcId, tpwSvcTypId);
                }, 500);
            });
            /*]]>*/
        </script>


        <script>

            // 숫자 유틸
            const onlyDigits = (s) => (s || '').replace(/\D+/g, '');

            document.addEventListener('DOMContentLoaded', function () {
                for (const el of document.querySelectorAll('.date-text')) {
                    el.type = 'date';
                }
            });

            document.querySelector('#to-list').addEventListener('click', function(){
                location.href = "/spfnsprtmng/payinf/stlmTakPtInf.do";
            });


            const form = document.querySelector('#stlm-form');
            const saveBtn = document.querySelector('#save');
            saveBtn.addEventListener('click', async (e) => {
                e.preventDefault();
                // sanitizeBeforeSubmit(form);
                const dateColumn = ['tpwTrdSttDt','tpwTrdEndDt','aplSttDt','aplEndDt','aplDt'];
                const data = Common.collectFromForm(form);

                for (const k in data) {
                    if ( dateColumn.includes(k) )
                        data[k] = onlyDigits(data[k]);
                }

                // 시뮬이면 신청일자가지고 stt end 채우기
                if ( document.querySelector('[name="aplSttDt"]') == null ) {
                    data.aplSttDt = data.aplDt;
                    data.aplEndDt = data.aplDt;
                }

                // sno 찾아서 채우기
                const tpwsvc = await Common.sendSafe('/common/tpwsvc/tpwSvcInf', {method: 'GET'});
                const tpwsvcids = JSON.parse(tpwsvc.data).typesBySvcId;
                for (const row of tpwsvcids[data.tpwSvcId]) {
                    if(row.tpwSvcTypId == data.tpwSvcTypId) {
                        data.tpwSvcTypSno = row.tpwSvcTypSno;
                    }
                }
                
                const url = location.pathname.includes('/new') ? '/spfnsprtmng/payinf/add' : '/spfnsprtmng/payinf/update';
                const method = location.pathname.includes('/new') ? 'POST' : 'PUT';
                const res = await Common.sendSafe(url, { method: method, data: data });

                if ( res.ok )
                    location.href = "/spfnsprtmng/payinf/stlmTakPtInf.do";
                else
                    modalShow({
                        title: '경고',
                        message: '에러',
                        buttons: ['close']
                    });
            });


        </script>

        <!-- 공통 Footer 주입 -->
        <th:block th:replace="~{component/commonFooter :: commonFooter}"></th:block>

    </th:block>
</th:block>
</html>

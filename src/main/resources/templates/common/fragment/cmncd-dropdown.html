<!-- templates/common/fragment/cmncd-dropdown.html -->
<th:block th:fragment="cmncd(title , cmnGrpCdId, name='cmnCd', placeholder='선택하세요')">
    <div class="field-wrap">
        <p class="field-title"
           th:text="${title}"
           th:attr="data-title=${title}">코드선택</p>
        <div style="width:240px">
            <div class="dropdown"
                 th:attr="data-cmn-grp-id=${cmnGrpCdId},
                    data-name=${name},
                    data-placeholder=${placeholder}">
                <button type="button" class="dropdown_button" aria-haspopup="listbox" aria-expanded="false">
          <span class="dropdown_value" th:attr="data-placeholder=${placeholder}"
                th:text="${placeholder}">선택하세요</span>
                </button>
                <ul class="dropdown_list" role="listbox" tabindex="-1"></ul>
                <input type="hidden" th:attr="name=${name}" value="">
            </div>
        </div>
    </div>

    <script th:inline="javascript">
        (function () {
            // 이 스크립트 태그 바로 위의 .dropdown만 다룸
            var root = document.currentScript.previousElementSibling?.querySelector('.dropdown');
            if (!root || root.dataset.bound === '1') return;
            root.dataset.bound = '1';

            var grpId = root.getAttribute('data-cmn-grp-id');
            var name  = root.getAttribute('data-name') || 'cmnCd';
            var ph    = root.getAttribute('data-placeholder') || '선택하세요';

            var btn    = root.querySelector('.dropdown_button');
            var value  = root.querySelector('.dropdown_value');
            var list   = root.querySelector('.dropdown_list');
            var hidden = root.querySelector('input[type="hidden"]');

            // 전체 로우 캐시 및 value → row 인덱스
            var rowsCache = [];
            var indexByValue = Object.create(null);

            function open(){ btn.setAttribute('aria-expanded','true');  list.style.display='block'; list.focus(); }
            function close(){ btn.setAttribute('aria-expanded','false'); list.style.display='none'; }
            function off(e){ if(!root.contains(e.target)) close(); }

            function fill(rows){
                rowsCache = Array.isArray(rows) ? rows : [];
                indexByValue = Object.create(null);

                list.innerHTML = rowsCache.map(function(r, i){
                    var v = String(r.cmnDtlCd);
                    indexByValue[v] = i;
                    return '<li role="option" class="dropdown_option" data-value="'+v+'">'+r.cmnDtlCdNm+'</li>';
                }).join('');
            }

            async function getJson(url){
                if (window.Common?.sendSafe){
                    try{
                        var r = await Common.sendSafe(url,{method:'GET',expect:'json'});
                        if(!r?.ok) throw new Error('HTTP '+(r?.status||''));
                        return r.data;
                    }catch(_){}
                }
                var res = await fetch(url,{method:'GET',credentials:'same-origin',headers:{'Accept':'application/json'}});
                if(!res.ok) throw new Error('HTTP '+res.status);
                return res.json();
            }

            // 토글
            root.addEventListener('click', function(e){
                if(!e.target.closest('.dropdown_button')) return;
                e.stopPropagation();
                if (btn.getAttribute('aria-expanded')==='true') close(); else open();
            });
            document.addEventListener('click', off, true);

            function getSelected() {
  var v = String(hidden.value || '');
  var idx = (v && Object.prototype.hasOwnProperty.call(indexByValue, v)) ? indexByValue[v] : -1;
  var row = (idx >= 0) ? rowsCache[idx] : null;

  // 화면에 보이는 라벨(placeholder인 경우도 있으니 보정)
  var labelText = value.textContent ? value.textContent.trim() : '';
  if ((!labelText || labelText === ph) && row && row.cmnDtlCdNm) {
    labelText = row.cmnDtlCdNm;
  }

  return {
    name: name,           // hidden name
    value: v,             // 선택된 코드값 (없으면 '')
    label: labelText,     // 표시 라벨(placeholder일 수 있음)
    index: (idx >= 0 ? idx : null), // rowsCache 내 인덱스
    row: row,             // 백엔드 응답의 행 객체(없으면 null)
    ready: rowsCache.length > 0 // 데이터 로딩 여부
  };
}

// 외부에서 호출 가능하도록 인스턴스 메서드로 노출
root.getSelected = getSelected;

            // 선택
            list.addEventListener('click', function(e){
                var li = e.target.closest('.dropdown_option');
                if(!li) return;

                // UI 반영
                list.querySelectorAll('[aria-selected="true"]').forEach(function(n){n.setAttribute('aria-selected','false');});
                li.setAttribute('aria-selected','true');
                value.textContent = li.textContent.trim();
                hidden.value = li.dataset.value || '';
                close();

                // 선택한 row 찾기
                var v = String(hidden.value);
                var idx = indexByValue[v];
                var row = (idx != null) ? rowsCache[idx] : null;


                root.dispatchEvent(new CustomEvent('cmncd:change', {
                    bubbles: true,
                    detail: {
                        name: name,                // hidden name
                        value: v,                  // 선택된 코드값
                        label: li.textContent.trim(), // 화면 표시명
                        index: idx,                // 행 인덱스
                        row: row                   // 행 전체 데이터 (백엔드 응답의 해당 객체)
                    }
                }));
            });

            // 초기화 & 로딩
            (async function init(){
                value.textContent = ph;
                hidden.value = '';
                list.innerHTML = '<li class="dropdown_option" aria-disabled="true">로딩 중...</li>';
                try{
                    var url = '/common/cmncd?cmnGrpCdId=' + encodeURIComponent(grpId);
                    var data = await getJson(url);
                    var rows = Array.isArray(data) ? data : (Array.isArray(data?.list) ? data.list : []);
                    if (!rows.length){
                        list.innerHTML = '<li class="dropdown_option" aria-disabled="true">선택지가 없습니다</li>';
                    } else {
                        fill(rows);


                        root.dispatchEvent(new CustomEvent('cmncd:ready', {
                            bubbles: true,
                            detail: { name: name, rows: rowsCache }
                        }));

                        // 참고: 콘솔에 전체 로우 미리 보고 싶다면 주석 해제
                        // console.log('[cmncd] rows =', rowsCache);
                    }
                }catch(e){
                    console.error('[cmncd] load fail:', e);
                    list.innerHTML = '<li class="dropdown_option" aria-disabled="true">불러오기에 실패했습니다</li>';
                }
            })();
        })();
    </script>
</th:block>

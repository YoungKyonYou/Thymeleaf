<!-- src/main/resources/templates/upload/file.html -->
<!doctype html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="utf-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1"/>
    <title>파일 업로드</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- 파비콘 404 방지 -->
    <link rel="icon" href="data:image/png;base64,iVBORw0KGgo=" />
    <!-- CSRF (시큐리티 쓰는 경우 자동 주입됨) -->
    <meta name="_csrf_parameter" th:content="${_csrf?.parameterName}">
    <meta name="_csrf" th:content="${_csrf?.token}">
</head>
<body class="bg-light">

<div class="container py-4">
    <div class="row justify-content-center">
        <div class="col-lg-8">
            <div class="card shadow-sm">
                <div class="card-body">
                    <h3 class="card-title mb-3">파일 업로드 (여러 개)</h3>

                    <p class="text-muted mb-2">
                        서버 저장 경로: <code th:text="${uploadRoot}">uploads</code>
                    </p>

                    <!-- 업로드 폼 -->
                    <form id="upload-form" class="mb-3" th:action="@{/file/upload}" method="post" enctype="multipart/form-data">
                        <!-- Spring Security 사용 시 필요 -->
                        <input type="hidden" th:name="${_csrf?.parameterName}" th:value="${_csrf?.token}" />
                        <div class="mb-3">
                            <label for="files" class="form-label">파일 선택</label>
                            <input class="form-control" type="file" id="files" name="files" multiple>
                            <div class="form-text">여러 파일을 선택할 수 있습니다.</div>
                        </div>
                        <div class="d-flex flex-wrap gap-2">
                            <button type="submit" class="btn btn-primary">업로드</button>
                        </div>
                    </form>

                    <!-- 메시지 -->
                    <div id="info" class="alert alert-info d-none"></div>

                    <!-- 목록 컨테이너 -->
                    <div id="list-wrap" class="mt-3">
                        <h5 class="mb-2">저장된 파일</h5>
                        <form id="delete-form" class="d-none">
                            <!-- CSRF 히든 (폼 전송방식일 때 사용 가능) -->
                            <input type="hidden" th:name="${_csrf?.parameterName}" th:value="${_csrf?.token}" />
                            <ul id="file-list" class="list-group mb-3"></ul>
                            <div class="d-flex gap-2">
                                <button type="submit" class="btn btn-outline-danger">선택 초기화</button>
                                <button type="button" id="reset-btn" class="btn btn-danger">전체 초기화</button>
                            </div>
                        </form>
                        <div id="empty" class="text-muted">파일이 없습니다.</div>
                    </div>

                </div>
            </div>
        </div>
    </div>
</div>

<script>
    (() => {
        // ---------- CSRF ----------
        function getCsrf() {
            // 업로드 폼 히든이 우선
            const hidden = document.querySelector('#upload-form input[type="hidden"][name][value]');
            if (hidden) return { name: hidden.name, value: hidden.value };
            // 메타 백업
            const p = document.querySelector('meta[name="_csrf_parameter"]')?.content;
            const v = document.querySelector('meta[name="_csrf"]')?.content;
            return (p && v) ? { name: p, value: v } : null;
        }

        // ---------- 메시지 ----------
        function showInfo(msg) {
            const el = document.getElementById('info');
            el.textContent = msg || '';
            el.classList.toggle('d-none', !msg);
        }

        // ---------- 목록 렌더 ----------
        function renderList(files) {
            const list = document.getElementById('file-list');
            const form = document.getElementById('delete-form');
            const empty = document.getElementById('empty');

            list.innerHTML = '';
            if (!files || files.length === 0) {
                form.classList.add('d-none');
                empty.classList.remove('d-none');
                return;
            }

            empty.classList.add('d-none');
            form.classList.remove('d-none');

            for (const f of files) {
                const li = document.createElement('li');
                li.className = 'list-group-item d-flex align-items-center justify-content-between';

                const left = document.createElement('div');
                left.className = 'd-flex align-items-center gap-2';
                left.style.minWidth = '0';

                const cb = document.createElement('input');
                cb.type = 'checkbox';
                cb.name = 'filenames';
                cb.value = f;

                const span = document.createElement('span');
                span.className = 'text-truncate';
                span.style.maxWidth = '60%';
                span.textContent = f;

                left.appendChild(cb);
                left.appendChild(span);

                const right = document.createElement('span');
                right.className = 'd-flex gap-2';

                const aView = document.createElement('a');
                aView.className = 'btn btn-sm btn-outline-secondary';
                aView.href = `/file/view/${encodeURIComponent(f)}`;
                aView.target = '_blank';
                aView.textContent = '보기';

                const aDown = document.createElement('a');
                aDown.className = 'btn btn-sm btn-primary';
                aDown.href = `/file/download/${encodeURIComponent(f)}`;
                aDown.textContent = '다운로드';

                right.appendChild(aView);
                right.appendChild(aDown);

                li.appendChild(left);
                li.appendChild(right);
                list.appendChild(li);
            }
        }

        // ---------- 서버 통신 ----------
        async function fetchList() {
            const res = await fetch('/file/list.json', { headers: { 'X-Requested-With': 'fetch' } });
            if (!res.ok) throw new Error('목록 요청 실패: ' + res.status);
            return await res.json(); // ["a","b",...]
        }

        async function refreshList() {
            try {
                const files = await fetchList();
                renderList(files);
            } catch (e) {
                console.error(e);
                showInfo('목록을 불러오지 못했습니다.');
            }
        }

        // ---------- 바인딩 ----------
        function wireUpload() {
            const form = document.getElementById('upload-form');
            form.addEventListener('submit', async (e) => {
                e.preventDefault();
                showInfo('');
                const fd = new FormData(form);

                // 혹시 히든이 없다면 CSRF 추가
                if (!Array.from(fd.keys()).some(k => k.toLowerCase().includes('csrf'))) {
                    const csrf = getCsrf(); if (csrf) fd.append(csrf.name, csrf.value);
                }

                const res = await fetch(form.action, { method: 'POST', body: fd, headers: { 'X-Requested-With': 'fetch' } });
                if (!res.ok && res.status !== 204) {
                    showInfo('업로드 실패: HTTP ' + res.status);
                    return;
                }
                form.reset();
                await refreshList();
                showInfo('업로드 완료');
                setTimeout(() => showInfo(''), 1500);
            });
        }

        function wireDelete() {
            const delForm = document.getElementById('delete-form');
            delForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                showInfo('');
                const checked = delForm.querySelectorAll('input[name="filenames"]:checked');
                if (checked.length === 0) { showInfo('삭제할 파일을 선택하세요.'); return; }

                const fd = new FormData();
                for (const c of checked) fd.append('filenames', c.value);
                const csrf = getCsrf(); if (csrf) fd.append(csrf.name, csrf.value);

                const res = await fetch('/file/delete', { method: 'POST', body: fd, headers: { 'X-Requested-With': 'fetch' } });
                if (!res.ok && res.status !== 204) {
                    showInfo('선택 초기화 실패: HTTP ' + res.status);
                    return;
                }
                await refreshList();
                showInfo('선택 초기화 완료');
                setTimeout(() => showInfo(''), 1500);
            });
        }

        function wireReset() {
            const btn = document.getElementById('reset-btn');
            btn.addEventListener('click', async () => {
                showInfo('');
                if (!confirm('모든 파일을 삭제하시겠습니까?')) return;

                const fd = new FormData();
                const csrf = getCsrf(); if (csrf) fd.append(csrf.name, csrf.value);

                const res = await fetch('/file/reset', { method: 'POST', body: fd, headers: { 'X-Requested-With': 'fetch' } });
                if (!res.ok && res.status !== 204) {
                    showInfo('전체 초기화 실패: HTTP ' + res.status);
                    return;
                }
                await refreshList();
                showInfo('전체 초기화 완료');
                setTimeout(() => showInfo(''), 1500);
            });
        }

        document.addEventListener('DOMContentLoaded', async () => {
            wireUpload();
            wireDelete();
            wireReset();
            await refreshList(); // 최초 로딩
        });
    })();
</script>
</body>
</html>

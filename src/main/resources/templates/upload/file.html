<!-- src/main/resources/templates/upload/file.html -->
<!doctype html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="utf-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1"/>
    <title>파일 업로드</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- 파비콘 404 방지 -->
    <link rel="icon" href="data:image/png;base64,iVBORw0KGgo=" />
</head>
<body class="bg-light">

<div class="container py-4">
    <div class="row justify-content-center">
        <div class="col-lg-8">
            <div class="card shadow-sm">
                <div class="card-body">
                    <h3 class="card-title mb-3">파일 업로드 (여러 개)</h3>

                    <p class="text-muted mb-2">
                        서버 저장 경로: <code th:text="${uploadRoot}">uploads</code>
                    </p>

                    <!-- 업로드 폼 -->
                    <form id="upload-form" class="mb-3" th:action="@{/file/upload}" method="post" enctype="multipart/form-data">
                        <!-- Spring Security 사용 시 필요 -->
                        <input type="hidden"  />
                        <div class="mb-3">
                            <label for="files" class="form-label">파일 선택</label>
                            <input class="form-control" type="file" id="files" name="files" multiple>
                            <div class="form-text">여러 파일을 선택할 수 있습니다.</div>
                        </div>
                        <div class="d-flex flex-wrap gap-2">
                            <button type="submit" class="btn btn-primary">업로드</button>
                        </div>
                    </form>

                    <!-- 메시지 -->
                    <div id="info" class="alert alert-info d-none"></div>

                    <!-- 목록 컨테이너 -->
                    <div id="list-wrap" class="mt-3">
                        <h5 class="mb-2">저장된 파일</h5>
                        <form id="delete-form" class="d-none">

                            <input type="hidden"/>
                            <ul id="file-list" class="list-group mb-3"></ul>
                            <div class="d-flex gap-2">
                                <button type="submit" class="btn btn-outline-danger">선택 초기화</button>
                                <button type="button" id="reset-btn" class="btn btn-danger">전체 초기화</button>
                            </div>
                        </form>
                        <div id="empty" class="text-muted">파일이 없습니다.</div>
                    </div>

                </div>
            </div>
        </div>
    </div>
</div>

<script>
    //즉시 실행 함수
    (() => {
        // ---- 유틸 --------------------------------------------------------------
        // DOM 선택을 짧게 쓰는 헬퍼, const element = document.querySelector(sel);와 동일
        // 다만 두 번째 인자 el을 주면 그 요소 내부에서만 찾습니다.
        // 원래는 document.querySelector('#title') 이런 식으로 해야하지만 이게 있으면
        // $('#title')로 짧게 쓸 수 있음
        const $ = (sel, el = document) => el.querySelector(sel);
        /**
         *  const btn1 = document.querySelector('#btn');
         *   btn1.addEventListener('click', function() {
         *     alert('원래 방식: 버튼 클릭!');
         *   });
         *
         *   // on을 쓴 방식
         *   const btn2 = $('#btn');
         *   on(btn2, 'click', () => {
         *     alert('on 방식: 버튼 클릭!');
         *   });
         */
        const on = (el, type, handler) => el.addEventListener(type, handler, { passive: false });

        function flash(msg, { ok = true, holdMs = 1500 } = {}) {
            const box = $('#info');
            if (!box) return;
            box.textContent = msg || '';
            /**
             * alert는 기본 박스 스타일
             * alert-success, alert-danger, alert-info는 색상(상태)
             * d-none은 화면에서 숨김
             */
            box.classList.remove('d-none', 'alert-info', 'alert-danger', 'alert-success');
            box.classList.add(ok ? 'alert-success' : 'alert-danger');
            if (!msg) box.classList.add('d-none');
            if (msg && holdMs) setTimeout(() => { box.classList.add('d-none'); }, holdMs);
        }

        // 공통 fetch 래퍼
        async function api(url, { method = 'GET', body, headers = {}, expect = 'auto' } = {}) {
            const res = await fetch(url, {
                method,
                headers: { 'X-Requested-With': 'fetch', ...headers },
                body
            });

            //실제로는 204면 ok가 true라 이 블록 안 옴
            if (!res.ok && res.status !== 204) {
                const text = await res.text().catch(() => '');
                const msg = text?.trim() || `HTTP ${res.status}`;
                throw new Error(msg);
            }

            if (res.status === 204)
                return null;

            const ct = res.headers.get('content-type') || '';

            if (expect === 'text')
                return res.text();

            if (expect === 'json' || expect === 'auto') {
                if (ct.includes('application/json'))
                    return res.json();

                if (expect === 'json') throw new Error('서버가 JSON을 반환하지 않았습니다.');
                return res.text();

            }
            return res.text();
        }

        // ---- 요소 캐시 ----------------------------------------------------------
        const el = {
            uploadForm: $('#upload-form'),
            deleteForm: $('#delete-form'),
            fileList :  $('#file-list'),
            empty    :  $('#empty'),
            resetBtn :  $('#reset-btn')
        };

        const ENDPOINT = {
            list    : '/file/list',
            upload  : $('#upload-form')?.action || '/file/upload',
            del     : '/file/delete',
            reset   : '/file/reset',
            view    : (f) => `/file/view/${encodeURIComponent(f)}`,
            download: (f) => `/file/download/${encodeURIComponent(f)}`
        };

        // ---- 렌더 ---------------------------------------------------------------
        function renderList(files) {
            const { fileList, deleteForm, empty } = { fileList: el.fileList, deleteForm: el.deleteForm, empty: el.empty };

            fileList.innerHTML = '';
            if (!files || files.length === 0) {
                deleteForm.classList.add('d-none');
                empty.classList.remove('d-none');
                return;
            }
            empty.classList.add('d-none');
            deleteForm.classList.remove('d-none');

            const frag = document.createDocumentFragment();

            for (const f of files) {
                const li = document.createElement('li');
                li.className = 'list-group-item d-flex align-items-center justify-content-between';

                const left = document.createElement('div');
                left.className = 'd-flex align-items-center gap-2';
                left.style.minWidth = '0';

                const cb = document.createElement('input');
                cb.type = 'checkbox';
                cb.name = 'filenames';
                cb.value = f;

                const span = document.createElement('span');
                span.className = 'text-truncate';
                span.style.maxWidth = '60%';
                span.textContent = f;

                left.append(cb, span);

                const right = document.createElement('span');
                right.className = 'd-flex gap-2';

                const aView = document.createElement('a');
                aView.className = 'btn btn-sm btn-outline-secondary';
                aView.href = ENDPOINT.view(f);
                aView.target = '_blank';
                aView.textContent = '보기';

                const aDown = document.createElement('a');
                aDown.className = 'btn btn-sm btn-primary';
                aDown.href = ENDPOINT.download(f);
                aDown.textContent = '다운로드';

                right.append(aView, aDown);
                li.append(left, right);
                frag.appendChild(li);
            }
            fileList.appendChild(frag);
        }

        async function refreshList() {
            try {
                const files = await api(ENDPOINT.list, { expect: 'json' });
                renderList(files);
            } catch (e) {
                console.error(e);
                flash('목록을 불러오지 못했습니다.', { ok: false, holdMs: 2500 });
            }
        }

        // ---- 공통 변이 → 새로고침 ----------------------------------------------
        async function mutateAndRefresh(doWork, { successMsg }) {
            try {
                setDisabled(true);
                await doWork();
                await refreshList();
                flash(successMsg, { ok: true });
            } catch (e) {
                console.error(e);
                flash(e.message || '요청 처리 실패', { ok: false, holdMs: 2500 });
            } finally {
                setDisabled(false);
            }
        }

        function setDisabled(flag) {
            el.uploadForm?.querySelectorAll('button, input, select').forEach((n) => n.disabled = flag);
            el.deleteForm?.querySelectorAll('button, input, select').forEach((n) => n.disabled = flag);
            if (el.resetBtn) el.resetBtn.disabled = flag;
        }

        // ---- 바인딩 -------------------------------------------------------------
        function bindUpload() {
            if (!el.uploadForm) return;
            on(el.uploadForm, 'submit', async (e) => {
                e.preventDefault();
                flash('');
                const fd = new FormData(el.uploadForm);

                await mutateAndRefresh(
                    () => api(ENDPOINT.upload, { method: 'POST', body: fd }),
                    { successMsg: '업로드 완료' }
                );

                el.uploadForm.reset();
            });
        }

        function bindDeleteSelected() {
            if (!el.deleteForm) return;
            on(el.deleteForm, 'submit', async (e) => {
                e.preventDefault();
                flash('');

                const checked = el.deleteForm.querySelectorAll('input[name="filenames"]:checked');
                if (checked.length === 0) {
                    flash('삭제할 파일을 선택하세요.', { ok: false, holdMs: 1800 });
                    return;
                }

                const fd = new FormData();
                checked.forEach((c) => fd.append('filenames', c.value));

                await mutateAndRefresh(
                    () => api(ENDPOINT.del, { method: 'POST', body: fd }),
                    { successMsg: '선택 초기화 완료' }
                );
            });
        }

        function bindResetAll() {
            if (!el.resetBtn) return;
            on(el.resetBtn, 'click', async () => {
                flash('');
                if (!confirm('모든 파일을 삭제하시겠습니까?')) return;

                const fd = new FormData();

                await mutateAndRefresh(
                    () => api(ENDPOINT.reset, { method: 'POST', body: fd }),
                    { successMsg: '전체 초기화 완료' }
                );
            });
        }

        // ---- 시작 ---------------------------------------------------------------
        on(document, 'DOMContentLoaded', async () => {
            bindUpload();
            bindDeleteSelected();
            bindResetAll();
            await refreshList();
        });
    })();
</script>

</body>
</html>

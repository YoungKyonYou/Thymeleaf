<!doctype html>
<html lang="ko"
      xmlns:th="http://www.thymeleaf.org"
      xmlns:sec="http://www.w3.org/1999/xhtml">

<th:block th:replace="~{component/commonHead :: layout(~{::content})}">
    <th:block th:fragment="content">

        <!-- 페이지 전용 CSS -->
        <link rel="stylesheet" th:href="@{/css/page/page.css}"/>

        <style>
            /* ========= 마이페이지 레이아웃 ========= */

            /* 카드 전체 */
            #mypage .mypage-card {
                width: calc(100% - 64px);      /* 좌우 여백 */
                max-width: 960px;              /* 카드 폭 */
                margin: 32px auto 40px;
                padding: 24px 28px 28px;
                border-radius: 10px;
                background-color: var(--color-white);
                box-shadow: 0 0 10px rgba(0, 0, 0, 0.08);
            }

            #mypage .mypage-title {
                font-size: 26px;
                font-weight: 700;
                margin-bottom: 24px;
            }

            /* 한 줄(ROW) */
            #mypage .form-row {
                display: flex;
                flex-wrap: wrap;
                gap: 12px 24px;               /* 세로 12, 가로 24 */
                margin-bottom: 18px;
                align-items: flex-start;
            }

            /* 기본 필드: 2열 레이아웃에서 양쪽 폭 동일하게 */
            #mypage .field {
                display: flex;
                flex-direction: column;
                gap: 6px;
                flex: 1 1 0;                  /* 남는 공간 균등 분배 */
                min-width: 260px;
                max-width: 420px;
            }

            /* 한 줄 꽉 쓰는 필드 (이메일) */
            #mypage .field-full {
                flex: 0 0 100%;
            }

            #mypage .field-label {
                font-size: 14px;
                font-weight: 600;
            }

            #mypage .inline-hint {
                font-size: 12px;
                color: var(--gray-600);
            }

            /* 가로로 붙는 인풋 묶음 */
            #mypage .input-inline {
                display: flex;
                align-items: center;
                gap: 8px;
            }

            #mypage .input-inline.compact {
                gap: 4px;
            }

            #mypage .btn-small {
                height: 32px;
                padding: 0 12px;
                font-size: 13px;
                white-space: nowrap;
            }

            /* 이메일/전화 각 파트 폭 */
            #mypage .email-id {
                width: 200px;
                max-width: 100%;
            }

            #mypage .email-domain {
                width: 260px;
                max-width: 100%;
            }

            #mypage .tel-part {
                width: 80px;
                max-width: 100%;
            }

            #mypage .btn-wrap {
                margin-top: 24px;
                display: flex;
                justify-content: flex-end;
                gap: 12px;
            }

            /* 연락처 줄: 전화번호 / 휴대전화번호 사이 적당한 간격 */
            #mypage .form-row.row-contact {
                gap: 12px 24px;
            }

            /* 모바일일 때는 한 줄에 하나씩 */
            @media (max-width: 900px) {
                #mypage .mypage-card {
                    width: calc(100% - 32px);
                    padding: 20px;
                    margin: 20px auto 30px;
                }

                #mypage .form-row {
                    gap: 10px 12px;
                }

                #mypage .field,
                #mypage .field-full {
                    flex: 0 0 100%;
                    max-width: 100%;
                }
            }

            /* ========= 비밀번호 변경 dialog 모달 ========= */

            dialog.pw-modal {
                width: 420px;
                max-width: calc(100% - 40px);
                border: 1px solid #e5e7eb;
                border-radius: 12px;
                padding: 20px 22px 18px;
                box-shadow: 0 18px 40px rgba(0, 0, 0, .22);
            }

            .pw-modal::backdrop {
                background: rgba(0, 0, 0, .35);
            }

            .pw-head {
                font-size: 18px;
                font-weight: 700;
                margin: 0 0 6px;
            }

            .pw-muted {
                font-size: 12px;
                color: #666;
                margin: 0 0 14px;
            }

            .pw-group {
                margin-bottom: 10px;
            }

            .pw-label {
                display: block;
                font-size: 13px;
                font-weight: 600;
                margin-bottom: 4px;
            }

            .pw-input {
                width: 100%;
            }

            .pw-msg {
                font-size: 12px;
                color: #c22626;
                min-height: 18px;
                margin-top: 4px;
                white-space: pre-wrap;
            }

            .pw-actions {
                display: flex;
                gap: 10px;
                margin-top: 14px;
                justify-content: flex-end;
            }

            /* ✅ readonly 필드 시각적으로 구분 */
            #mypage .text-field[readonly] {
                background-color: #f3f4f6;
                color: #6b7280;
                border-color: #d1d5db;
                cursor: not-allowed;
            }

            #mypage .text-field[readonly]::placeholder {
                color: #9ca3af;
            }
        </style>

        <section class="section" id="mypage">
            <form id="mypageForm"
            class="mypage-card"
            th:object="${myPage}"
            th:action="@{/mypage}"
            method="post">

            <h3 class="mypage-title">마이페이지</h3>

            <div class="form-row">
                <div class="field">
                    <label class="field-label" for="userId">사용자 ID</label>
                    <input type="text"
                           id="userId"
                           class="text-field"
                           th:field="*{userId}"
                           readonly>
                </div>

                <div class="field">
                    <label class="field-label" for="userName">성명</label>
                    <input type="text"
                           id="userName"
                           class="text-field"
                           th:field="*{userName}">
                </div>
            </div>

            <!-- 2. 비밀번호 / 사용구분 -->
            <div class="form-row">
                <div class="field">
                    <span class="field-label">비밀번호</span>
                    <div class="input-inline">
                        <input type="password"
                               class="text-field"
                               value="********"
                               readonly>
                        <button type="button"
                                class="btn btn-dark-line btn-small"
                                id="btn-change-password">
                            비밀번호 변경
                        </button>
                    </div>
                    <p class="inline-hint">보안을 위해 실제 비밀번호는 표시하지 않습니다.</p>
                </div>

                <div class="field">
                    <span class="field-label">사용구분</span>
                    <input type="text"
                           id="userType"
                           class="text-field"
                           th:value="*{userType}"
                           readonly>
                </div>
            </div>

            <!-- 3. 이메일 -->
            <div class="form-row">
                <div class="field field-full">
                    <span class="field-label">이메일</span>
                    <div class="input-inline">
                        <input type="text"
                               id="emailId"
                        class="text-field email-id"
                        th:field="*{emailId}">
                        <span>@</span>
                        <input type="text"
                               id="emailDomain"
                        class="text-field email-domain"
                        th:field="*{emailDomain}">
                    </div>
                </div>
            </div>

            <!-- 4. 전화 / 휴대전화 -->
            <div class="form-row row-contact">
                <div class="field">
                    <span class="field-label">전화번호</span>
                    <div class="input-inline compact">
                        <input type="text"
                               id="tel1"
                        class="text-field tel-part"
                        maxlength="3"
                        th:field="*{tel1}">
                        <span>-</span>
                        <input type="text"
                               id="tel2"
                        class="text-field tel-part"
                        maxlength="4"
                        th:field="*{tel2}">
                        <span>-</span>
                        <input type="text"
                               id="tel3"
                        class="text-field tel-part"
                        maxlength="4"
                        th:field="*{tel3}">
                    </div>
                </div>

                <div class="field">
                    <span class="field-label">휴대전화번호</span>
                    <div class="input-inline compact">
                        <input type="text"
                               id="mobile1"
                        class="text-field tel-part"
                        maxlength="3"
                        th:field="*{mobile1}">
                        <span>-</span>
                        <input type="text"
                               id="mobile2"
                        class="text-field tel-part"
                        maxlength="4"
                        th:field="*{mobile2}">
                        <span>-</span>
                        <input type="text"
                               id="mobile3"
                        class="text-field tel-part"
                        maxlength="4"
                        th:field="*{mobile3}">
                    </div>
                </div>
            </div>

            <!-- 버튼 영역 -->
            <div class="btn-wrap">
                <button type="submit"
                        class="btn btn-primary btn-icon-left">
                    저장
                    <i class="icon icon-save"></i>
                </button>

                <button type="button"
                        class="btn btn-dark-line"
                        onclick="history.back();">
                    취소
                </button>
            </div>
            </form>
        </section>

        <!-- ===== 비밀번호 변경 모달 ===== -->
        <dialog id="pw-modal"
                class="pw-modal"
                aria-labelledby="pw-title"
                aria-modal="true">
            <form id="pwForm" method="dialog" onsubmit="return false;">
                <h3 id="pw-title" class="pw-head">비밀번호 변경</h3>
                <p class="pw-muted">현재 비밀번호와 새 비밀번호를 입력해 주세요.</p>

                <div class="pw-group">
                    <label class="pw-label" for="currentPassword">현재 비밀번호</label>
                    <input id="currentPassword"
                           class="text-field pw-input"
                           type="password"
                           autocomplete="off">
                </div>

                <div class="pw-group">
                    <label class="pw-label" for="newPassword">새 비밀번호</label>
                    <input id="newPassword"
                           class="text-field pw-input"
                           type="password"
                           autocomplete="off">
                </div>

                <div class="pw-group">
                    <label class="pw-label" for="newPasswordConfirm">새 비밀번호 확인</label>
                    <input id="newPasswordConfirm"
                           class="text-field pw-input"
                           type="password"
                           autocomplete="off">
                </div>

                <div id="pw-msg" class="pw-msg" role="alert"></div>

                <div class="pw-actions">
                    <button type="button"
                            id="pw-cancel"
                            class="btn btn-dark-line">취소</button>
                    <button type="button"
                            id="pw-save"
                            class="btn btn-primary">저장</button>
                </div>
            </form>
        </dialog>

        <!-- 공통 푸터 -->
        <th:block th:replace="~{component/commonFooter :: commonFooter}"></th:block>

        <!-- ===== 마이페이지 전용 스크립트 ===== -->
        <script th:inline="javascript" type="text/javascript">
            document.addEventListener('DOMContentLoaded', function () {
                const dlg        = document.getElementById('pw-modal');
                const pwForm     = document.getElementById('pwForm');
                const btnOpen    = document.getElementById('btn-change-password'); // 메인 화면 버튼
                const btnSave    = document.getElementById('pw-save');
                const btnCancel  = document.getElementById('pw-cancel');
                const msgEl      = document.getElementById('pw-msg');
                const currEl     = document.getElementById('currentPassword');
                const nextEl     = document.getElementById('newPassword');
                const confirmEl  = document.getElementById('newPasswordConfirm');

                const form       = document.getElementById('mypageForm');
                const userNameEl = document.getElementById('userName');
                const emailIdEl  = document.getElementById('emailId');
                const emailDomEl = document.getElementById('emailDomain');
                const mobile1El  = document.getElementById('mobile1');
                const mobile2El  = document.getElementById('mobile2');
                const mobile3El  = document.getElementById('mobile3');
                const tel1El     = document.getElementById('tel1');
                const tel2El     = document.getElementById('tel2');
                const tel3El     = document.getElementById('tel3');

                if (!dlg || !btnOpen) return;

                const sendSafe  = window.Common && window.Common.sendSafe;
                const modalShow = window.Common && window.Common.modalShow;

                function openPwModal() {
                    msgEl.textContent = '';
                    pwForm.reset();
                    if (dlg.showModal) {
                        dlg.showModal();
                    } else {
                        dlg.setAttribute('open', 'open');
                    }
                    setTimeout(function () { currEl.focus(); }, 10);
                }

                function closePwModal() {
                    if (dlg.close) {
                        dlg.close();
                    } else {
                        dlg.removeAttribute('open');
                    }
                }

                async function savePassword() {
                    const curr  = (currEl.value || '').trim();
                    const next  = (nextEl.value || '').trim();
                    const next2 = (confirmEl.value || '').trim();

                    if (!curr || !next || !next2) {
                        msgEl.textContent = '모든 비밀번호를 입력해 주세요.';
                        (!curr ? currEl : !next ? nextEl : confirmEl).focus();
                        return;
                    }
                    if (next !== next2) {
                        msgEl.textContent = '새 비밀번호가 서로 일치하지 않습니다.';
                        confirmEl.focus();
                        return;
                    }

                    if (typeof sendSafe !== 'function') {
                        alert('Common.sendSafe 가 정의되어 있지 않습니다.');
                        return;
                    }

                    const res = await sendSafe('/mypage/password', {
                        method: 'POST',
                        data: {
                            currentPassword: curr,
                            newPassword: next
                        },
                        clientErrorMsg: '비밀번호 변경에 실패했습니다.',
                        otherErrorMsg: '비밀번호 변경 처리 중 오류가 발생했습니다.'
                    });

                    if (!res) return;

                    if (res.ok) {
                        if (typeof modalShow === 'function') {
                            modalShow({
                                message: '비밀번호가 변경되었습니다.',
                                buttons: 'close',
                                onClose: function () {
                                    closePwModal();
                                }
                            });
                        } else {
                            alert('비밀번호가 변경되었습니다.');
                            closePwModal();
                        }
                    }
                    // 에러 케이스는 sendSafe + modalShow 에서 이미 안내함
                }


                function bindAutoJump(fromEl, toEl, maxLen) {
                    if (!fromEl || !toEl) return;
                    fromEl.addEventListener('input', function () {
                        const val = fromEl.value || '';
                        // 숫자만 허용 (필요 없으면 이 줄 제거 가능)
                        fromEl.value = val.replace(/[^0-9]/g, '');

                        if (fromEl.value.length >= maxLen) {
                            toEl.focus();
                        }
                    });
                }

                bindAutoJump(tel1El,    tel2El,    3);
                bindAutoJump(tel2El,    tel3El,    4);
                bindAutoJump(mobile1El, mobile2El, 3);
                bindAutoJump(mobile2El, mobile3El, 4);

                if (form) {
                    form.addEventListener('submit', function (e) {
                        // 서버까지 보내기 전에 1차 프론트 검증
                        const errors = [];

                        const userName = (userNameEl && userNameEl.value || '').trim();
                        const emailId  = (emailIdEl  && emailIdEl.value  || '').trim();
                        const emailDom = (emailDomEl && emailDomEl.value || '').trim();
                        const m1       = (mobile1El  && mobile1El.value  || '').trim();
                        const m2       = (mobile2El  && mobile2El.value  || '').trim();
                        const m3       = (mobile3El  && mobile3El.value  || '').trim();

                        if (!userName) {
                            errors.push('성명을 입력해 주세요.');
                        }

                        // 이메일은 둘 다 채워져 있거나, 둘 다 비어있거나
                        if ((emailId && !emailDom) || (!emailId && emailDom)) {
                            errors.push('이메일은 아이디와 도메인을 모두 입력해 주세요.');
                        }

                        // 휴대전화는 3칸 다 채워져 있어야 한다고 가정
                        const mobileFilled = m1 || m2 || m3;
                        if (mobileFilled && (!m1 || !m2 || !m3)) {
                            errors.push('휴대전화번호는 앞/가운데/끝 번호를 모두 입력해 주세요.');
                        }

                        if (errors.length > 0) {
                            e.preventDefault();
                            if (typeof modalShow === 'function') {
                                modalShow({
                                    message: errors.join('\n'),
                                    buttons: 'close'
                                });
                            } else {
                                alert(errors.join('\n'));
                            }
                        }
                        // 에러 없으면 그대로 submit 진행 (preventDefault 안 함)
                    });
                }

                // 열기 / 닫기 / 저장 이벤트 바인딩 (비밀번호 모달)
                btnOpen.addEventListener('click', function (e) {
                    e.preventDefault();
                    openPwModal();
                });

                btnCancel && btnCancel.addEventListener('click', function (e) {
                    e.preventDefault();
                    closePwModal();
                });

                dlg.addEventListener('cancel', function (e) {
                    e.preventDefault();
                    closePwModal();
                });

                btnSave.addEventListener('click', function (e) {
                    e.preventDefault();
                    savePassword();
                });

                pwForm.addEventListener('submit', function (e) {
                    e.preventDefault();
                    savePassword();
                });
            });
        </script>

    </th:block>
</th:block>

</html>

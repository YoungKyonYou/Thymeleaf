<!doctype html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8" />
    <title>Pager Fragment</title>
</head>
<body>

<th:block th:fragment="pager(pageData)">

    <div class="mt20">
        <div class="pagination" role="navigation" aria-label="목록 페이지 이동">

            <button type="button"
                    class="pager-btn prev"
                    aria-label="이전 페이지"
                    th:classappend="${pageData == null || !pageData.hasPrev} ? ' disabled'"
                    th:attr="data-page=${pageData != null ? pageData.page : 1}">
                Prev
            </button>

            <th:block th:if="${pageData != null}"
                      th:with="
                      current = ${pageData.page},
                      totalPages = ${pageData.getTotalPages()},
                      totalPagesInt = ${T(java.lang.Math).toIntExact(totalPages)},
                      blockIdx = ${current / 10},
                      blockStart = ${blockIdx * 10},
                      blockEnd = ${T(java.lang.Math).min(blockStart + 9, totalPagesInt - 1)}">

                <button type="button"
                        class="pager-item"
                        th:each="i : ${#numbers.sequence(blockStart, blockEnd)}"
                        th:classappend="${i == pageData.page} ? ' is-active'"
                        th:attr="data-page=${i}"
                        th:aria-current="${i == pageData.page} ? 'page' : null"
                        th:text="${i + 1}">
                    1
                </button>
            </th:block>

            <!-- Next -->
            <button type="button"
                    class="pager-btn next"
                    aria-label="다음 페이지"
                    th:classappend="${pageData == null || !pageData.hasNext} ? ' disabled'"
                    th:attr="data-page=${pageData != null ? pageData.page + 1 : 1}">
                Next
            </button>

        </div>
    </div>
<!--    bindPagination('/users', { dir: 'asc',email: 'kim@test.com', username: 'young' });
        page, size 생략 가능 (이미 서버에 디폴트가 있음)
        나머지 파라미터도 검색이 없다면 생략 가능
-->
    <script>
        function putParam(params, key, value) {
            if (value === null || value === undefined || value === '') return;
            if (Array.isArray(value)) value.forEach(v => putParam(params, key, v));
            else params.set(key, value);
        }

        function bindPagination(url, ...args) {
            const baseUrl = new URL(url, window.location.origin);
            const baseArgs = Object.assign({}, ...args);

            document.addEventListener('click', function (e) {
                const btn = e.target.closest('.pagination [data-page]');
                if (!btn) return;
                if (btn.classList.contains('disabled')) return;

                const page = Number(btn.dataset.page)+1 || 1;


                const u = new URL(baseUrl.toString());
                const p = new URLSearchParams(u.search);

                const size = baseArgs.size ?? null;
                const dir  = baseArgs.dir  ?? 'asc';
                const sort = baseArgs.sort ?? null;

                putParam(p, 'size', size);
                putParam(p, 'page', page);
                putParam(p, 'dir',  dir);
                if (sort !== null && sort !== undefined && sort !== '') putParam(p, 'sort', sort);

                const skip = new Set(['size','page','dir','sort']);
                Object.entries(baseArgs).forEach(([k,v]) => { if (!skip.has(k)) putParam(p, k, v); });

                u.search = p.toString();
                window.location.assign(u.toString()); // GET 이동
            });
        }
    </script>
</th:block>

</body>
</html>
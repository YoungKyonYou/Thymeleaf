<!doctype html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8" />
    <title>Pager Fragment</title>
</head>
<body>

<th:block th:fragment="pager(pageData)">

    <div class="mt20">
        <div class="pagination" role="navigation" aria-label="목록 페이지 이동">

            <!-- Prev: data-page = 현재(0-base) - 1 -->
            <button type="button"
                    class="pager-btn prev"
                    aria-label="이전 페이지"
                    th:classappend="${pageData == null || !pageData.hasPrev} ? ' disabled'"
                    th:attr="data-page=${pageData != null ? pageData.page - 1 : 0}">
                Prev
            </button>

            <!-- 숫자 버튼: data-page = 0-base(i), 표시 = i+1, 활성 비교 = pageData.page(0-base) -->
            <th:block th:if="${pageData != null}"
                      th:with="
                        current = ${pageData.page},
                        totalPages = ${pageData.getTotalPages()},
                        totalPagesInt = ${T(java.lang.Math).toIntExact(totalPages)},
                        blockIdx = ${current / 10},
                        blockStart = ${blockIdx * 10},
                        blockEnd = ${T(java.lang.Math).min(blockStart + 9, totalPagesInt - 1)}">

                <button type="button"
                        class="pager-item"
                        th:each="i : ${#numbers.sequence(blockStart, blockEnd)}"
                        th:classappend="${i == pageData.page} ? ' is-active'"
                        th:attr="data-page=${i}"
                        th:aria-current="${i == pageData.page} ? 'page' : null"
                        th:text="${i + 1}">
                    1
                </button>
            </th:block>

            <!-- Next: data-page = 현재(0-base) + 1 -->
            <button type="button"
                    class="pager-btn next"
                    aria-label="다음 페이지"
                    th:classappend="${pageData == null || !pageData.hasNext} ? ' disabled'"
                    th:attr="data-page=${pageData != null ? pageData.page + 1 : 0}">
                Next
            </button>

        </div>
    </div>

    <!-- 사용 예: bindPagination('/user', { dir: 'asc', email: 'kim@test.com', username: 'young' }) -->
    <script>
        function putParam(params, key, value) {
            if (value === null || value === undefined || value === '') return;
            if (Array.isArray(value)) value.forEach(v => putParam(params, key, v));
            else params.set(key, value);
        }

        async function fetchAndSwap(u) {
            const res = await fetch(u.toString(), { headers: { 'X-Requested-With': 'fetch' } });
            if (!res.ok) throw new Error(`HTTP ${res.status}`);
            const html = await res.text();

            const doc = new DOMParser().parseFromString(html, 'text/html');
            const newTbody = doc.querySelector('#grid-tbody');
            const newPager = doc.querySelector('#pager');

            const curTbody = document.querySelector('#grid-tbody');
            const curPager = document.querySelector('#pager');

            if (newTbody && curTbody) curTbody.replaceWith(newTbody);
            if (newPager && curPager) curPager.innerHTML = newPager.innerHTML;

            // 주소창만 갱신 (전체 새로고침 X)
            history.pushState(null, '', u.toString());
        }

        function bindPagination(url, ...args) {
            const baseUrl  = new URL(url, window.location.origin);
            const baseArgs = Object.assign({}, ...args);

            // 브라우저 뒤로/앞으로 가기 지원
            window.addEventListener('popstate', () => {
                fetchAndSwap(new URL(window.location.href)).catch(console.error);
            });

            document.addEventListener('click', function (e) {
                const btn = e.target.closest('.pagination [data-page]');
                if (!btn) return;
                if (btn.classList.contains('disabled')) return;

                e.preventDefault(); // 혹시 모를 기본동작 차단

                const page = Number(btn.dataset.page);

                const u = new URL(baseUrl.toString());
                const p = new URLSearchParams(u.search);

                const size = baseArgs.size ?? null;   // null이면 생략
                const dir  = baseArgs.dir  ?? 'asc';
                const sort = baseArgs.sort ?? null;   // null/''이면 생략

                putParam(p, 'size', size);
                putParam(p, 'page', page); // 0-base 그대로
                putParam(p, 'dir',  dir);
                if (sort !== null && sort !== undefined && sort !== '') putParam(p, 'sort', sort);

                const skip = new Set(['size','page','dir','sort']);
                Object.entries(baseArgs).forEach(([k,v]) => { if (!skip.has(k)) putParam(p, k, v); });

                u.search = p.toString();


                fetchAndSwap(u).catch(console.error);
            });
        }
    </script>
</th:block>

</body>
</html>

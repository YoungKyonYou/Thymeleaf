<!doctype html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8" />
    <title>Pager Fragment</title>
</head>
<body>

<th:block th:fragment="pager(pageData)">

    <div class="mt20">
        <div class="pagination" role="navigation" aria-label="목록 페이지 이동">

            <button type="button"
                    class="pager-btn prev"
                    aria-label="이전 페이지"
                    th:classappend="${(pageData == null) or !pageData.hasPrev} ? ' disabled'"
                    th:attr="data-page=${pageData != null ? pageData.page - 1 : 0}">
                Prev
            </button>

            <th:block th:if="${pageData != null and pageData.total > 0}"
                      th:with="
                  current=${pageData.page},
                  totalPages=${pageData.getTotalPages()},
                  totalPagesInt=${T(java.lang.Math).toIntExact(totalPages)},
                  blockIdx=${current / 10},
                  blockStart=${blockIdx * 10},
                  blockEnd=${T(java.lang.Math).min(blockStart + 9, totalPagesInt - 1)}
                ">

                <button type="button"
                        class="pager-item"
                        th:each="i : ${#numbers.sequence(blockStart, blockEnd)}"
                        th:classappend="${i == pageData.page} ? ' is-active'"
                        th:attr="data-page=${i}"
                        th:aria-current="${i == pageData.page} ? 'page' : null"
                        th:text="${i + 1}">
                </button>
            </th:block>

            <button type="button"
                    class="pager-btn next"
                    aria-label="다음 페이지"
                    th:classappend="${(pageData == null) or !pageData.hasNext} ? ' disabled'"
                    th:attr="data-page=${pageData != null ? pageData.page + 1 : 0}">
                Next
            </button>

        </div>
    </div>

    <script>
        function putParam(params, key, value) {
            if (value === null || value === undefined || value === '') return;
            if (Array.isArray(value)) value.forEach(v => putParam(params, key, v));
            else params.set(key, value);
        }

        function detectSearchForm() {
            return document.querySelector('form.section-header')
                || document.querySelector('form[data-search-form]')
                || document.querySelector('form#searchForm')
                || document.querySelector('form');
        }

        function collectSearchParams(form) {
            if (!form) return {};

            try {
                if (window.Common && typeof Common.collectFromForm === 'function') {
                    return Common.collectFromForm(form) || {};
                }
            } catch (e) {}

            const obj = {};
            try {
                const fd = new FormData(form);
                fd.forEach((v, k) => {
                    if (obj[k] === undefined) obj[k] = v;
                    else if (Array.isArray(obj[k])) obj[k].push(v);
                    else obj[k] = [obj[k], v];
                });
            } catch (e) {}
            return obj;
        }

        async function fetchAndSwap(u, selectors) {
            const defaultSwaps = [
                { selector: '#grid-header', mode: 'replace' },
                { selector: '#grid-tbody',  mode: 'replace' },
                { selector: '#grid-pager',  mode: 'inner'   },
                { selector: '#grid-title',  mode: 'replace' },
                { selector: '#grid-head',   mode: 'replace' },
            ];

            const swaps = (Array.isArray(selectors) && selectors.length > 0)
                ? selectors.map(sel => ({ selector: sel, mode: 'replace' }))
                : defaultSwaps;

            const res = await fetch(u.toString(), { headers: { 'X-Requested-With': 'fetch' } });
            if (!res.ok) throw new Error(`HTTP ${res.status}`);
            const html = await res.text();

            const doc = new DOMParser().parseFromString(html, 'text/html');

            for (const cfg of swaps) {
                const sel  = cfg.selector;
                const mode = cfg.mode || 'replace';

                if (!sel) continue;

                const newEl = doc.querySelector(sel);
                const curEl = document.querySelector(sel);

                if (!newEl || !curEl) continue;

                if (mode === 'inner') curEl.innerHTML = newEl.innerHTML;
                else curEl.replaceWith(newEl);
            }

            history.pushState(null, '', u.toString());
        }

        /**
         * bindPagination(url, baseArgs, selectors?)
         * - 기존 호출 유지
         * - 클릭 시 현재 화면 검색 form을 자동 수집해서 page 이동에도 반영
         */
        function bindPagination(url, baseArgs, selectors) {
            const baseUrl = new URL(url, window.location.origin);
            const args    = Object.assign({}, baseArgs || {});
            const form    = detectSearchForm();

            window.addEventListener('popstate', () => {
                fetchAndSwap(new URL(window.location.href), selectors).catch(console.error);
            });

            document.addEventListener('click', function (e) {
                const btn = e.target.closest('.pagination [data-page]');
                if (!btn) return;
                if (btn.classList.contains('disabled')) return;

                e.preventDefault();

                const page = Number(btn.dataset.page);

                const u = new URL(baseUrl.toString());
                const p = new URLSearchParams();

                const applied = collectSearchParams(form);

                const size = args.size ?? applied.size ?? null;
                const dir  = args.dir  ?? applied.dir  ?? 'asc';
                const sort = args.sort ?? applied.sort ?? null;

                putParam(p, 'size', size);
                putParam(p, 'page', page);
                putParam(p, 'dir',  dir);
                if (sort !== null && sort !== undefined && sort !== '') {
                    putParam(p, 'sort', sort);
                }

                const skip = new Set(['size','page','dir','sort']);

                Object.entries(applied || {}).forEach(([k, v]) => {
                    if (!skip.has(k)) putParam(p, k, v);
                });

                Object.entries(args).forEach(([k, v]) => {
                    if (!skip.has(k) && applied?.[k] === undefined) {
                        putParam(p, k, v);
                    }
                });

                u.search = p.toString();

                fetchAndSwap(u, selectors).catch(console.error);
            });
        }
    </script>
</th:block>

</body>
</html>

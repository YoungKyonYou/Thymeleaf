<!doctype html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8" />
    <title>Pager Fragment</title>
</head>
<body>

<th:block th:fragment="pager(pageData)">

    <div class="mt20">
        <div class="pagination" role="navigation" aria-label="목록 페이지 이동">

            <!-- Prev: data-page = 현재(0-base) - 1 -->
            <button type="button"
                    class="pager-btn prev"
                    aria-label="이전 페이지"
                    th:classappend="${(pageData == null) or !pageData.hasPrev} ? ' disabled'"
                    th:attr="data-page=${pageData != null ? pageData.page - 1 : 0}">
                Prev
            </button>

            <!-- 숫자 버튼: data-page = 0-base(i), 표시는 i+1, 활성 비교 = pageData.page(0-base) -->
            <th:block th:if="${pageData != null and pageData.total > 0}"
                      th:with="
                  current=${pageData.page},
                  totalPages=${pageData.getTotalPages()},
                  totalPagesInt=${T(java.lang.Math).toIntExact(totalPages)},
                  blockIdx=${current / 10},
                  blockStart=${blockIdx * 10},
                  blockEnd=${T(java.lang.Math).min(blockStart + 9, totalPagesInt - 1)}
                ">

                <button type="button"
                        class="pager-item"
                        th:each="i : ${#numbers.sequence(blockStart, blockEnd)}"
                        th:classappend="${i == pageData.page} ? ' is-active'"
                        th:attr="data-page=${i}"
                        th:aria-current="${i == pageData.page} ? 'page' : null"
                        th:text="${i + 1}">
                </button>
            </th:block>

            <!-- Next: data-page = 현재(0-base) + 1 -->
            <button type="button"
                    class="pager-btn next"
                    aria-label="다음 페이지"
                    th:classappend="${(pageData == null) or !pageData.hasNext} ? ' disabled'"
                    th:attr="data-page=${pageData != null ? pageData.page + 1 : 0}">
                Next
            </button>

        </div>
    </div>

    <!-- 사용 예: bindPagination('/user', { dir: 'asc', email: 'kim@test.com', username: 'young' }) -->
    <script>
        (function () {
          'use strict';

          // ===== 공통 유틸 =====
          function putParam(params, key, value) {
            if (value === null || value === undefined || value === '') return;
            if (Array.isArray(value)) value.forEach(v => putParam(params, key, v));
            else params.set(key, value);
          }

          async function fetchAndSwap(u) {
            const res = await fetch(u.toString(), { headers: { 'X-Requested-With': 'fetch' } });
            if (!res.ok) throw new Error(`HTTP ${res.status}`);
            const html = await res.text();

            const doc = new DOMParser().parseFromString(html, 'text/html');

            const newHead  = doc.querySelector('#grid-header');
            const newTbody = doc.querySelector('#grid-tbody');
            const newPager = doc.querySelector('#grid-pager');
            const newTitle = doc.querySelector('#grid-title');
            const newTHead = doc.querySelector('#grid-head');

            const curHead  = document.querySelector('#grid-header');
            const curTbody = document.querySelector('#grid-tbody');
            const curPager = document.querySelector('#grid-pager');
            const curTitle = document.querySelector('#grid-title');
            const curTHead = document.querySelector('#grid-head');

            if (newTbody && curTbody) curTbody.replaceWith(newTbody);
            if (newPager && curPager) curPager.innerHTML = newPager.innerHTML;
            if (newHead  && curHead)  curHead.replaceWith(newHead);
            if (newTitle && curTitle) curTitle.replaceWith(newTitle);
            if (newTHead && curTHead) curTHead.replaceWith(newTHead);

            // 주소창만 갱신 (전체 새로고침 X)
            history.pushState(null, '', u.toString());
          }

          // ===== 전역 상태: 여러 번 bindPagination 호출해도 리스너는 1세트만 =====
          const state = window.__PAGER_STATE__ || (window.__PAGER_STATE__ = {
            baseUrl:  null,
            baseArgs: {}
          });

          // popstate / click 핸들러 정의 (state만 참조)
          function handlePopState() {
            // 뒤로가기/앞으로가기 → 현재 URL로 다시 grid만 갱신
            fetchAndSwap(new URL(window.location.href)).catch(console.error);
          }

          function handleClick(e) {
            const btn = e.target.closest('.pagination [data-page]');
            if (!btn) return;

            if (btn.classList.contains('disabled')) return;
            e.preventDefault();

            // 아직 설정이 안 되어 있으면 아무 것도 안 함
            if (!state.baseUrl) return;

            const page = Number(btn.dataset.page);

            const u = new URL(state.baseUrl.toString());
            const p = new URLSearchParams(u.search);

            const size = state.baseArgs.size ?? null;
            const dir  = state.baseArgs.dir  ?? 'asc';
            const sort = state.baseArgs.sort ?? null;

            putParam(p, 'size', size);
            putParam(p, 'page', page);
            putParam(p, 'dir',  dir);
            if (sort !== null && sort !== undefined && sort !== '') {
              putParam(p, 'sort', sort);
            }

            const skip = new Set(['size','page','dir','sort']);
            Object.entries(state.baseArgs).forEach(([k, v]) => {
              if (!skip.has(k)) putParam(p, k, v);
            });

            u.search = p.toString();

            fetchAndSwap(u).catch(console.error);
          }

          // 전역 리스너는 한 번만 등록
          if (!window.__PAGER_BOUND__) {
            window.__PAGER_BOUND__ = true;
            window.addEventListener('popstate', handlePopState);
            document.addEventListener('click', handleClick);
          }

          // 외부에서 호출하는 API: 단순히 state만 갱신
          window.bindPagination = function (url, ...args) {
            state.baseUrl  = new URL(url, window.location.origin);
            state.baseArgs = Object.assign({}, ...args);
          };
        })();
    </script>
</th:block>

</body>
</html>

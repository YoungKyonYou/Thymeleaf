<!-- /templates/fragments/dropdowns.html -->
<th:block th:fragment="cascadingDropdown(rootId, deptName, subName, mngrId)">
    <div class="cascading-dropdowns"
         th:attr="id=${rootId},
                data-parent-name=${deptName},
                data-child-name=${subName},
                data-mngr-id=${mngrId},
                data-api-url=@{/api/services}"
         style="display:flex; gap:16px; align-items:flex-start;">

        <!-- 1차: 서비스 -->
        <div class="dropdown" th:attr="data-name=${deptName}" style="width:240px">
            <button type="button" class="dropdown_button" aria-haspopup="listbox" aria-expanded="false"
                    aria-label="서비스 선택 드롭다운">
                <span class="dropdown_value" data-placeholder="서비스 선택">서비스 선택</span>
            </button>
            <ul class="dropdown_list" role="listbox" tabindex="-1"><!-- JS 채움 --></ul>
            <input type="hidden" th:attr="name=${deptName}" value="">
        </div>

        <!-- 2차: 서비스 유형 -->
        <div class="dropdown" th:attr="data-name=${subName}, data-parent=${deptName}" style="width:240px">
            <button type="button" class="dropdown_button" aria-haspopup="listbox" aria-expanded="false"
                    aria-label="서비스 유형 선택 드롭다운" disabled aria-disabled="true">
                <span class="dropdown_value" data-placeholder="먼저 서비스를 선택">먼저 서비스를 선택</span>
            </button>
            <ul class="dropdown_list" role="listbox" tabindex="-1"><!-- JS 채움 --></ul>
            <input type="hidden" th:attr="name=${subName}" value="">
        </div>
    </div>

    <!-- rootId를 JS로 안전 주입 -->
    <script th:inline="javascript">
        (function(){
            // static/js/http.js

// ────────────────────────────────────────────────────────────────
// Low-level fetch wrapper
// ────────────────────────────────────────────────────────────────
            async function send(url, {
                method = 'POST',
                data = null,
                headers = {},
                signal,
                expect = 'json', // 'json' | 'text'
            } = {}) {

                const init = {
                    method,
                    // 가능한 application/json을 주고 text/plain 그리고 그 외 아무거나
                    headers: { 'Accept': 'application/json, text/plain;q=0.9', ...headers },
                    cache: 'no-store',
                    credential: 'same-origin', // (스크린샷 그대로 반영)
                    signal,
                };

                if (data != null) {
                    if (data instanceof FormData) {
                        init.body = data; // Content-Type 자동
                    } else if (data instanceof URLSearchParams) {
                        init.headers['Content-Type'] = 'application/x-www-form-urlencoded;charset=UTF-8;';
                        init.body = data.toString();
                    } else if (headers['Content-Type'] === 'application/x-www-form-urlencoded;charset=UTF-8;') {
                        init.body = new URLSearchParams(data).toString();
                    } else {
                        init.headers['Content-Type'] = 'application/json;charset=UTF-8;';
                        init.body = JSON.stringify(data);
                    }
                }

                // show(); // (로딩 UI 쓰면 여기)

                const res  = await fetch(url, init);
                const ct   = res.headers.get('content-type') || '';
                const text = await res.text();

                if (!res.ok) {
                    let payload = null;
                    if (ct.includes('application/json')) {
                        try { payload = JSON.parse(text); } catch {}
                    }
                    const err = new Error((payload && payload.message) ? payload.message : `HTTP ${res.status}`);
                    err.name        = 'FetchJsonError';
                    err.status      = res.status;
                    err.payload     = payload;
                    err.body        = text;
                    err.contentType = ct;
                    throw err;
                }

                if (expect === 'text' || !ct.includes('application/json')) {
                    try { return JSON.parse(text); } catch { return text; }
                }
                try {
                    return JSON.parse(text);
                } catch {
                    return text;
                }
            }


// ────────────────────────────────────────────────────────────────
            /** High-level safe wrapper with UX handling */
            async function sendSafe(
                url,
                {
                    method = 'POST',
                    data = null,
                    signal,
                    headers,
                    expect = 'json',
                    clientErrorMsg = '요청을 처리할 수 없습니다',
                    otherErrorMsg  = '요청에 실패했습니다.',
                } = {}
            ) {
                try {
                    const out = await send(url, { method, data, headers, signal, expect });
                    return { ok: true, data: out };
                } catch (e) {
                    if (e.name === 'AbortError') {
                        return { ok: false, aborted: true, error: e };
                    }

                    if ([400, 409, 422].includes(e.status)) {
                        const msg = (e.payload && e.payload.message) ? e.payload.message : clientErrorMsg;
                        alert(msg);
                        return { ok: false, status: e.status, error: e };
                    }

                    alert(otherErrorMsg);
                    console.error(e);
                    return { ok: false, status: e.status, error: e };
                } finally {
                    // hide();
                }
            }


            var rootId = /*[[${rootId}]]*/ 'root';
            var root   = document.getElementById(rootId);
            if (!root) return;

            var parentName = root.getAttribute('data-parent-name');
            var childName  = root.getAttribute('data-child-name');
            var mngrId     = root.getAttribute('data-mngr-id') || '';
            var apiUrl     = root.getAttribute('data-api-url'); // /api/services

            // 메모리 캐시: { svcId: [{tpwSvcTypId, tpwSvcTypNm}, ...] }
            var TYPES_BY_SVC = {};

            function parts(dd){ return {
                btn: dd.querySelector('.dropdown_button'),
                valueEl: dd.querySelector('.dropdown_value'),
                list: dd.querySelector('.dropdown_list'),
                hidden: dd.querySelector('input[type="hidden"]')
            };}

            function openDropdown(dd){ var p=parts(dd); p.btn.setAttribute('aria-expanded','true'); p.list.style.display='block'; p.list.focus(); }
            function closeDropdown(dd){ var p=parts(dd); p.btn.setAttribute('aria-expanded','false'); p.list.style.display='none'; }
            function toggleDropdown(dd){ var p=parts(dd); (p.btn.getAttribute('aria-expanded')==='true') ? closeDropdown(dd) : openDropdown(dd); }

            function setLoading(listEl, msg){ listEl.innerHTML = '<li class="dropdown_option" aria-disabled="true">'+(msg||'로딩 중...')+'</li>'; }
            function setError(listEl, msg){ listEl.innerHTML   = '<li class="dropdown_option" aria-disabled="true">'+(msg||'불러오기에 실패했습니다')+'</li>'; }
            function fillOptions(listEl, items, valueKey, labelKey){
                listEl.innerHTML = (items||[]).map(function(it){
                    return '<li role="option" class="dropdown_option" data-value="'+it[valueKey]+'">'+it[labelKey]+'</li>';
                }).join('');
            }
            function resetChild(child){
                var p=parts(child);
                p.list.innerHTML=''; p.hidden.value='';
                p.btn.disabled=true; p.btn.setAttribute('aria-disabled','true');
                p.valueEl.textContent=p.valueEl.getAttribute('data-placeholder')||'선택하세요';
                closeDropdown(child);
            }

            function selectOption(dd, li){
                var p=parts(dd), value=li.getAttribute('data-value'), label=li.textContent.trim();
                p.list.querySelectorAll('.dropdown_option[aria-selected="true"]').forEach(function(el){ el.setAttribute('aria-selected','false'); });
                li.setAttribute('aria-selected','true');
                p.valueEl.textContent = label;
                p.hidden.value = value;
                closeDropdown(dd);

                if (dd.getAttribute('data-name') === parentName) {
                    var childDD = root.querySelector('.dropdown[data-name="'+childName+'"]');
                    var c = parts(childDD);
                    var items = TYPES_BY_SVC[value] || [];
                    if (!items.length) { resetChild(childDD); return; }
                    c.btn.disabled = false; c.btn.setAttribute('aria-disabled','false');
                    c.valueEl.textContent = c.valueEl.getAttribute('data-placeholder') || '선택하세요';
                    fillOptions(c.list, items, 'tpwSvcTypId', 'tpwSvcTypNm');
                }
            }

            function bindDropdown(dd){
                var p=parts(dd);
                p.btn && p.btn.addEventListener('click', function(e){ e.stopPropagation(); if(!p.btn.disabled) toggleDropdown(dd); });
                p.list && p.list.addEventListener('click', function(e){
                    var li=e.target.closest('.dropdown_option');
                    if(li && !li.hasAttribute('aria-disabled')) selectOption(dd, li);
                });
                document.addEventListener('click', function(e){ if(!root.contains(e.target)) closeDropdown(dd); });
                dd.addEventListener('keydown', function(e){
                    if(e.key==='Escape') closeDropdown(dd);
                    if((e.key==='Enter'||e.key===' ') && document.activeElement===p.btn){ e.preventDefault(); if(!p.btn.disabled) toggleDropdown(dd); }
                });
            }

            async function loadAll(){
                var parentDD = root.querySelector('.dropdown[data-name="'+parentName+'"]');
                var childDD  = root.querySelector('.dropdown[data-name="'+childName+'"]');
                if (childDD) resetChild(childDD);

                var p = parts(parentDD);
                setLoading(p.list, '서비스 로딩...');

                var url = apiUrl + (mngrId ? ('?mngrId=' + encodeURIComponent(mngrId)) : '');

                // ✅ 공통함수 사용
                const res = await sendSafe(url, { method: 'GET', expect: 'json' });

                if (res.ok) {
                    var payload = res.data || {};
                    TYPES_BY_SVC = payload.typesBySvcId || {};
                    fillOptions(p.list, payload.services || [], 'tpwSvcId', 'svcNm');
                } else {
                    setError(p.list, '서비스를 불러오지 못했습니다');
                }
            }

            // 바인딩 & 초기 로드
            root.querySelectorAll('.dropdown').forEach(bindDropdown);
            loadAll();
        })();
    </script>
</th:block>

<!-- templates/component/dateRange.html -->
<div th:fragment="periodFixed"
     class="flex align-center col-2"
     data-dp="range">

    <!-- 시작일 -->
    <div class="date-field text-field datepicker" style="width:200px">
        <input id="sttDt"
               type="text"
               class="dp-input date-text"
               placeholder="YYYY-MM-DD"
               inputmode="numeric"
               pattern="\d{4}-\d{2}-\d{2}"
               autocomplete="off"
               data-role="start"
               data-dp-group="period-fixed" />
        <button type="button"
                class="ui-datepicker-trigger dp-btn"
                data-dp-toggle
                aria-label="달력 열기"
                aria-haspopup="dialog"
                aria-expanded="false"
                aria-controls="dp-pop"></button>
    </div>

    <span>~</span>

    <!-- 종료일 -->
    <div class="date-field text-field datepicker" style="width:200px">
        <input id="endDt"
               type="text"
               class="dp-input date-text"
               placeholder="YYYY-MM-DD"
               inputmode="numeric"
               pattern="\d{4}-\d{2}-\d{2}"
               autocomplete="off"
               data-role="end"
               data-dp-group="period-fixed" />
        <button type="button"
                class="ui-datepicker-trigger dp-btn"
                data-dp-toggle
                aria-label="달력 열기"
                aria-haspopup="dialog"
                aria-expanded="false"
                aria-controls="dp-pop"></button>
    </div>

    <!-- 이 인스턴스만 초기화 -->
    <script>
        (function () {
          // 중복 초기화 방지
          if (window.__NATIVE_PERIOD_FIXED__) return;
          window.__NATIVE_PERIOD_FIXED__ = true;

          const stt = document.getElementById('sttDt');
          const end = document.getElementById('endDt');
          if (!stt || !end) return;

          // 유틸: YYYY-MM-DD 포맷터
          const pad = n => String(n).padStart(2, '0');
          const fmt = d => `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())}`;
          const parse = (s) => {
            const m = /^(\d{4})-(\d{2})-(\d{2})$/.exec((s||'').trim());
            if (!m) return null;
            const d = new Date(+m[1], +m[2]-1, +m[3]);
            return (d.getFullYear()===+m[1] && d.getMonth()===(+m[2]-1) && d.getDate()===+m[3]) ? d : null;
          };

          // 네이티브 date input을 보이지 않게 하나 만들어 picker만 이용
          function makeHiddenDateInput(forTextInput) {
            const h = document.createElement('input');
            h.type = 'date';
            h.style.position = 'fixed';
            h.style.left = '-9999px';
            h.style.top = '0';
            h.tabIndex = -1;
            document.body.appendChild(h);

            // 텍스트값 ↔ 숨김 date 값 싱크
            const syncHiddenFromText = () => {
              const d = parse(forTextInput.value);
              if (d) h.valueAsDate = d;
              else h.value = ''; // invalid이면 비움
            };
            const syncTextFromHidden = () => {
              if (h.valueAsDate) forTextInput.value = fmt(h.valueAsDate);
            };

            // 아이콘/버튼 클릭 시 실행할 오픈 함수 반환
            const open = () => {
              syncHiddenFromText();
              if (h.showPicker) {
                // 최신 브라우저: showPicker로 즉시 오픈
                h.showPicker();
              } else {
                // 구형: 포커스로 대체
                h.focus();
              }
            };

            h.addEventListener('change', syncTextFromHidden);
            return { open, destroy: () => h.remove() };
          }

          // 공통: blur 시 포맷 정규화
          function normalizeOnBlur(inp) {
            inp.addEventListener('blur', () => {
              const d = parse(inp.value);
              inp.value = d ? fmt(d) : '';
            }, true);
          }

          // 각 필드에 숨김 date input 만들고 아이콘 클릭과 연결
          [stt, end].forEach(inp => {
            normalizeOnBlur(inp);
            const { open } = makeHiddenDateInput(inp);
            const btn = inp.nextElementSibling; // 아이콘 버튼(바로 다음 형제)
            if (btn) btn.addEventListener('click', open);
          });
        })();
    </script>

</div>
